<!DOCTYPE html>
<html lang="" xml:lang="">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>4 Initial parameters for EM algorithm | Creating the flowtrend R package</title>
<meta name="description" content="4 Initial parameters for EM algorithm | Creating the flowtrend R package">
<meta name="generator" content="bookdown 0.35 and GitBook 2.6.7">
<meta property="og:title" content="4 Initial parameters for EM algorithm | Creating the flowtrend R package">
<meta property="og:type" content="book">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="4 Initial parameters for EM algorithm | Creating the flowtrend R package">
<meta name="author" content="Sangwon Hyun, Tim Coleman, Francois Ribalet, Jacob Bien">
<meta name="date" content="2024-05-07">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="prev" href="objective-data-log-likelihood.html">
<link rel="next" href="the-main-flowtrend-function.html">
<script src="libs/header-attrs-2.25/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script><link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet">
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet">
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet">
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet">
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet">
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet">
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet">
<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet">
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet">
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script><style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>
<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
</head>
<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation"><ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="package-setup.html">
<a href="package-setup.html"><i class="fa fa-check"></i><b>2</b> Package setup</a>
<ul>
<li class="chapter" data-level="2.1" data-path="package-setup.html">
<a href="package-setup.html#d-data"><i class="fa fa-check"></i><b>2.1</b> 1d data</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="package-setup.html"><a href="package-setup.html#generating-1d-data"><i class="fa fa-check"></i><b>2.1.1</b> Generating 1d data</a></li>
</ul>
</li>
<li class="chapter" data-level="2.2" data-path="package-setup.html"><a href="package-setup.html#plotting-1d-data"><i class="fa fa-check"></i><b>2.2</b> Plotting 1d data</a></li>
<li class="chapter" data-level="2.3" data-path="package-setup.html">
<a href="package-setup.html#d-data-1"><i class="fa fa-check"></i><b>2.3</b> 2d data</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="package-setup.html"><a href="package-setup.html#generating-2d-data"><i class="fa fa-check"></i><b>2.3.1</b> Generating 2d data</a></li>
<li class="chapter" data-level="2.3.2" data-path="package-setup.html"><a href="package-setup.html#plotting-2d-data"><i class="fa fa-check"></i><b>2.3.2</b> Plotting 2d data</a></li>
</ul>
</li>
<li class="chapter" data-level="2.4" data-path="package-setup.html">
<a href="package-setup.html#d-data-2"><i class="fa fa-check"></i><b>2.4</b> 3d data</a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="package-setup.html"><a href="package-setup.html#plotting-3d-data"><i class="fa fa-check"></i><b>2.4.1</b> Plotting 3d data</a></li>
<li class="chapter" data-level="2.4.2" data-path="package-setup.html"><a href="package-setup.html#generating-3d-data"><i class="fa fa-check"></i><b>2.4.2</b> Generating 3d data</a></li>
</ul>
</li>
<li class="chapter" data-level="2.5" data-path="package-setup.html"><a href="package-setup.html#trend-filtering"><i class="fa fa-check"></i><b>2.5</b> Trend filtering</a></li>
</ul>
</li>
<li class="chapter" data-level="3" data-path="objective-data-log-likelihood.html"><a href="objective-data-log-likelihood.html"><i class="fa fa-check"></i><b>3</b> Objective (data log-likelihood)</a></li>
<li class="chapter" data-level="4" data-path="initial-parameters-for-em-algorithm.html">
<a href="initial-parameters-for-em-algorithm.html"><i class="fa fa-check"></i><b>4</b> Initial parameters for EM algorithm</a>
<ul>
<li class="chapter" data-level="4.1" data-path="initial-parameters-for-em-algorithm.html"><a href="initial-parameters-for-em-algorithm.html#e-step"><i class="fa fa-check"></i><b>4.1</b> E step</a></li>
<li class="chapter" data-level="4.2" data-path="initial-parameters-for-em-algorithm.html">
<a href="initial-parameters-for-em-algorithm.html#m-step"><i class="fa fa-check"></i><b>4.2</b> M step</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="initial-parameters-for-em-algorithm.html"><a href="initial-parameters-for-em-algorithm.html#m-step-for-pi"><i class="fa fa-check"></i><b>4.2.1</b> M step for <span class="math inline">\(\pi\)</span></a></li>
<li class="chapter" data-level="4.2.2" data-path="initial-parameters-for-em-algorithm.html"><a href="initial-parameters-for-em-algorithm.html#m-step-for-sigma"><i class="fa fa-check"></i><b>4.2.2</b> M step for <span class="math inline">\(\Sigma\)</span></a></li>
<li class="chapter" data-level="4.2.3" data-path="initial-parameters-for-em-algorithm.html"><a href="initial-parameters-for-em-algorithm.html#m-step-for-mu"><i class="fa fa-check"></i><b>4.2.3</b> M step for <span class="math inline">\(\mu\)</span></a></li>
<li class="chapter" data-level="4.2.4" data-path="initial-parameters-for-em-algorithm.html"><a href="initial-parameters-for-em-algorithm.html#helpers-for-m-step-mu"><i class="fa fa-check"></i><b>4.2.4</b> Helpers for M step (<span class="math inline">\(\mu\)</span>)</a></li>
<li class="chapter" data-level="4.2.5" data-path="initial-parameters-for-em-algorithm.html"><a href="initial-parameters-for-em-algorithm.html#all-rcpp-functions"><i class="fa fa-check"></i><b>4.2.5</b> All Rcpp functions</a></li>
</ul>
</li>
</ul>
</li>
<li class="chapter" data-level="5" data-path="the-main-flowtrend-function.html"><a href="the-main-flowtrend-function.html"><i class="fa fa-check"></i><b>5</b> The main “flowtrend” function</a></li>
<li class="chapter" data-level="6" data-path="reordering-clusters.html"><a href="reordering-clusters.html"><i class="fa fa-check"></i><b>6</b> Reordering clusters</a></li>
<li class="chapter" data-level="7" data-path="tuning-lambda.html">
<a href="tuning-lambda.html"><i class="fa fa-check"></i><b>7</b> Tuning <span class="math inline">\(\lambda\)</span></a>
<ul>
<li class="chapter" data-level="7.1" data-path="tuning-lambda.html"><a href="tuning-lambda.html#predicting-and-evaluating-on-new-time-points"><i class="fa fa-check"></i><b>7.1</b> Predicting and evaluating on new time points</a></li>
<li class="chapter" data-level="7.2" data-path="tuning-lambda.html"><a href="tuning-lambda.html#maximum-lambda_mu-lambda_pi-values-to-test"><i class="fa fa-check"></i><b>7.2</b> Maximum <span class="math inline">\((\lambda_\mu, \lambda_\pi)\)</span> values to test</a></li>
<li class="chapter" data-level="7.3" data-path="tuning-lambda.html"><a href="tuning-lambda.html#define-cv-data-folds"><i class="fa fa-check"></i><b>7.3</b> Define CV data folds</a></li>
<li class="chapter" data-level="7.4" data-path="tuning-lambda.html"><a href="tuning-lambda.html#cv-many-single-jobs"><i class="fa fa-check"></i><b>7.4</b> CV = many single jobs</a></li>
<li class="chapter" data-level="7.5" data-path="tuning-lambda.html"><a href="tuning-lambda.html#running-cross-validation"><i class="fa fa-check"></i><b>7.5</b> Running cross-validation</a></li>
<li class="chapter" data-level="7.6" data-path="tuning-lambda.html"><a href="tuning-lambda.html#summarizing-the-output"><i class="fa fa-check"></i><b>7.6</b> Summarizing the output</a></li>
<li class="chapter" data-level="7.7" data-path="tuning-lambda.html"><a href="tuning-lambda.html#cv-on-your-own-computer"><i class="fa fa-check"></i><b>7.7</b> CV on your own computer</a></li>
<li class="chapter" data-level="7.8" data-path="tuning-lambda.html"><a href="tuning-lambda.html#plotting"><i class="fa fa-check"></i><b>7.8</b> Plotting</a></li>
<li class="chapter" data-level="7.9" data-path="tuning-lambda.html"><a href="tuning-lambda.html#se-rule-for-cross-validation"><i class="fa fa-check"></i><b>7.9</b> 1SE rule for cross validation</a></li>
</ul>
</li>
<li class="chapter" data-level="8" data-path="testing-the-flowtrend-method.html">
<a href="testing-the-flowtrend-method.html"><i class="fa fa-check"></i><b>8</b> Testing the flowtrend method</a>
<ul>
<li class="chapter" data-level="8.1" data-path="testing-the-flowtrend-method.html"><a href="testing-the-flowtrend-method.html#id_1d-example"><i class="fa fa-check"></i><b>8.1</b> 1d example</a></li>
<li class="chapter" data-level="8.2" data-path="testing-the-flowtrend-method.html"><a href="testing-the-flowtrend-method.html#testing-monotonicity-of-objective-values"><i class="fa fa-check"></i><b>8.2</b> Testing monotonicity of objective values</a></li>
<li class="chapter" data-level="8.3" data-path="testing-the-flowtrend-method.html"><a href="testing-the-flowtrend-method.html#id_2d-example"><i class="fa fa-check"></i><b>8.3</b> 2d example</a></li>
<li class="chapter" data-level="8.4" data-path="testing-the-flowtrend-method.html"><a href="testing-the-flowtrend-method.html#working-with-binned-dataset"><i class="fa fa-check"></i><b>8.4</b> Working with “binned” dataset</a></li>
<li class="chapter" data-level="8.5" data-path="testing-the-flowtrend-method.html"><a href="testing-the-flowtrend-method.html#unevenly-spaced-inputs-x"><i class="fa fa-check"></i><b>8.5</b> Unevenly spaced inputs (x)</a></li>
</ul>
</li>
<li class="chapter" data-level="9" data-path="documenting-the-package-and-building.html"><a href="documenting-the-package-and-building.html"><i class="fa fa-check"></i><b>9</b> Documenting the package and building</a></li>
<li class="chapter" data-level="10" data-path="helpers-for-simulations.html">
<a href="helpers-for-simulations.html"><i class="fa fa-check"></i><b>10</b> Helpers for simulations</a>
<ul>
<li class="chapter" data-level="10.1" data-path="helpers-for-simulations.html"><a href="helpers-for-simulations.html#two-alternative-estimators"><i class="fa fa-check"></i><b>10.1</b> Two alternative estimators</a></li>
<li class="chapter" data-level="10.2" data-path="helpers-for-simulations.html"><a href="helpers-for-simulations.html#example-using-underfit_flowmeans-and-overfit_flowmeans"><i class="fa fa-check"></i><b>10.2</b> Example using <code><a href="helpers-for-simulations.html#underfit_flowmeans">underfit_flowmeans</a>()</code> and <code><a href="helpers-for-simulations.html#overfit_flowmeans">overfit_flowmeans</a>()</code></a></li>
<li class="chapter" data-level="10.3" data-path="helpers-for-simulations.html"><a href="helpers-for-simulations.html#evaluating-performance-soft-rand-index"><i class="fa fa-check"></i><b>10.3</b> Evaluating performance: soft RAND index</a></li>
<li class="chapter" data-level="10.4" data-path="helpers-for-simulations.html"><a href="helpers-for-simulations.html#generating-pseudo-real-data"><i class="fa fa-check"></i><b>10.4</b> Generating “pseudo-real” data</a></li>
<li class="chapter" data-level="10.5" data-path="helpers-for-simulations.html"><a href="helpers-for-simulations.html#miscellaneous-helpers"><i class="fa fa-check"></i><b>10.5</b> Miscellaneous helpers</a></li>
</ul>
</li>
</ul></nav>
</div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Creating the <code>flowtrend</code> R package</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-"><div id="initial-parameters-for-em-algorithm" class="section level1 hasAnchor" number="4">
<h1>
<span class="header-section-number">4</span> Initial parameters for EM algorithm<a href="initial-parameters-for-em-algorithm.html#initial-parameters-for-em-algorithm" class="anchor-section" aria-label="Anchor link to header"></a>
</h1>
<p>The EM algorithm requires some initial values for <span class="math inline">\(\mu\)</span>, <span class="math inline">\(\pi\)</span> and <span class="math inline">\(\Sigma\)</span>.</p>
<p>Initializing <span class="math inline">\(\pi\)</span> is done in one line, <code>prob = matrix(1/numclust, nrow = TT, ncol = numclust)</code>, which sets everything to <span class="math inline">\(1/K\)</span>.</p>
<p>For <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\Sigma\)</span>, we write some functions. Essentially, initial means
<span class="math inline">\(\mu\)</span> are <em>jittered</em> versions of a <span class="math inline">\(K\)</span> means that are drawn from a downsampled
version of <span class="math inline">\(ylist\)</span> (downsampling is done because <span class="math inline">\(ylist\)</span> can have a large number
of particles). <span class="math inline">\(\Sigma\)</span> is <span class="math inline">\(d\times d\)</span> identity matrices, with <code>fac=1</code> diagonal
by default.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="initial-parameters-for-em-algorithm.html#cb44-1" tabindex="-1"></a><span class="co">#' Initialize the cluster centers.</span></span>
<span id="cb44-2"><a href="initial-parameters-for-em-algorithm.html#cb44-2" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb44-3"><a href="initial-parameters-for-em-algorithm.html#cb44-3" tabindex="-1"></a><span class="co">#' @param ylist  A T-length list of (nt  by 3) datasets.  There should  be T of</span></span>
<span id="cb44-4"><a href="initial-parameters-for-em-algorithm.html#cb44-4" tabindex="-1"></a><span class="co">#'   such datasets. 3 is actually \code{mulen}.</span></span>
<span id="cb44-5"><a href="initial-parameters-for-em-algorithm.html#cb44-5" tabindex="-1"></a><span class="co">#' @param numclust Number of clusters (M).</span></span>
<span id="cb44-6"><a href="initial-parameters-for-em-algorithm.html#cb44-6" tabindex="-1"></a><span class="co">#' @param TT total number of (training) time points.</span></span>
<span id="cb44-7"><a href="initial-parameters-for-em-algorithm.html#cb44-7" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb44-8"><a href="initial-parameters-for-em-algorithm.html#cb44-8" tabindex="-1"></a><span class="co">#' @return An array of dimension (T x dimdat x M).</span></span>
<span id="cb44-9"><a href="initial-parameters-for-em-algorithm.html#cb44-9" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb44-10"><a href="initial-parameters-for-em-algorithm.html#cb44-10" tabindex="-1"></a><span id="init_mn">init_mn</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(ylist, numclust, TT, dimdat, <span class="at">countslist =</span> <span class="cn">NULL</span>, <span class="at">seed=</span><span class="cn">NULL</span>){</span>
<span id="cb44-11"><a href="initial-parameters-for-em-algorithm.html#cb44-11" tabindex="-1"></a></span>
<span id="cb44-12"><a href="initial-parameters-for-em-algorithm.html#cb44-12" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(seed)){</span>
<span id="cb44-13"><a href="initial-parameters-for-em-algorithm.html#cb44-13" tabindex="-1"></a>    assertthat<span class="sc">::</span><span class="fu">assert_that</span>(<span class="fu">all</span>((seed <span class="sc">%&gt;%</span> <span class="fu">sapply</span>(., class)) <span class="sc">==</span> <span class="st">"integer"</span>))</span>
<span id="cb44-14"><a href="initial-parameters-for-em-algorithm.html#cb44-14" tabindex="-1"></a>    assertthat<span class="sc">::</span><span class="fu">assert_that</span>(<span class="fu">length</span>(seed) <span class="sc">==</span> <span class="dv">7</span>)</span>
<span id="cb44-15"><a href="initial-parameters-for-em-algorithm.html#cb44-15" tabindex="-1"></a>    <span class="fu">RNGkind</span>(<span class="st">"L'Ecuyer-CMRG"</span>) </span>
<span id="cb44-16"><a href="initial-parameters-for-em-algorithm.html#cb44-16" tabindex="-1"></a>    .Random.seed <span class="ot">&lt;&lt;-</span> seed</span>
<span id="cb44-17"><a href="initial-parameters-for-em-algorithm.html#cb44-17" tabindex="-1"></a>  }</span>
<span id="cb44-18"><a href="initial-parameters-for-em-algorithm.html#cb44-18" tabindex="-1"></a></span>
<span id="cb44-19"><a href="initial-parameters-for-em-algorithm.html#cb44-19" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(countslist)){</span>
<span id="cb44-20"><a href="initial-parameters-for-em-algorithm.html#cb44-20" tabindex="-1"></a>    ntlist <span class="ot">=</span> <span class="fu">sapply</span>(ylist, nrow)</span>
<span id="cb44-21"><a href="initial-parameters-for-em-algorithm.html#cb44-21" tabindex="-1"></a>    countslist <span class="ot">=</span> <span class="fu">lapply</span>(ntlist, <span class="at">FUN =</span> <span class="cf">function</span>(nt) <span class="fu">rep</span>(<span class="dv">1</span>, nt))</span>
<span id="cb44-22"><a href="initial-parameters-for-em-algorithm.html#cb44-22" tabindex="-1"></a>  }</span>
<span id="cb44-23"><a href="initial-parameters-for-em-algorithm.html#cb44-23" tabindex="-1"></a></span>
<span id="cb44-24"><a href="initial-parameters-for-em-algorithm.html#cb44-24" tabindex="-1"></a>  <span class="do">## Initialize the means by (1) collapsing to one cytogram (2) random</span></span>
<span id="cb44-25"><a href="initial-parameters-for-em-algorithm.html#cb44-25" tabindex="-1"></a>  <span class="do">## sampling from this distribution, after truncation,</span></span>
<span id="cb44-26"><a href="initial-parameters-for-em-algorithm.html#cb44-26" tabindex="-1"></a>  TT <span class="ot">=</span> <span class="fu">length</span>(ylist)</span>
<span id="cb44-27"><a href="initial-parameters-for-em-algorithm.html#cb44-27" tabindex="-1"></a>  ylist_downsampled <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="cf">function</span>(tt){</span>
<span id="cb44-28"><a href="initial-parameters-for-em-algorithm.html#cb44-28" tabindex="-1"></a></span>
<span id="cb44-29"><a href="initial-parameters-for-em-algorithm.html#cb44-29" tabindex="-1"></a>    y <span class="ot">=</span> ylist[[tt]]</span>
<span id="cb44-30"><a href="initial-parameters-for-em-algorithm.html#cb44-30" tabindex="-1"></a>    counts <span class="ot">=</span> countslist[[tt]]</span>
<span id="cb44-31"><a href="initial-parameters-for-em-algorithm.html#cb44-31" tabindex="-1"></a></span>
<span id="cb44-32"><a href="initial-parameters-for-em-algorithm.html#cb44-32" tabindex="-1"></a>    <span class="do">## Sample so that, in total, we get mean(nt) * 30 sized sample. In the case</span></span>
<span id="cb44-33"><a href="initial-parameters-for-em-algorithm.html#cb44-33" tabindex="-1"></a>    <span class="do">## of binned data, nt is the number of bins.</span></span>
<span id="cb44-34"><a href="initial-parameters-for-em-algorithm.html#cb44-34" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">nrow</span>(y) <span class="sc">&gt;</span> <span class="dv">500</span>) nsize <span class="ot">=</span> <span class="fu">pmin</span>(<span class="fu">nrow</span>(y) <span class="sc">/</span> TT <span class="sc">*</span> <span class="dv">30</span>, <span class="fu">nrow</span>(y)) <span class="cf">else</span> nsize <span class="ot">=</span> <span class="fu">nrow</span>(y)</span>
<span id="cb44-35"><a href="initial-parameters-for-em-algorithm.html#cb44-35" tabindex="-1"></a>    some_rows <span class="ot">=</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(y),</span>
<span id="cb44-36"><a href="initial-parameters-for-em-algorithm.html#cb44-36" tabindex="-1"></a>                       <span class="at">size =</span> nsize,</span>
<span id="cb44-37"><a href="initial-parameters-for-em-algorithm.html#cb44-37" tabindex="-1"></a>                       <span class="at">prob =</span> counts<span class="sc">/</span><span class="fu">sum</span>(counts))</span>
<span id="cb44-38"><a href="initial-parameters-for-em-algorithm.html#cb44-38" tabindex="-1"></a>    y[some_rows,, drop<span class="ot">=</span><span class="cn">FALSE</span>]</span>
<span id="cb44-39"><a href="initial-parameters-for-em-algorithm.html#cb44-39" tabindex="-1"></a>  })</span>
<span id="cb44-40"><a href="initial-parameters-for-em-algorithm.html#cb44-40" tabindex="-1"></a></span>
<span id="cb44-41"><a href="initial-parameters-for-em-algorithm.html#cb44-41" tabindex="-1"></a>  <span class="do">## Jitter the means a bit</span></span>
<span id="cb44-42"><a href="initial-parameters-for-em-algorithm.html#cb44-42" tabindex="-1"></a>  yy <span class="ot">=</span> <span class="fu">do.call</span>(rbind, ylist_downsampled)</span>
<span id="cb44-43"><a href="initial-parameters-for-em-algorithm.html#cb44-43" tabindex="-1"></a>  new_means <span class="ot">=</span> yy[<span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(yy), numclust),, drop<span class="ot">=</span><span class="cn">FALSE</span>]</span>
<span id="cb44-44"><a href="initial-parameters-for-em-algorithm.html#cb44-44" tabindex="-1"></a>  jitter_sd <span class="ot">=</span> <span class="fu">apply</span>(yy, <span class="dv">2</span>, sd) <span class="sc">/</span> <span class="dv">100</span></span>
<span id="cb44-45"><a href="initial-parameters-for-em-algorithm.html#cb44-45" tabindex="-1"></a>  jitter_means <span class="ot">=</span> MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(<span class="at">n =</span> <span class="fu">nrow</span>(new_means),</span>
<span id="cb44-46"><a href="initial-parameters-for-em-algorithm.html#cb44-46" tabindex="-1"></a>                               <span class="at">mu =</span> <span class="fu">rep</span>(<span class="dv">0</span>, dimdat),</span>
<span id="cb44-47"><a href="initial-parameters-for-em-algorithm.html#cb44-47" tabindex="-1"></a>                               <span class="at">Sigma =</span> <span class="fu">diag</span>(jitter_sd, <span class="at">ncol =</span> dimdat))</span>
<span id="cb44-48"><a href="initial-parameters-for-em-algorithm.html#cb44-48" tabindex="-1"></a>  new_means <span class="ot">=</span> new_means <span class="sc">+</span> jitter_means</span>
<span id="cb44-49"><a href="initial-parameters-for-em-algorithm.html#cb44-49" tabindex="-1"></a></span>
<span id="cb44-50"><a href="initial-parameters-for-em-algorithm.html#cb44-50" tabindex="-1"></a>  <span class="do">## Repeat TT times == flat/constant initial means across time.</span></span>
<span id="cb44-51"><a href="initial-parameters-for-em-algorithm.html#cb44-51" tabindex="-1"></a>  mulist <span class="ot">=</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="cf">function</span>(tt){ new_means })</span>
<span id="cb44-52"><a href="initial-parameters-for-em-algorithm.html#cb44-52" tabindex="-1"></a></span>
<span id="cb44-53"><a href="initial-parameters-for-em-algorithm.html#cb44-53" tabindex="-1"></a>  <span class="do">## } else {</span></span>
<span id="cb44-54"><a href="initial-parameters-for-em-algorithm.html#cb44-54" tabindex="-1"></a></span>
<span id="cb44-55"><a href="initial-parameters-for-em-algorithm.html#cb44-55" tabindex="-1"></a>  <span class="do">##   TT = length(ylist)</span></span>
<span id="cb44-56"><a href="initial-parameters-for-em-algorithm.html#cb44-56" tabindex="-1"></a>  <span class="do">##   ylist_downsampled &lt;- lapply(1:TT, function(tt){</span></span>
<span id="cb44-57"><a href="initial-parameters-for-em-algorithm.html#cb44-57" tabindex="-1"></a>  <span class="do">##     y = ylist[[tt]]</span></span>
<span id="cb44-58"><a href="initial-parameters-for-em-algorithm.html#cb44-58" tabindex="-1"></a>  <span class="do">##     counts = countslist[[tt]]</span></span>
<span id="cb44-59"><a href="initial-parameters-for-em-algorithm.html#cb44-59" tabindex="-1"></a>  <span class="do">##     nsize = pmin(nrow(y) / TT * 30, nrow(y))</span></span>
<span id="cb44-60"><a href="initial-parameters-for-em-algorithm.html#cb44-60" tabindex="-1"></a>  <span class="do">##     y[sample(1:nrow(y), size = nsize),, drop=FALSE]</span></span>
<span id="cb44-61"><a href="initial-parameters-for-em-algorithm.html#cb44-61" tabindex="-1"></a>  <span class="do">##   })</span></span>
<span id="cb44-62"><a href="initial-parameters-for-em-algorithm.html#cb44-62" tabindex="-1"></a></span>
<span id="cb44-63"><a href="initial-parameters-for-em-algorithm.html#cb44-63" tabindex="-1"></a>  <span class="do">##   ## Combine all the particles</span></span>
<span id="cb44-64"><a href="initial-parameters-for-em-algorithm.html#cb44-64" tabindex="-1"></a>  <span class="do">##   yy = do.call(rbind, ylist_downsampled)</span></span>
<span id="cb44-65"><a href="initial-parameters-for-em-algorithm.html#cb44-65" tabindex="-1"></a></span>
<span id="cb44-66"><a href="initial-parameters-for-em-algorithm.html#cb44-66" tabindex="-1"></a>  <span class="do">##   ## Get K new means from these</span></span>
<span id="cb44-67"><a href="initial-parameters-for-em-algorithm.html#cb44-67" tabindex="-1"></a>  <span class="do">##   inds = sample(1:nrow(yy), numclust)</span></span>
<span id="cb44-68"><a href="initial-parameters-for-em-algorithm.html#cb44-68" tabindex="-1"></a>  <span class="do">##   new_means = yy[inds,, drop=FALSE]</span></span>
<span id="cb44-69"><a href="initial-parameters-for-em-algorithm.html#cb44-69" tabindex="-1"></a>  <span class="do">##   mulist = lapply(1:TT, function(tt){ new_means })</span></span>
<span id="cb44-70"><a href="initial-parameters-for-em-algorithm.html#cb44-70" tabindex="-1"></a></span>
<span id="cb44-71"><a href="initial-parameters-for-em-algorithm.html#cb44-71" tabindex="-1"></a>  <span class="do">## }</span></span>
<span id="cb44-72"><a href="initial-parameters-for-em-algorithm.html#cb44-72" tabindex="-1"></a></span>
<span id="cb44-73"><a href="initial-parameters-for-em-algorithm.html#cb44-73" tabindex="-1"></a>  <span class="do">## New (T x dimdat x numclust) array is created.</span></span>
<span id="cb44-74"><a href="initial-parameters-for-em-algorithm.html#cb44-74" tabindex="-1"></a>  muarray <span class="ot">=</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim=</span><span class="fu">c</span>(TT, dimdat, numclust))</span>
<span id="cb44-75"><a href="initial-parameters-for-em-algorithm.html#cb44-75" tabindex="-1"></a>  <span class="cf">for</span>(tt <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>TT){</span>
<span id="cb44-76"><a href="initial-parameters-for-em-algorithm.html#cb44-76" tabindex="-1"></a>    muarray[tt,,] <span class="ot">=</span> <span class="fu">as.matrix</span>(mulist[[tt]])</span>
<span id="cb44-77"><a href="initial-parameters-for-em-algorithm.html#cb44-77" tabindex="-1"></a>  }</span>
<span id="cb44-78"><a href="initial-parameters-for-em-algorithm.html#cb44-78" tabindex="-1"></a>  <span class="fu">return</span>(muarray)</span>
<span id="cb44-79"><a href="initial-parameters-for-em-algorithm.html#cb44-79" tabindex="-1"></a>}</span>
<span id="cb44-80"><a href="initial-parameters-for-em-algorithm.html#cb44-80" tabindex="-1"></a></span>
<span id="cb44-81"><a href="initial-parameters-for-em-algorithm.html#cb44-81" tabindex="-1"></a></span>
<span id="cb44-82"><a href="initial-parameters-for-em-algorithm.html#cb44-82" tabindex="-1"></a><span class="co">#' Initialize the covariances.</span></span>
<span id="cb44-83"><a href="initial-parameters-for-em-algorithm.html#cb44-83" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb44-84"><a href="initial-parameters-for-em-algorithm.html#cb44-84" tabindex="-1"></a><span class="co">#' @param data The (nt by 3) datasets. There should be T of them.</span></span>
<span id="cb44-85"><a href="initial-parameters-for-em-algorithm.html#cb44-85" tabindex="-1"></a><span class="co">#' @param numclust Number of clusters.</span></span>
<span id="cb44-86"><a href="initial-parameters-for-em-algorithm.html#cb44-86" tabindex="-1"></a><span class="co">#' @param fac Value to use for the diagonal of the (dimdat x dimdat) covariance</span></span>
<span id="cb44-87"><a href="initial-parameters-for-em-algorithm.html#cb44-87" tabindex="-1"></a><span class="co">#'   matrix.</span></span>
<span id="cb44-88"><a href="initial-parameters-for-em-algorithm.html#cb44-88" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb44-89"><a href="initial-parameters-for-em-algorithm.html#cb44-89" tabindex="-1"></a><span class="co">#' @return An (K x dimdat x dimdat) array containing the (dimdat by dimdat)</span></span>
<span id="cb44-90"><a href="initial-parameters-for-em-algorithm.html#cb44-90" tabindex="-1"></a><span class="co">#'   covariances.</span></span>
<span id="cb44-91"><a href="initial-parameters-for-em-algorithm.html#cb44-91" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb44-92"><a href="initial-parameters-for-em-algorithm.html#cb44-92" tabindex="-1"></a><span id="init_sigma">init_sigma</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(data, numclust, <span class="at">fac =</span> <span class="dv">1</span>){</span>
<span id="cb44-93"><a href="initial-parameters-for-em-algorithm.html#cb44-93" tabindex="-1"></a></span>
<span id="cb44-94"><a href="initial-parameters-for-em-algorithm.html#cb44-94" tabindex="-1"></a>  ndat <span class="ot">=</span> <span class="fu">nrow</span>(data[[<span class="dv">1</span>]])</span>
<span id="cb44-95"><a href="initial-parameters-for-em-algorithm.html#cb44-95" tabindex="-1"></a>  pdat <span class="ot">=</span> <span class="fu">ncol</span>(data[[<span class="dv">1</span>]])</span>
<span id="cb44-96"><a href="initial-parameters-for-em-algorithm.html#cb44-96" tabindex="-1"></a>  sigmas <span class="ot">=</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>numclust, <span class="cf">function</span>(iclust){</span>
<span id="cb44-97"><a href="initial-parameters-for-em-algorithm.html#cb44-97" tabindex="-1"></a>    onesigma <span class="ot">=</span> <span class="fu">diag</span>(fac <span class="sc">*</span> <span class="fu">rep</span>(<span class="dv">1</span>, pdat))</span>
<span id="cb44-98"><a href="initial-parameters-for-em-algorithm.html#cb44-98" tabindex="-1"></a>    <span class="cf">if</span>(pdat<span class="sc">==</span><span class="dv">1</span>) onesigma <span class="ot">=</span> <span class="fu">as.matrix</span>(fac)</span>
<span id="cb44-99"><a href="initial-parameters-for-em-algorithm.html#cb44-99" tabindex="-1"></a>    <span class="fu">colnames</span>(onesigma) <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">"datcol"</span>, <span class="dv">1</span><span class="sc">:</span>pdat)</span>
<span id="cb44-100"><a href="initial-parameters-for-em-algorithm.html#cb44-100" tabindex="-1"></a>    <span class="fu">rownames</span>(onesigma) <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">"datcol"</span>, <span class="dv">1</span><span class="sc">:</span>pdat)</span>
<span id="cb44-101"><a href="initial-parameters-for-em-algorithm.html#cb44-101" tabindex="-1"></a>    <span class="fu">return</span>(onesigma)</span>
<span id="cb44-102"><a href="initial-parameters-for-em-algorithm.html#cb44-102" tabindex="-1"></a>  })</span>
<span id="cb44-103"><a href="initial-parameters-for-em-algorithm.html#cb44-103" tabindex="-1"></a>  sigmas <span class="ot">=</span> abind<span class="sc">::</span><span class="fu">abind</span>(sigmas, <span class="at">along=</span><span class="dv">0</span>)</span>
<span id="cb44-104"><a href="initial-parameters-for-em-algorithm.html#cb44-104" tabindex="-1"></a>  <span class="fu">return</span>(sigmas)</span>
<span id="cb44-105"><a href="initial-parameters-for-em-algorithm.html#cb44-105" tabindex="-1"></a>}</span></code></pre></div>
<p>Here’s a helper function for printing the progress.</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="initial-parameters-for-em-algorithm.html#cb45-1" tabindex="-1"></a><span class="co">#' A helper function to print the progress of a loop or simulation.</span></span>
<span id="cb45-2"><a href="initial-parameters-for-em-algorithm.html#cb45-2" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb45-3"><a href="initial-parameters-for-em-algorithm.html#cb45-3" tabindex="-1"></a><span class="co">#' @param isim Replicate number.</span></span>
<span id="cb45-4"><a href="initial-parameters-for-em-algorithm.html#cb45-4" tabindex="-1"></a><span class="co">#' @param nsim Total number of replicates.</span></span>
<span id="cb45-5"><a href="initial-parameters-for-em-algorithm.html#cb45-5" tabindex="-1"></a><span class="co">#' @param type Type of job you're running. Defaults to "simulation".</span></span>
<span id="cb45-6"><a href="initial-parameters-for-em-algorithm.html#cb45-6" tabindex="-1"></a><span class="co">#' @param lapsetime Lapsed time, in seconds (by default).</span></span>
<span id="cb45-7"><a href="initial-parameters-for-em-algorithm.html#cb45-7" tabindex="-1"></a><span class="co">#' @param lapsetimeunit "second".</span></span>
<span id="cb45-8"><a href="initial-parameters-for-em-algorithm.html#cb45-8" tabindex="-1"></a><span class="co">#' @param start.time start time.</span></span>
<span id="cb45-9"><a href="initial-parameters-for-em-algorithm.html#cb45-9" tabindex="-1"></a><span class="co">#' @param fill Whether or not to fill the line.</span></span>
<span id="cb45-10"><a href="initial-parameters-for-em-algorithm.html#cb45-10" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb45-11"><a href="initial-parameters-for-em-algorithm.html#cb45-11" tabindex="-1"></a><span class="co">#' @return No return</span></span>
<span id="cb45-12"><a href="initial-parameters-for-em-algorithm.html#cb45-12" tabindex="-1"></a><span id="print_progress">print_progress</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(isim, nsim,</span>
<span id="cb45-13"><a href="initial-parameters-for-em-algorithm.html#cb45-13" tabindex="-1"></a>                           <span class="at">type =</span> <span class="st">"simulation"</span>, <span class="at">lapsetime =</span> <span class="cn">NULL</span>,</span>
<span id="cb45-14"><a href="initial-parameters-for-em-algorithm.html#cb45-14" tabindex="-1"></a>                           <span class="at">lapsetimeunit =</span> <span class="st">"seconds"</span>, <span class="at">start.time =</span> <span class="cn">NULL</span>,</span>
<span id="cb45-15"><a href="initial-parameters-for-em-algorithm.html#cb45-15" tabindex="-1"></a>                           <span class="at">fill =</span> <span class="cn">FALSE</span>){</span>
<span id="cb45-16"><a href="initial-parameters-for-em-algorithm.html#cb45-16" tabindex="-1"></a></span>
<span id="cb45-17"><a href="initial-parameters-for-em-algorithm.html#cb45-17" tabindex="-1"></a>  <span class="do">## If lapse time is present, then use it</span></span>
<span id="cb45-18"><a href="initial-parameters-for-em-algorithm.html#cb45-18" tabindex="-1"></a>  <span class="cf">if</span>(fill) <span class="fu">cat</span>(<span class="at">fill =</span> <span class="cn">TRUE</span>)</span>
<span id="cb45-19"><a href="initial-parameters-for-em-algorithm.html#cb45-19" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(lapsetime) <span class="sc">&amp;</span> <span class="fu">is.null</span>(start.time)){</span>
<span id="cb45-20"><a href="initial-parameters-for-em-algorithm.html#cb45-20" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\r</span><span class="st">"</span>, type, <span class="st">" "</span>, isim, <span class="st">"out of"</span>, nsim)</span>
<span id="cb45-21"><a href="initial-parameters-for-em-algorithm.html#cb45-21" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb45-22"><a href="initial-parameters-for-em-algorithm.html#cb45-22" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(start.time)){</span>
<span id="cb45-23"><a href="initial-parameters-for-em-algorithm.html#cb45-23" tabindex="-1"></a>      lapsetime <span class="ot">=</span> <span class="fu">round</span>(<span class="fu">difftime</span>(<span class="fu">Sys.time</span>(), start.time,</span>
<span id="cb45-24"><a href="initial-parameters-for-em-algorithm.html#cb45-24" tabindex="-1"></a>                                 <span class="at">units =</span> <span class="st">"secs"</span>), <span class="dv">0</span>)</span>
<span id="cb45-25"><a href="initial-parameters-for-em-algorithm.html#cb45-25" tabindex="-1"></a>      remainingtime <span class="ot">=</span> <span class="fu">round</span>(lapsetime <span class="sc">*</span> (nsim<span class="sc">-</span>isim)<span class="sc">/</span>isim,<span class="dv">0</span>)</span>
<span id="cb45-26"><a href="initial-parameters-for-em-algorithm.html#cb45-26" tabindex="-1"></a>      endtime <span class="ot">=</span> <span class="fu">Sys.time</span>() <span class="sc">+</span> remainingtime</span>
<span id="cb45-27"><a href="initial-parameters-for-em-algorithm.html#cb45-27" tabindex="-1"></a>    }</span>
<span id="cb45-28"><a href="initial-parameters-for-em-algorithm.html#cb45-28" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\r</span><span class="st">"</span>, type, <span class="st">" "</span>, isim, <span class="st">"out of"</span>, nsim, <span class="st">"with lapsed time"</span>,</span>
<span id="cb45-29"><a href="initial-parameters-for-em-algorithm.html#cb45-29" tabindex="-1"></a>        lapsetime, lapsetimeunit, <span class="st">"and remaining time"</span>, remainingtime,</span>
<span id="cb45-30"><a href="initial-parameters-for-em-algorithm.html#cb45-30" tabindex="-1"></a>        lapsetimeunit, <span class="st">"and will finish at"</span>, <span class="fu">strftime</span>(endtime))</span>
<span id="cb45-31"><a href="initial-parameters-for-em-algorithm.html#cb45-31" tabindex="-1"></a>  }</span>
<span id="cb45-32"><a href="initial-parameters-for-em-algorithm.html#cb45-32" tabindex="-1"></a>  <span class="cf">if</span>(fill) <span class="fu">cat</span>(<span class="at">fill =</span> <span class="cn">TRUE</span>)</span>
<span id="cb45-33"><a href="initial-parameters-for-em-algorithm.html#cb45-33" tabindex="-1"></a>}</span></code></pre></div>
<div id="e-step" class="section level2 hasAnchor" number="4.1">
<h2>
<span class="header-section-number">4.1</span> E step<a href="initial-parameters-for-em-algorithm.html#e-step" class="anchor-section" aria-label="Anchor link to header"></a>
</h2>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="initial-parameters-for-em-algorithm.html#cb46-1" tabindex="-1"></a><span class="co">#' E step, which updates the "responsibilities", which are posterior membership probabilities of each particle.</span></span>
<span id="cb46-2"><a href="initial-parameters-for-em-algorithm.html#cb46-2" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb46-3"><a href="initial-parameters-for-em-algorithm.html#cb46-3" tabindex="-1"></a><span class="co">#' @param mn</span></span>
<span id="cb46-4"><a href="initial-parameters-for-em-algorithm.html#cb46-4" tabindex="-1"></a><span class="co">#' @param sigma</span></span>
<span id="cb46-5"><a href="initial-parameters-for-em-algorithm.html#cb46-5" tabindex="-1"></a><span class="co">#' @param prob</span></span>
<span id="cb46-6"><a href="initial-parameters-for-em-algorithm.html#cb46-6" tabindex="-1"></a><span class="co">#' @param ylist</span></span>
<span id="cb46-7"><a href="initial-parameters-for-em-algorithm.html#cb46-7" tabindex="-1"></a><span class="co">#' @param numclust</span></span>
<span id="cb46-8"><a href="initial-parameters-for-em-algorithm.html#cb46-8" tabindex="-1"></a><span class="co">#' @param denslist_by_clust</span></span>
<span id="cb46-9"><a href="initial-parameters-for-em-algorithm.html#cb46-9" tabindex="-1"></a><span class="co">#' @param first_iter</span></span>
<span id="cb46-10"><a href="initial-parameters-for-em-algorithm.html#cb46-10" tabindex="-1"></a><span class="co">#' @param countslist</span></span>
<span id="cb46-11"><a href="initial-parameters-for-em-algorithm.html#cb46-11" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb46-12"><a href="initial-parameters-for-em-algorithm.html#cb46-12" tabindex="-1"></a><span class="co">#' @return</span></span>
<span id="cb46-13"><a href="initial-parameters-for-em-algorithm.html#cb46-13" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb46-14"><a href="initial-parameters-for-em-algorithm.html#cb46-14" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb46-15"><a href="initial-parameters-for-em-algorithm.html#cb46-15" tabindex="-1"></a><span id="Estep">Estep</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(mn, sigma, prob, <span class="at">ylist =</span> <span class="cn">NULL</span>, numclust, <span class="at">denslist_by_clust =</span> <span class="cn">NULL</span>,</span>
<span id="cb46-16"><a href="initial-parameters-for-em-algorithm.html#cb46-16" tabindex="-1"></a>                  <span class="at">first_iter =</span> <span class="cn">FALSE</span>, <span class="at">countslist =</span> <span class="cn">NULL</span>){</span>
<span id="cb46-17"><a href="initial-parameters-for-em-algorithm.html#cb46-17" tabindex="-1"></a>  <span class="do">## Basic setup</span></span>
<span id="cb46-18"><a href="initial-parameters-for-em-algorithm.html#cb46-18" tabindex="-1"></a>  TT <span class="ot">=</span> <span class="fu">length</span>(ylist)</span>
<span id="cb46-19"><a href="initial-parameters-for-em-algorithm.html#cb46-19" tabindex="-1"></a>  ntlist <span class="ot">=</span> <span class="fu">sapply</span>(ylist, nrow)</span>
<span id="cb46-20"><a href="initial-parameters-for-em-algorithm.html#cb46-20" tabindex="-1"></a>  resp <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb46-21"><a href="initial-parameters-for-em-algorithm.html#cb46-21" tabindex="-1"></a>  dimdat <span class="ot">=</span> <span class="fu">dim</span>(mn)[<span class="dv">2</span>]</span>
<span id="cb46-22"><a href="initial-parameters-for-em-algorithm.html#cb46-22" tabindex="-1"></a>  assertthat<span class="sc">::</span><span class="fu">assert_that</span>(<span class="fu">dim</span>(mn)[<span class="dv">1</span>] <span class="sc">==</span> <span class="fu">length</span>(ylist))</span>
<span id="cb46-23"><a href="initial-parameters-for-em-algorithm.html#cb46-23" tabindex="-1"></a></span>
<span id="cb46-24"><a href="initial-parameters-for-em-algorithm.html#cb46-24" tabindex="-1"></a>  <span class="do">## Helper to calculate Gaussian density for each \code{N(y_{t,k},mu_{t,k} and</span></span>
<span id="cb46-25"><a href="initial-parameters-for-em-algorithm.html#cb46-25" tabindex="-1"></a>  <span class="do">## Sigma_k)}.</span></span>
<span id="cb46-26"><a href="initial-parameters-for-em-algorithm.html#cb46-26" tabindex="-1"></a>  <span id="calculate_dens">calculate_dens</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(iclust, tt, y, mn, sigma, denslist_by_clust,</span>
<span id="cb46-27"><a href="initial-parameters-for-em-algorithm.html#cb46-27" tabindex="-1"></a>                             first_iter) {</span>
<span id="cb46-28"><a href="initial-parameters-for-em-algorithm.html#cb46-28" tabindex="-1"></a>    mu <span class="ot">&lt;-</span> mn[tt, , iclust]</span>
<span id="cb46-29"><a href="initial-parameters-for-em-algorithm.html#cb46-29" tabindex="-1"></a>    <span class="cf">if</span> (dimdat <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb46-30"><a href="initial-parameters-for-em-algorithm.html#cb46-30" tabindex="-1"></a>      dens <span class="ot">=</span> <span class="fu">dnorm</span>(y, mu, <span class="at">sd =</span> <span class="fu">sqrt</span>(sigma[iclust, , ]))</span>
<span id="cb46-31"><a href="initial-parameters-for-em-algorithm.html#cb46-31" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb46-32"><a href="initial-parameters-for-em-algorithm.html#cb46-32" tabindex="-1"></a>       dens <span class="ot">=</span> <span class="fu">dmvnorm_arma_fast</span>(y, mu, sigma[iclust,,], <span class="cn">FALSE</span>)</span>
<span id="cb46-33"><a href="initial-parameters-for-em-algorithm.html#cb46-33" tabindex="-1"></a>    }</span>
<span id="cb46-34"><a href="initial-parameters-for-em-algorithm.html#cb46-34" tabindex="-1"></a>    <span class="fu">return</span>(dens)</span>
<span id="cb46-35"><a href="initial-parameters-for-em-algorithm.html#cb46-35" tabindex="-1"></a>  }</span>
<span id="cb46-36"><a href="initial-parameters-for-em-algorithm.html#cb46-36" tabindex="-1"></a></span>
<span id="cb46-37"><a href="initial-parameters-for-em-algorithm.html#cb46-37" tabindex="-1"></a>  <span class="do">## Calculate posterior probability of membership of $y_{it}$.</span></span>
<span id="cb46-38"><a href="initial-parameters-for-em-algorithm.html#cb46-38" tabindex="-1"></a>  ncol.prob <span class="ot">=</span> <span class="fu">ncol</span>(prob)</span>
<span id="cb46-39"><a href="initial-parameters-for-em-algorithm.html#cb46-39" tabindex="-1"></a>  <span class="cf">for</span> (tt <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>TT) {</span>
<span id="cb46-40"><a href="initial-parameters-for-em-algorithm.html#cb46-40" tabindex="-1"></a>    ylist_tt <span class="ot">=</span> ylist[[tt]]</span>
<span id="cb46-41"><a href="initial-parameters-for-em-algorithm.html#cb46-41" tabindex="-1"></a>    densmat <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span>numclust, calculate_dens, tt, ylist_tt,</span>
<span id="cb46-42"><a href="initial-parameters-for-em-algorithm.html#cb46-42" tabindex="-1"></a>                      mn, sigma, denslist_by_clust, first_iter)</span>
<span id="cb46-43"><a href="initial-parameters-for-em-algorithm.html#cb46-43" tabindex="-1"></a>    wt.densmat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(prob[tt, ], <span class="at">nrow =</span> ntlist[tt],</span>
<span id="cb46-44"><a href="initial-parameters-for-em-algorithm.html#cb46-44" tabindex="-1"></a>                         <span class="at">ncol =</span> ncol.prob, <span class="at">byrow =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> densmat</span>
<span id="cb46-45"><a href="initial-parameters-for-em-algorithm.html#cb46-45" tabindex="-1"></a>    wt.densmat <span class="ot">=</span> wt.densmat <span class="sc">+</span> <span class="fl">1e-10</span></span>
<span id="cb46-46"><a href="initial-parameters-for-em-algorithm.html#cb46-46" tabindex="-1"></a>    wt.densmat <span class="ot">&lt;-</span> wt.densmat<span class="sc">/</span><span class="fu">rowSums</span>(wt.densmat)</span>
<span id="cb46-47"><a href="initial-parameters-for-em-algorithm.html#cb46-47" tabindex="-1"></a>    resp[[tt]] <span class="ot">&lt;-</span> wt.densmat</span>
<span id="cb46-48"><a href="initial-parameters-for-em-algorithm.html#cb46-48" tabindex="-1"></a>  }</span>
<span id="cb46-49"><a href="initial-parameters-for-em-algorithm.html#cb46-49" tabindex="-1"></a></span>
<span id="cb46-50"><a href="initial-parameters-for-em-algorithm.html#cb46-50" tabindex="-1"></a>  <span class="do">## Weight the responsibilities by $C_{it}$.</span></span>
<span id="cb46-51"><a href="initial-parameters-for-em-algorithm.html#cb46-51" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(countslist)) {</span>
<span id="cb46-52"><a href="initial-parameters-for-em-algorithm.html#cb46-52" tabindex="-1"></a>    resp <span class="ot">&lt;-</span> <span class="fu">Map</span>(<span class="cf">function</span>(myresp, mycount) {</span>
<span id="cb46-53"><a href="initial-parameters-for-em-algorithm.html#cb46-53" tabindex="-1"></a>      myresp <span class="sc">*</span> mycount</span>
<span id="cb46-54"><a href="initial-parameters-for-em-algorithm.html#cb46-54" tabindex="-1"></a>    }, resp, countslist)</span>
<span id="cb46-55"><a href="initial-parameters-for-em-algorithm.html#cb46-55" tabindex="-1"></a>  }</span>
<span id="cb46-56"><a href="initial-parameters-for-em-algorithm.html#cb46-56" tabindex="-1"></a>  <span class="fu">return</span>(resp)</span>
<span id="cb46-57"><a href="initial-parameters-for-em-algorithm.html#cb46-57" tabindex="-1"></a>}</span></code></pre></div>
<p>The E step should return a list of exactly the same size and format as <code>ylist</code>,
which is a <span class="math inline">\(T\)</span> -length list of matrices of size <span class="math inline">\(n_t \times d\)</span>.</p>
<p>(This test fails for some reason; will come back to this.)</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="initial-parameters-for-em-algorithm.html#cb47-1" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">"E step returns appropriately sized responsibilities."</span>,{</span>
<span id="cb47-2"><a href="initial-parameters-for-em-algorithm.html#cb47-2" tabindex="-1"></a>  </span>
<span id="cb47-3"><a href="initial-parameters-for-em-algorithm.html#cb47-3" tabindex="-1"></a>  <span class="do">## Generate some fake data</span></span>
<span id="cb47-4"><a href="initial-parameters-for-em-algorithm.html#cb47-4" tabindex="-1"></a>  TT <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb47-5"><a href="initial-parameters-for-em-algorithm.html#cb47-5" tabindex="-1"></a>  ylist <span class="ot">=</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="cf">function</span>(tt){ <span class="fu">runif</span>(<span class="dv">90</span>) <span class="sc">%&gt;%</span> <span class="fu">matrix</span>(<span class="at">ncol =</span> <span class="dv">3</span>, <span class="at">nrow =</span> <span class="dv">30</span>)})</span>
<span id="cb47-6"><a href="initial-parameters-for-em-algorithm.html#cb47-6" tabindex="-1"></a>  numclust <span class="ot">=</span> <span class="dv">3</span></span>
<span id="cb47-7"><a href="initial-parameters-for-em-algorithm.html#cb47-7" tabindex="-1"></a>  dimdat <span class="ot">=</span> <span class="dv">3</span></span>
<span id="cb47-8"><a href="initial-parameters-for-em-algorithm.html#cb47-8" tabindex="-1"></a></span>
<span id="cb47-9"><a href="initial-parameters-for-em-algorithm.html#cb47-9" tabindex="-1"></a>  <span class="do">## Initialize a few parameters, not carefully</span></span>
<span id="cb47-10"><a href="initial-parameters-for-em-algorithm.html#cb47-10" tabindex="-1"></a>  sigma <span class="ot">=</span> <a href="initial-parameters-for-em-algorithm.html#init_sigma">init_sigma</a>(ylist, numclust) <span class="do">## (T x numclust x (dimdat x dimdat))</span></span>
<span id="cb47-11"><a href="initial-parameters-for-em-algorithm.html#cb47-11" tabindex="-1"></a>  mn <span class="ot">=</span> <a href="initial-parameters-for-em-algorithm.html#init_mn">init_mn</a>(ylist, numclust, TT, dimdat)<span class="do">##, countslist = countslist)</span></span>
<span id="cb47-12"><a href="initial-parameters-for-em-algorithm.html#cb47-12" tabindex="-1"></a>  prob <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">/</span>numclust, <span class="at">nrow =</span> TT, <span class="at">ncol =</span> numclust) <span class="do">## Initialize to all 1/K.</span></span>
<span id="cb47-13"><a href="initial-parameters-for-em-algorithm.html#cb47-13" tabindex="-1"></a></span>
<span id="cb47-14"><a href="initial-parameters-for-em-algorithm.html#cb47-14" tabindex="-1"></a>  <span class="do">## ## Calculate responsibility</span></span>
<span id="cb47-15"><a href="initial-parameters-for-em-algorithm.html#cb47-15" tabindex="-1"></a>  <span class="do">## resp = <a href="initial-parameters-for-em-algorithm.html#Estep">Estep</a>(mn = mn, sigma = sigma, prob = prob, ylist = ylist, numclust = numclust)</span></span>
<span id="cb47-16"><a href="initial-parameters-for-em-algorithm.html#cb47-16" tabindex="-1"></a></span>
<span id="cb47-17"><a href="initial-parameters-for-em-algorithm.html#cb47-17" tabindex="-1"></a>  <span class="do">## Check these things</span></span>
<span id="cb47-18"><a href="initial-parameters-for-em-algorithm.html#cb47-18" tabindex="-1"></a>  <span class="do">## testthat::expect_equal(length(resp), length(ylist))</span></span>
<span id="cb47-19"><a href="initial-parameters-for-em-algorithm.html#cb47-19" tabindex="-1"></a>  <span class="do">## ?testthat::expect_equal</span></span>
<span id="cb47-20"><a href="initial-parameters-for-em-algorithm.html#cb47-20" tabindex="-1"></a>  <span class="do">## testthat::expect_equal(sapply(resp, dim), sapply(ylist, dim), reporter = "stop")</span></span>
<span id="cb47-21"><a href="initial-parameters-for-em-algorithm.html#cb47-21" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## -- Skip (???): E step returns appropriately sized responsibilities. ------------
## Reason: empty test</code></pre>
</div>
<div id="m-step" class="section level2 hasAnchor" number="4.2">
<h2>
<span class="header-section-number">4.2</span> M step<a href="initial-parameters-for-em-algorithm.html#m-step" class="anchor-section" aria-label="Anchor link to header"></a>
</h2>
<p>The M step of the EM algorithm has three steps – one each for <span class="math inline">\(\mu\)</span>, <span class="math inline">\(\pi\)</span>, and
<span class="math inline">\(\Sigma\)</span>.</p>
<div id="m-step-for-pi" class="section level3 hasAnchor" number="4.2.1">
<h3>
<span class="header-section-number">4.2.1</span> M step for <span class="math inline">\(\pi\)</span><a href="initial-parameters-for-em-algorithm.html#m-step-for-pi" class="anchor-section" aria-label="Anchor link to header"></a>
</h3>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="initial-parameters-for-em-algorithm.html#cb49-1" tabindex="-1"></a><span class="co">#' The M step for the cluster probabilities</span></span>
<span id="cb49-2"><a href="initial-parameters-for-em-algorithm.html#cb49-2" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb49-3"><a href="initial-parameters-for-em-algorithm.html#cb49-3" tabindex="-1"></a><span class="co">#' @param resp Responsibilities.</span></span>
<span id="cb49-4"><a href="initial-parameters-for-em-algorithm.html#cb49-4" tabindex="-1"></a><span class="co">#' @param H_tf Trend filtering matrix.</span></span>
<span id="cb49-5"><a href="initial-parameters-for-em-algorithm.html#cb49-5" tabindex="-1"></a><span class="co">#' @param countslist Particle multiplicities.</span></span>
<span id="cb49-6"><a href="initial-parameters-for-em-algorithm.html#cb49-6" tabindex="-1"></a><span class="co">#' @param lambda_prob Regularization. </span></span>
<span id="cb49-7"><a href="initial-parameters-for-em-algorithm.html#cb49-7" tabindex="-1"></a><span class="co">#' @param l_prob Trend filtering degree.</span></span>
<span id="cb49-8"><a href="initial-parameters-for-em-algorithm.html#cb49-8" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb49-9"><a href="initial-parameters-for-em-algorithm.html#cb49-9" tabindex="-1"></a><span class="co">#' @return (T x k) matrix containing the alphas, for \code{prob = exp(alpha)/</span></span>
<span id="cb49-10"><a href="initial-parameters-for-em-algorithm.html#cb49-10" tabindex="-1"></a><span class="co">#'         rowSums(exp(alpha))}. </span></span>
<span id="cb49-11"><a href="initial-parameters-for-em-algorithm.html#cb49-11" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb49-12"><a href="initial-parameters-for-em-algorithm.html#cb49-12" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb49-13"><a href="initial-parameters-for-em-algorithm.html#cb49-13" tabindex="-1"></a><span id="Mstep_prob">Mstep_prob</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(resp, H_tf, <span class="at">countslist =</span> <span class="cn">NULL</span>,</span>
<span id="cb49-14"><a href="initial-parameters-for-em-algorithm.html#cb49-14" tabindex="-1"></a>                       <span class="at">lambda_prob =</span> <span class="cn">NULL</span>, <span class="at">l_prob =</span> <span class="cn">NULL</span>, <span class="at">x =</span> <span class="cn">NULL</span>){</span>
<span id="cb49-15"><a href="initial-parameters-for-em-algorithm.html#cb49-15" tabindex="-1"></a></span>
<span id="cb49-16"><a href="initial-parameters-for-em-algorithm.html#cb49-16" tabindex="-1"></a>  <span class="do">## Basic setup</span></span>
<span id="cb49-17"><a href="initial-parameters-for-em-algorithm.html#cb49-17" tabindex="-1"></a>  TT <span class="ot">&lt;-</span> <span class="fu">length</span>(resp)</span>
<span id="cb49-18"><a href="initial-parameters-for-em-algorithm.html#cb49-18" tabindex="-1"></a></span>
<span id="cb49-19"><a href="initial-parameters-for-em-algorithm.html#cb49-19" tabindex="-1"></a>  <span class="do">## Basic checks</span></span>
<span id="cb49-20"><a href="initial-parameters-for-em-algorithm.html#cb49-20" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">is.null</span>(l_prob) <span class="sc">==</span> <span class="fu">is.null</span>(lambda_prob))</span>
<span id="cb49-21"><a href="initial-parameters-for-em-algorithm.html#cb49-21" tabindex="-1"></a></span>
<span id="cb49-22"><a href="initial-parameters-for-em-algorithm.html#cb49-22" tabindex="-1"></a>  <span class="do">## If glmnet isn't actually needed, don't use it.</span></span>
<span id="cb49-23"><a href="initial-parameters-for-em-algorithm.html#cb49-23" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(l_prob) <span class="sc">&amp;</span> <span class="fu">is.null</span>(lambda_prob)){</span>
<span id="cb49-24"><a href="initial-parameters-for-em-algorithm.html#cb49-24" tabindex="-1"></a></span>
<span id="cb49-25"><a href="initial-parameters-for-em-algorithm.html#cb49-25" tabindex="-1"></a>    <span class="do">## Calculate the average responsibilities, per time point.</span></span>
<span id="cb49-26"><a href="initial-parameters-for-em-algorithm.html#cb49-26" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.null</span>(countslist)){</span>
<span id="cb49-27"><a href="initial-parameters-for-em-algorithm.html#cb49-27" tabindex="-1"></a>      resp.avg <span class="ot">&lt;-</span> <span class="fu">lapply</span>(resp, colMeans) <span class="sc">%&gt;%</span> <span class="fu">do.call</span>(rbind, .)</span>
<span id="cb49-28"><a href="initial-parameters-for-em-algorithm.html#cb49-28" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb49-29"><a href="initial-parameters-for-em-algorithm.html#cb49-29" tabindex="-1"></a>      resp.avg <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="at">FUN =</span> <span class="cf">function</span>(ii){</span>
<span id="cb49-30"><a href="initial-parameters-for-em-algorithm.html#cb49-30" tabindex="-1"></a>        <span class="fu">colSums</span>(resp[[ii]])<span class="sc">/</span><span class="fu">sum</span>(countslist[[ii]])</span>
<span id="cb49-31"><a href="initial-parameters-for-em-algorithm.html#cb49-31" tabindex="-1"></a>      }) <span class="sc">%&gt;%</span> <span class="fu">do.call</span>(rbind, .)</span>
<span id="cb49-32"><a href="initial-parameters-for-em-algorithm.html#cb49-32" tabindex="-1"></a>    }</span>
<span id="cb49-33"><a href="initial-parameters-for-em-algorithm.html#cb49-33" tabindex="-1"></a>    <span class="fu">return</span>(resp.avg) </span>
<span id="cb49-34"><a href="initial-parameters-for-em-algorithm.html#cb49-34" tabindex="-1"></a></span>
<span id="cb49-35"><a href="initial-parameters-for-em-algorithm.html#cb49-35" tabindex="-1"></a>  <span class="do">## If glmnet is needed, use it.</span></span>
<span id="cb49-36"><a href="initial-parameters-for-em-algorithm.html#cb49-36" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb49-37"><a href="initial-parameters-for-em-algorithm.html#cb49-37" tabindex="-1"></a></span>
<span id="cb49-38"><a href="initial-parameters-for-em-algorithm.html#cb49-38" tabindex="-1"></a>    <span id="lambda_range">lambda_range</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(lam, <span class="at">nlam =</span> <span class="dv">50</span>, <span class="at">lam.max =</span> <span class="dv">5</span><span class="sc">*</span>lam){</span>
<span id="cb49-39"><a href="initial-parameters-for-em-algorithm.html#cb49-39" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">exp</span>(<span class="fu">seq</span>(<span class="fu">log</span>(lam.max), <span class="fu">log</span>(lam), <span class="at">length.out =</span> nlam)))</span>
<span id="cb49-40"><a href="initial-parameters-for-em-algorithm.html#cb49-40" tabindex="-1"></a>    }</span>
<span id="cb49-41"><a href="initial-parameters-for-em-algorithm.html#cb49-41" tabindex="-1"></a></span>
<span id="cb49-42"><a href="initial-parameters-for-em-algorithm.html#cb49-42" tabindex="-1"></a>    penalty.facs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">0</span>, l_prob<span class="sc">+</span><span class="dv">1</span>), <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(H_tf) <span class="sc">-</span> l_prob <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb49-43"><a href="initial-parameters-for-em-algorithm.html#cb49-43" tabindex="-1"></a>    resp.predict <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(resp, colSums))</span>
<span id="cb49-44"><a href="initial-parameters-for-em-algorithm.html#cb49-44" tabindex="-1"></a>    glmnet_obj <span class="ot">&lt;-</span> glmnet<span class="sc">::</span><span class="fu">glmnet</span>(<span class="at">x =</span> H_tf, <span class="at">y =</span> resp.predict, <span class="at">family =</span> <span class="st">"multinomial"</span>,</span>
<span id="cb49-45"><a href="initial-parameters-for-em-algorithm.html#cb49-45" tabindex="-1"></a>                                 <span class="at">penalty.factor =</span> penalty.facs, <span class="at">maxit =</span> <span class="fl">1e7</span>,</span>
<span id="cb49-46"><a href="initial-parameters-for-em-algorithm.html#cb49-46" tabindex="-1"></a>                                 <span class="at">lambda =</span>  <span class="fu">mean</span>(penalty.facs)<span class="sc">*</span><a href="initial-parameters-for-em-algorithm.html#lambda_range">lambda_range</a>(lambda_prob),</span>
<span id="cb49-47"><a href="initial-parameters-for-em-algorithm.html#cb49-47" tabindex="-1"></a>                                 <span class="at">standardize =</span> F, <span class="at">intercept =</span> <span class="cn">FALSE</span>) </span>
<span id="cb49-48"><a href="initial-parameters-for-em-algorithm.html#cb49-48" tabindex="-1"></a>    pred_link <span class="ot">&lt;-</span> <span class="fu">predict</span>(glmnet_obj, <span class="at">newx =</span> H_tf, <span class="at">type =</span> <span class="st">"link"</span>, <span class="at">s =</span> <span class="fu">mean</span>(penalty.facs) <span class="sc">*</span> lambda_prob)[,,<span class="dv">1</span>]</span>
<span id="cb49-49"><a href="initial-parameters-for-em-algorithm.html#cb49-49" tabindex="-1"></a>    <span class="fu">return</span>(pred_link)</span>
<span id="cb49-50"><a href="initial-parameters-for-em-algorithm.html#cb49-50" tabindex="-1"></a>  }</span>
<span id="cb49-51"><a href="initial-parameters-for-em-algorithm.html#cb49-51" tabindex="-1"></a>}</span></code></pre></div>
<p>This should return a <span class="math inline">\(T\)</span> by <span class="math inline">\(K\)</span> matrix, which we’ll test here:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="initial-parameters-for-em-algorithm.html#cb50-1" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">"Mstep of pi returns a (T x K) matrix."</span>, {</span>
<span id="cb50-2"><a href="initial-parameters-for-em-algorithm.html#cb50-2" tabindex="-1"></a></span>
<span id="cb50-3"><a href="initial-parameters-for-em-algorithm.html#cb50-3" tabindex="-1"></a>  <span class="do">## Generate some fake responsibilities and trend filtering matrix</span></span>
<span id="cb50-4"><a href="initial-parameters-for-em-algorithm.html#cb50-4" tabindex="-1"></a>  TT <span class="ot">=</span> <span class="dv">100</span></span>
<span id="cb50-5"><a href="initial-parameters-for-em-algorithm.html#cb50-5" tabindex="-1"></a>  numclust <span class="ot">=</span> <span class="dv">3</span></span>
<span id="cb50-6"><a href="initial-parameters-for-em-algorithm.html#cb50-6" tabindex="-1"></a>  nt <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb50-7"><a href="initial-parameters-for-em-algorithm.html#cb50-7" tabindex="-1"></a>  resp <span class="ot">=</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="cf">function</span>(tt){</span>
<span id="cb50-8"><a href="initial-parameters-for-em-algorithm.html#cb50-8" tabindex="-1"></a>    oneresp <span class="ot">=</span> <span class="fu">runif</span>(nt<span class="sc">*</span>numclust) <span class="sc">%&gt;%</span> <span class="fu">matrix</span>(<span class="at">ncol=</span>numclust)</span>
<span id="cb50-9"><a href="initial-parameters-for-em-algorithm.html#cb50-9" tabindex="-1"></a>    oneresp <span class="ot">=</span> oneresp<span class="sc">/</span><span class="fu">rowSums</span>(oneresp)</span>
<span id="cb50-10"><a href="initial-parameters-for-em-algorithm.html#cb50-10" tabindex="-1"></a>  })</span>
<span id="cb50-11"><a href="initial-parameters-for-em-algorithm.html#cb50-11" tabindex="-1"></a>  H_tf <span class="ot">&lt;-</span> <a href="package-setup.html#gen_tf_mat">gen_tf_mat</a>(<span class="at">n =</span> TT, <span class="at">k =</span> <span class="dv">0</span>)</span>
<span id="cb50-12"><a href="initial-parameters-for-em-algorithm.html#cb50-12" tabindex="-1"></a></span>
<span id="cb50-13"><a href="initial-parameters-for-em-algorithm.html#cb50-13" tabindex="-1"></a>  <span class="do">## Check the size</span></span>
<span id="cb50-14"><a href="initial-parameters-for-em-algorithm.html#cb50-14" tabindex="-1"></a>  pred_link <span class="ot">=</span> <a href="initial-parameters-for-em-algorithm.html#Mstep_prob">Mstep_prob</a>(resp, H_tf, <span class="at">l_prob =</span> <span class="dv">0</span>, <span class="at">lambda_prob =</span> <span class="fl">1E-3</span>)</span>
<span id="cb50-15"><a href="initial-parameters-for-em-algorithm.html#cb50-15" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">dim</span>(pred_link), <span class="fu">c</span>(TT, numclust))</span>
<span id="cb50-16"><a href="initial-parameters-for-em-algorithm.html#cb50-16" tabindex="-1"></a>  pred_link <span class="ot">=</span> <a href="initial-parameters-for-em-algorithm.html#Mstep_prob">Mstep_prob</a>(resp, H_tf)</span>
<span id="cb50-17"><a href="initial-parameters-for-em-algorithm.html#cb50-17" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">dim</span>(pred_link), <span class="fu">c</span>(TT, numclust))</span>
<span id="cb50-18"><a href="initial-parameters-for-em-algorithm.html#cb50-18" tabindex="-1"></a></span>
<span id="cb50-19"><a href="initial-parameters-for-em-algorithm.html#cb50-19" tabindex="-1"></a>  <span class="do">## Check the correctness</span></span>
<span id="cb50-20"><a href="initial-parameters-for-em-algorithm.html#cb50-20" tabindex="-1"></a>  pred_link <span class="ot">=</span> <a href="initial-parameters-for-em-algorithm.html#Mstep_prob">Mstep_prob</a>(resp, H_tf)</span>
<span id="cb50-21"><a href="initial-parameters-for-em-algorithm.html#cb50-21" tabindex="-1"></a>})</span></code></pre></div>
<p>Each row of this matrix should contain the fitted values <span class="math inline">\(\alpha_k \in
\mathbb{R}^3\)</span> where <span class="math inline">\(\alpha_{kt} = h_t^T w_{k}\)</span>, for..</p>
<ul>
<li><p><span class="math inline">\(h_t\)</span> that are rows of the trend filtering matrix <span class="math inline">\(H \in \mathbb{R}^{T \times
T}\)</span>.</p></li>
<li><p><span class="math inline">\(w_k \in \mathbb{R}^{n}\)</span> that are the regression coefficients estimated by
<code>glmnet()</code>.</p></li>
</ul>
<p>Here is a test for the correctness of the M step for <span class="math inline">\(\pi\)</span>.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="initial-parameters-for-em-algorithm.html#cb51-1" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">"Test the M step of \pi against CVXR"</span>, {})</span></code></pre></div>
</div>
<div id="m-step-for-sigma" class="section level3 hasAnchor" number="4.2.2">
<h3>
<span class="header-section-number">4.2.2</span> M step for <span class="math inline">\(\Sigma\)</span><a href="initial-parameters-for-em-algorithm.html#m-step-for-sigma" class="anchor-section" aria-label="Anchor link to header"></a>
</h3>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="initial-parameters-for-em-algorithm.html#cb52-1" tabindex="-1"></a><span class="co">#' M step for cluster covariance (sigma).</span></span>
<span id="cb52-2"><a href="initial-parameters-for-em-algorithm.html#cb52-2" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb52-3"><a href="initial-parameters-for-em-algorithm.html#cb52-3" tabindex="-1"></a><span class="co">#' @param resp Responsibility.</span></span>
<span id="cb52-4"><a href="initial-parameters-for-em-algorithm.html#cb52-4" tabindex="-1"></a><span class="co">#' @param ylist Data.</span></span>
<span id="cb52-5"><a href="initial-parameters-for-em-algorithm.html#cb52-5" tabindex="-1"></a><span class="co">#' @param mn Means</span></span>
<span id="cb52-6"><a href="initial-parameters-for-em-algorithm.html#cb52-6" tabindex="-1"></a><span class="co">#' @param numclust Number of clusters.</span></span>
<span id="cb52-7"><a href="initial-parameters-for-em-algorithm.html#cb52-7" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb52-8"><a href="initial-parameters-for-em-algorithm.html#cb52-8" tabindex="-1"></a><span class="co">#' @return (K x d x d) array containing K (d x d) covariance matrices.</span></span>
<span id="cb52-9"><a href="initial-parameters-for-em-algorithm.html#cb52-9" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb52-10"><a href="initial-parameters-for-em-algorithm.html#cb52-10" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb52-11"><a href="initial-parameters-for-em-algorithm.html#cb52-11" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb52-12"><a href="initial-parameters-for-em-algorithm.html#cb52-12" tabindex="-1"></a><span id="Mstep_sigma">Mstep_sigma</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(resp, ylist, mn, numclust){</span>
<span id="cb52-13"><a href="initial-parameters-for-em-algorithm.html#cb52-13" tabindex="-1"></a></span>
<span id="cb52-14"><a href="initial-parameters-for-em-algorithm.html#cb52-14" tabindex="-1"></a>  <span class="do">## Find some sizes</span></span>
<span id="cb52-15"><a href="initial-parameters-for-em-algorithm.html#cb52-15" tabindex="-1"></a>  TT <span class="ot">=</span> <span class="fu">length</span>(ylist)</span>
<span id="cb52-16"><a href="initial-parameters-for-em-algorithm.html#cb52-16" tabindex="-1"></a>  ntlist <span class="ot">=</span> <span class="fu">sapply</span>(ylist, nrow)</span>
<span id="cb52-17"><a href="initial-parameters-for-em-algorithm.html#cb52-17" tabindex="-1"></a>  dimdat <span class="ot">=</span> <span class="fu">ncol</span>(ylist[[<span class="dv">1</span>]])</span>
<span id="cb52-18"><a href="initial-parameters-for-em-algorithm.html#cb52-18" tabindex="-1"></a>  cs <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">cumsum</span>(ntlist))</span>
<span id="cb52-19"><a href="initial-parameters-for-em-algorithm.html#cb52-19" tabindex="-1"></a></span>
<span id="cb52-20"><a href="initial-parameters-for-em-algorithm.html#cb52-20" tabindex="-1"></a>  <span class="do">## Set up empty residual matrix (to be reused)</span></span>
<span id="cb52-21"><a href="initial-parameters-for-em-algorithm.html#cb52-21" tabindex="-1"></a>  cs <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">cumsum</span>(ntlist))</span>
<span id="cb52-22"><a href="initial-parameters-for-em-algorithm.html#cb52-22" tabindex="-1"></a>  vars <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">"list"</span>, numclust)</span>
<span id="cb52-23"><a href="initial-parameters-for-em-algorithm.html#cb52-23" tabindex="-1"></a>  ylong <span class="ot">=</span> <span class="fu">do.call</span>(rbind, ylist)</span>
<span id="cb52-24"><a href="initial-parameters-for-em-algorithm.html#cb52-24" tabindex="-1"></a>  ntlist <span class="ot">=</span> <span class="fu">sapply</span>(ylist, nrow)</span>
<span id="cb52-25"><a href="initial-parameters-for-em-algorithm.html#cb52-25" tabindex="-1"></a>  irows <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(mn), <span class="at">times =</span> ntlist)</span>
<span id="cb52-26"><a href="initial-parameters-for-em-algorithm.html#cb52-26" tabindex="-1"></a></span>
<span id="cb52-27"><a href="initial-parameters-for-em-algorithm.html#cb52-27" tabindex="-1"></a>  <span class="cf">for</span>(iclust <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>numclust){</span>
<span id="cb52-28"><a href="initial-parameters-for-em-algorithm.html#cb52-28" tabindex="-1"></a>    resp.thisclust <span class="ot">=</span> <span class="fu">lapply</span>(resp, <span class="cf">function</span>(myresp) myresp[,iclust, <span class="at">drop =</span> <span class="cn">TRUE</span>])</span>
<span id="cb52-29"><a href="initial-parameters-for-em-algorithm.html#cb52-29" tabindex="-1"></a>    resp.long <span class="ot">=</span> <span class="fu">do.call</span>(c, resp.thisclust)</span>
<span id="cb52-30"><a href="initial-parameters-for-em-algorithm.html#cb52-30" tabindex="-1"></a>    mnlong <span class="ot">=</span> mn[irows,,iclust]</span>
<span id="cb52-31"><a href="initial-parameters-for-em-algorithm.html#cb52-31" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.vector</span>(mnlong)) mnlong <span class="ot">=</span> mnlong <span class="sc">%&gt;%</span> <span class="fu">cbind</span>()</span>
<span id="cb52-32"><a href="initial-parameters-for-em-algorithm.html#cb52-32" tabindex="-1"></a>    resid <span class="ot">&lt;-</span> ylong <span class="sc">-</span> mnlong</span>
<span id="cb52-33"><a href="initial-parameters-for-em-algorithm.html#cb52-33" tabindex="-1"></a>    resid_weighted <span class="ot">&lt;-</span> resp.long <span class="sc">*</span> resid</span>
<span id="cb52-34"><a href="initial-parameters-for-em-algorithm.html#cb52-34" tabindex="-1"></a>    sig_temp <span class="ot">&lt;-</span> <span class="fu">t</span>(resid_weighted) <span class="sc">%*%</span> resid<span class="sc">/</span><span class="fu">sum</span>(resp.long)</span>
<span id="cb52-35"><a href="initial-parameters-for-em-algorithm.html#cb52-35" tabindex="-1"></a>    vars[[iclust]] <span class="ot">&lt;-</span> sig_temp</span>
<span id="cb52-36"><a href="initial-parameters-for-em-algorithm.html#cb52-36" tabindex="-1"></a>  }</span>
<span id="cb52-37"><a href="initial-parameters-for-em-algorithm.html#cb52-37" tabindex="-1"></a></span>
<span id="cb52-38"><a href="initial-parameters-for-em-algorithm.html#cb52-38" tabindex="-1"></a>  <span class="do">## Make into an array</span></span>
<span id="cb52-39"><a href="initial-parameters-for-em-algorithm.html#cb52-39" tabindex="-1"></a>  sigma_array <span class="ot">=</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim=</span><span class="fu">c</span>(numclust, dimdat, dimdat))</span>
<span id="cb52-40"><a href="initial-parameters-for-em-algorithm.html#cb52-40" tabindex="-1"></a>  <span class="cf">for</span>(iclust <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>numclust){</span>
<span id="cb52-41"><a href="initial-parameters-for-em-algorithm.html#cb52-41" tabindex="-1"></a>    sigma_array[iclust,,] <span class="ot">=</span> vars[[iclust]]</span>
<span id="cb52-42"><a href="initial-parameters-for-em-algorithm.html#cb52-42" tabindex="-1"></a>  }</span>
<span id="cb52-43"><a href="initial-parameters-for-em-algorithm.html#cb52-43" tabindex="-1"></a></span>
<span id="cb52-44"><a href="initial-parameters-for-em-algorithm.html#cb52-44" tabindex="-1"></a>  <span class="do">## Basic check</span></span>
<span id="cb52-45"><a href="initial-parameters-for-em-algorithm.html#cb52-45" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="fu">dim</span>(sigma_array) <span class="sc">==</span> <span class="fu">c</span>(numclust, dimdat, dimdat)))</span>
<span id="cb52-46"><a href="initial-parameters-for-em-algorithm.html#cb52-46" tabindex="-1"></a>  <span class="fu">return</span>(sigma_array)</span>
<span id="cb52-47"><a href="initial-parameters-for-em-algorithm.html#cb52-47" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="m-step-for-mu" class="section level3 hasAnchor" number="4.2.3">
<h3>
<span class="header-section-number">4.2.3</span> M step for <span class="math inline">\(\mu\)</span><a href="initial-parameters-for-em-algorithm.html#m-step-for-mu" class="anchor-section" aria-label="Anchor link to header"></a>
</h3>
<p>This is a big one. It uses the ADMM algorithm as written in section OO (TODO:
fill in) of the paper, reproduced briefly here.</p>
<p>We need a convergence checker for the outer layer of LA-ADMM, which checks
whether the objective values have plateaued.</p>
<p>Next, we define the main function <code><a href="initial-parameters-for-em-algorithm.html#Mstep_mu">Mstep_mu</a>()</code>. This uses a “locally-adaptive” ADMM <a href="https://proceedings.neurips.cc/paper_files/paper/2017/file/e97ee2054defb209c35fe4dc94599061-Paper.pdf">paper</a>. <code>M-step_mu()</code> calls <code><a href="initial-parameters-for-em-algorithm.html#la_admm_oneclust">la_admm_oneclust</a>()</code> on each cluster <span class="math inline">\(k=1,\cdots, K\)</span>; this function will be introduced shortly.</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="initial-parameters-for-em-algorithm.html#cb53-1" tabindex="-1"></a><span class="co">#' Computes the M step for mu. </span><span class="al">TODO</span><span class="co">: use templates for the argument. As shown</span></span>
<span id="cb53-2"><a href="initial-parameters-for-em-algorithm.html#cb53-2" tabindex="-1"></a><span class="co">#' here:</span></span>
<span id="cb53-3"><a href="initial-parameters-for-em-algorithm.html#cb53-3" tabindex="-1"></a><span class="co">#' https://stackoverflow.com/questions/15100129/using-roxygen2-template-tags</span></span>
<span id="cb53-4"><a href="initial-parameters-for-em-algorithm.html#cb53-4" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb53-5"><a href="initial-parameters-for-em-algorithm.html#cb53-5" tabindex="-1"></a><span class="co">#' @param resp Responsbilities of each particle.</span></span>
<span id="cb53-6"><a href="initial-parameters-for-em-algorithm.html#cb53-6" tabindex="-1"></a><span class="co">#' @param ylist </span></span>
<span id="cb53-7"><a href="initial-parameters-for-em-algorithm.html#cb53-7" tabindex="-1"></a><span class="co">#' @param lambda</span></span>
<span id="cb53-8"><a href="initial-parameters-for-em-algorithm.html#cb53-8" tabindex="-1"></a><span class="co">#' @param l</span></span>
<span id="cb53-9"><a href="initial-parameters-for-em-algorithm.html#cb53-9" tabindex="-1"></a><span class="co">#' @param sigma</span></span>
<span id="cb53-10"><a href="initial-parameters-for-em-algorithm.html#cb53-10" tabindex="-1"></a><span class="co">#' @param sigma_eig_by_clust</span></span>
<span id="cb53-11"><a href="initial-parameters-for-em-algorithm.html#cb53-11" tabindex="-1"></a><span class="co">#' @param Dl</span></span>
<span id="cb53-12"><a href="initial-parameters-for-em-algorithm.html#cb53-12" tabindex="-1"></a><span class="co">#' @param Dlp1</span></span>
<span id="cb53-13"><a href="initial-parameters-for-em-algorithm.html#cb53-13" tabindex="-1"></a><span class="co">#' @param TT</span></span>
<span id="cb53-14"><a href="initial-parameters-for-em-algorithm.html#cb53-14" tabindex="-1"></a><span class="co">#' @param N</span></span>
<span id="cb53-15"><a href="initial-parameters-for-em-algorithm.html#cb53-15" tabindex="-1"></a><span class="co">#' @param dimdat</span></span>
<span id="cb53-16"><a href="initial-parameters-for-em-algorithm.html#cb53-16" tabindex="-1"></a><span class="co">#' @param first_iter</span></span>
<span id="cb53-17"><a href="initial-parameters-for-em-algorithm.html#cb53-17" tabindex="-1"></a><span class="co">#' @param mus</span></span>
<span id="cb53-18"><a href="initial-parameters-for-em-algorithm.html#cb53-18" tabindex="-1"></a><span class="co">#' @param Zs</span></span>
<span id="cb53-19"><a href="initial-parameters-for-em-algorithm.html#cb53-19" tabindex="-1"></a><span class="co">#' @param Ws</span></span>
<span id="cb53-20"><a href="initial-parameters-for-em-algorithm.html#cb53-20" tabindex="-1"></a><span class="co">#' @param uws</span></span>
<span id="cb53-21"><a href="initial-parameters-for-em-algorithm.html#cb53-21" tabindex="-1"></a><span class="co">#' @param uzs</span></span>
<span id="cb53-22"><a href="initial-parameters-for-em-algorithm.html#cb53-22" tabindex="-1"></a><span class="co">#' @param maxdev</span></span>
<span id="cb53-23"><a href="initial-parameters-for-em-algorithm.html#cb53-23" tabindex="-1"></a><span class="co">#' @param x</span></span>
<span id="cb53-24"><a href="initial-parameters-for-em-algorithm.html#cb53-24" tabindex="-1"></a><span class="co">#' @param niter</span></span>
<span id="cb53-25"><a href="initial-parameters-for-em-algorithm.html#cb53-25" tabindex="-1"></a><span class="co">#' @param err_rel</span></span>
<span id="cb53-26"><a href="initial-parameters-for-em-algorithm.html#cb53-26" tabindex="-1"></a><span class="co">#' @param err_abs</span></span>
<span id="cb53-27"><a href="initial-parameters-for-em-algorithm.html#cb53-27" tabindex="-1"></a><span class="co">#' @param zerothresh</span></span>
<span id="cb53-28"><a href="initial-parameters-for-em-algorithm.html#cb53-28" tabindex="-1"></a><span class="co">#' @param local_adapt</span></span>
<span id="cb53-29"><a href="initial-parameters-for-em-algorithm.html#cb53-29" tabindex="-1"></a><span class="co">#' @param local_adapt_niter</span></span>
<span id="cb53-30"><a href="initial-parameters-for-em-algorithm.html#cb53-30" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb53-31"><a href="initial-parameters-for-em-algorithm.html#cb53-31" tabindex="-1"></a><span class="co">#' @return</span></span>
<span id="cb53-32"><a href="initial-parameters-for-em-algorithm.html#cb53-32" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb53-33"><a href="initial-parameters-for-em-algorithm.html#cb53-33" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb53-34"><a href="initial-parameters-for-em-algorithm.html#cb53-34" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb53-35"><a href="initial-parameters-for-em-algorithm.html#cb53-35" tabindex="-1"></a><span id="Mstep_mu">Mstep_mu</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(resp,</span>
<span id="cb53-36"><a href="initial-parameters-for-em-algorithm.html#cb53-36" tabindex="-1"></a>                     ylist,  </span>
<span id="cb53-37"><a href="initial-parameters-for-em-algorithm.html#cb53-37" tabindex="-1"></a>                     <span class="at">lambda =</span> <span class="fl">0.5</span>,</span>
<span id="cb53-38"><a href="initial-parameters-for-em-algorithm.html#cb53-38" tabindex="-1"></a>                     <span class="at">l =</span> <span class="dv">3</span>,</span>
<span id="cb53-39"><a href="initial-parameters-for-em-algorithm.html#cb53-39" tabindex="-1"></a>                     sigma,</span>
<span id="cb53-40"><a href="initial-parameters-for-em-algorithm.html#cb53-40" tabindex="-1"></a>                     <span class="at">sigma_eig_by_clust =</span> <span class="cn">NULL</span>,</span>
<span id="cb53-41"><a href="initial-parameters-for-em-algorithm.html#cb53-41" tabindex="-1"></a>                     Dlsqrd,</span>
<span id="cb53-42"><a href="initial-parameters-for-em-algorithm.html#cb53-42" tabindex="-1"></a>                     Dl, tDl, Dlp1,  TT, N, dimdat,</span>
<span id="cb53-43"><a href="initial-parameters-for-em-algorithm.html#cb53-43" tabindex="-1"></a>                     <span class="at">first_iter =</span> <span class="cn">TRUE</span>,</span>
<span id="cb53-44"><a href="initial-parameters-for-em-algorithm.html#cb53-44" tabindex="-1"></a>                     e_mat,</span>
<span id="cb53-45"><a href="initial-parameters-for-em-algorithm.html#cb53-45" tabindex="-1"></a></span>
<span id="cb53-46"><a href="initial-parameters-for-em-algorithm.html#cb53-46" tabindex="-1"></a>                     <span class="do">## Warm startable variables</span></span>
<span id="cb53-47"><a href="initial-parameters-for-em-algorithm.html#cb53-47" tabindex="-1"></a>                     <span class="at">mus =</span> <span class="cn">NULL</span>,</span>
<span id="cb53-48"><a href="initial-parameters-for-em-algorithm.html#cb53-48" tabindex="-1"></a>                     <span class="at">Zs =</span> <span class="cn">NULL</span>,</span>
<span id="cb53-49"><a href="initial-parameters-for-em-algorithm.html#cb53-49" tabindex="-1"></a>                     <span class="at">Ws =</span> <span class="cn">NULL</span>,</span>
<span id="cb53-50"><a href="initial-parameters-for-em-algorithm.html#cb53-50" tabindex="-1"></a>                     <span class="at">uws =</span> <span class="cn">NULL</span>,</span>
<span id="cb53-51"><a href="initial-parameters-for-em-algorithm.html#cb53-51" tabindex="-1"></a>                     <span class="at">uzs =</span> <span class="cn">NULL</span>,</span>
<span id="cb53-52"><a href="initial-parameters-for-em-algorithm.html#cb53-52" tabindex="-1"></a>                     <span class="do">## End of warm startable variables</span></span>
<span id="cb53-53"><a href="initial-parameters-for-em-algorithm.html#cb53-53" tabindex="-1"></a></span>
<span id="cb53-54"><a href="initial-parameters-for-em-algorithm.html#cb53-54" tabindex="-1"></a>                     <span class="at">maxdev =</span> <span class="cn">NULL</span>,</span>
<span id="cb53-55"><a href="initial-parameters-for-em-algorithm.html#cb53-55" tabindex="-1"></a>                     <span class="at">x =</span> <span class="cn">NULL</span>,</span>
<span id="cb53-56"><a href="initial-parameters-for-em-algorithm.html#cb53-56" tabindex="-1"></a>                     <span class="at">niter =</span> (<span class="cf">if</span>(local_adapt) <span class="fl">1e2</span> <span class="cf">else</span> <span class="fl">1e3</span>),</span>
<span id="cb53-57"><a href="initial-parameters-for-em-algorithm.html#cb53-57" tabindex="-1"></a>                     <span class="at">err_rel =</span> <span class="fl">1E-3</span>,</span>
<span id="cb53-58"><a href="initial-parameters-for-em-algorithm.html#cb53-58" tabindex="-1"></a>                     <span class="at">err_abs =</span> <span class="dv">0</span>,</span>
<span id="cb53-59"><a href="initial-parameters-for-em-algorithm.html#cb53-59" tabindex="-1"></a>                     <span class="at">zerothresh =</span> <span class="fl">1E-6</span>,</span>
<span id="cb53-60"><a href="initial-parameters-for-em-algorithm.html#cb53-60" tabindex="-1"></a>                     <span class="at">local_adapt =</span> <span class="cn">FALSE</span>,</span>
<span id="cb53-61"><a href="initial-parameters-for-em-algorithm.html#cb53-61" tabindex="-1"></a>                     <span class="at">local_adapt_niter =</span> <span class="dv">10</span>,</span>
<span id="cb53-62"><a href="initial-parameters-for-em-algorithm.html#cb53-62" tabindex="-1"></a>                     <span class="at">rho_init =</span> <span class="fl">0.01</span>,</span>
<span id="cb53-63"><a href="initial-parameters-for-em-algorithm.html#cb53-63" tabindex="-1"></a>                     <span class="at">iter =</span> <span class="cn">NULL</span>){</span>
<span id="cb53-64"><a href="initial-parameters-for-em-algorithm.html#cb53-64" tabindex="-1"></a></span>
<span id="cb53-65"><a href="initial-parameters-for-em-algorithm.html#cb53-65" tabindex="-1"></a>  <span class="do">####################</span></span>
<span id="cb53-66"><a href="initial-parameters-for-em-algorithm.html#cb53-66" tabindex="-1"></a>  <span class="do">## Preliminaries </span><span class="al">###</span></span>
<span id="cb53-67"><a href="initial-parameters-for-em-algorithm.html#cb53-67" tabindex="-1"></a>  <span class="do">####################</span></span>
<span id="cb53-68"><a href="initial-parameters-for-em-algorithm.html#cb53-68" tabindex="-1"></a>  TT <span class="ot">=</span> <span class="fu">length</span>(ylist)</span>
<span id="cb53-69"><a href="initial-parameters-for-em-algorithm.html#cb53-69" tabindex="-1"></a>  numclust <span class="ot">=</span> <span class="fu">ncol</span>(resp[[<span class="dv">1</span>]])</span>
<span id="cb53-70"><a href="initial-parameters-for-em-algorithm.html#cb53-70" tabindex="-1"></a>  dimdat <span class="ot">=</span> <span class="fu">ncol</span>(ylist[[<span class="dv">1</span>]])</span>
<span id="cb53-71"><a href="initial-parameters-for-em-algorithm.html#cb53-71" tabindex="-1"></a>  ntlist <span class="ot">=</span> <span class="fu">sapply</span>(ylist, nrow)</span>
<span id="cb53-72"><a href="initial-parameters-for-em-algorithm.html#cb53-72" tabindex="-1"></a>  resp.sum <span class="ot">=</span> <span class="fu">lapply</span>(resp, colSums) <span class="sc">%&gt;%</span> <span class="fu">do.call</span>(rbind, .)</span>
<span id="cb53-73"><a href="initial-parameters-for-em-algorithm.html#cb53-73" tabindex="-1"></a>  N <span class="ot">=</span> <span class="fu">sum</span>(<span class="fu">unlist</span>(resp.sum))</span>
<span id="cb53-74"><a href="initial-parameters-for-em-algorithm.html#cb53-74" tabindex="-1"></a></span>
<span id="cb53-75"><a href="initial-parameters-for-em-algorithm.html#cb53-75" tabindex="-1"></a>  <span class="do">## Other preliminaries</span></span>
<span id="cb53-76"><a href="initial-parameters-for-em-algorithm.html#cb53-76" tabindex="-1"></a>  schur_syl_A_by_clust <span class="ot">=</span> schur_syl_B_by_clust <span class="ot">=</span> term3list <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb53-77"><a href="initial-parameters-for-em-algorithm.html#cb53-77" tabindex="-1"></a>  ybarlist <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb53-78"><a href="initial-parameters-for-em-algorithm.html#cb53-78" tabindex="-1"></a>  ycentered_list <span class="ot">=</span> Xcentered_list <span class="ot">=</span> yXcentered_list <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb53-79"><a href="initial-parameters-for-em-algorithm.html#cb53-79" tabindex="-1"></a>  Qlist <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb53-80"><a href="initial-parameters-for-em-algorithm.html#cb53-80" tabindex="-1"></a>  sigmainv_list <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb53-81"><a href="initial-parameters-for-em-algorithm.html#cb53-81" tabindex="-1"></a>  <span class="cf">for</span>(iclust <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>numclust){</span>
<span id="cb53-82"><a href="initial-parameters-for-em-algorithm.html#cb53-82" tabindex="-1"></a></span>
<span id="cb53-83"><a href="initial-parameters-for-em-algorithm.html#cb53-83" tabindex="-1"></a>    <span class="do">## Retrieve sigma inverse from pre-computed SVD, if necessary</span></span>
<span id="cb53-84"><a href="initial-parameters-for-em-algorithm.html#cb53-84" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.null</span>(sigma_eig_by_clust)){</span>
<span id="cb53-85"><a href="initial-parameters-for-em-algorithm.html#cb53-85" tabindex="-1"></a>      sigmainv <span class="ot">=</span> <span class="fu">solve</span>(sigma[iclust,,])</span>
<span id="cb53-86"><a href="initial-parameters-for-em-algorithm.html#cb53-86" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb53-87"><a href="initial-parameters-for-em-algorithm.html#cb53-87" tabindex="-1"></a>      sigmainv <span class="ot">=</span> sigma_eig_by_clust[[iclust]]<span class="sc">$</span>sigma_inv</span>
<span id="cb53-88"><a href="initial-parameters-for-em-algorithm.html#cb53-88" tabindex="-1"></a>    }</span>
<span id="cb53-89"><a href="initial-parameters-for-em-algorithm.html#cb53-89" tabindex="-1"></a></span>
<span id="cb53-90"><a href="initial-parameters-for-em-algorithm.html#cb53-90" tabindex="-1"></a>    resp.iclust <span class="ot">&lt;-</span> <span class="fu">lapply</span>(resp, <span class="at">FUN =</span> <span class="cf">function</span>(r) <span class="fu">matrix</span>(r[,iclust]))</span>
<span id="cb53-91"><a href="initial-parameters-for-em-algorithm.html#cb53-91" tabindex="-1"></a></span>
<span id="cb53-92"><a href="initial-parameters-for-em-algorithm.html#cb53-92" tabindex="-1"></a>    AB <span class="ot">&lt;-</span> <a href="initial-parameters-for-em-algorithm.html#get_AB_mats">get_AB_mats</a>(<span class="at">y =</span> y, <span class="at">resp =</span> resp.iclust, <span class="at">Sigma_inv =</span> sigmainv,</span>
<span id="cb53-93"><a href="initial-parameters-for-em-algorithm.html#cb53-93" tabindex="-1"></a>                      <span class="at">e_mat =</span> e_mat, <span class="at">N =</span> N, <span class="at">Dlp1 =</span> Dlp1, <span class="at">Dl =</span> Dl,</span>
<span id="cb53-94"><a href="initial-parameters-for-em-algorithm.html#cb53-94" tabindex="-1"></a>                      <span class="at">Dlsqrd =</span> Dlsqrd, <span class="at">rho =</span> rho_init, <span class="at">z =</span> <span class="cn">NULL</span>, <span class="at">w =</span> <span class="cn">NULL</span>,</span>
<span id="cb53-95"><a href="initial-parameters-for-em-algorithm.html#cb53-95" tabindex="-1"></a>                      <span class="at">uz =</span> <span class="cn">NULL</span>, <span class="at">uw =</span> <span class="cn">NULL</span>)</span>
<span id="cb53-96"><a href="initial-parameters-for-em-algorithm.html#cb53-96" tabindex="-1"></a></span>
<span id="cb53-97"><a href="initial-parameters-for-em-algorithm.html#cb53-97" tabindex="-1"></a>    <span class="do">## Store the Schur decomposition</span></span>
<span id="cb53-98"><a href="initial-parameters-for-em-algorithm.html#cb53-98" tabindex="-1"></a>    schur_syl_A_by_clust[[iclust]] <span class="ot">=</span> <a href="initial-parameters-for-em-algorithm.html#myschur">myschur</a>(AB<span class="sc">$</span>A)</span>
<span id="cb53-99"><a href="initial-parameters-for-em-algorithm.html#cb53-99" tabindex="-1"></a>    schur_syl_B_by_clust[[iclust]] <span class="ot">=</span> <a href="initial-parameters-for-em-algorithm.html#myschur">myschur</a>(AB<span class="sc">$</span>B)</span>
<span id="cb53-100"><a href="initial-parameters-for-em-algorithm.html#cb53-100" tabindex="-1"></a></span>
<span id="cb53-101"><a href="initial-parameters-for-em-algorithm.html#cb53-101" tabindex="-1"></a>    ycentered <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb53-102"><a href="initial-parameters-for-em-algorithm.html#cb53-102" tabindex="-1"></a>    ycentered_list[[iclust]] <span class="ot">=</span> ycentered</span>
<span id="cb53-103"><a href="initial-parameters-for-em-algorithm.html#cb53-103" tabindex="-1"></a>    sigmainv_list[[iclust]] <span class="ot">=</span> sigmainv</span>
<span id="cb53-104"><a href="initial-parameters-for-em-algorithm.html#cb53-104" tabindex="-1"></a>  }</span>
<span id="cb53-105"><a href="initial-parameters-for-em-algorithm.html#cb53-105" tabindex="-1"></a></span>
<span id="cb53-106"><a href="initial-parameters-for-em-algorithm.html#cb53-106" tabindex="-1"></a>  <span class="do">##########################################</span></span>
<span id="cb53-107"><a href="initial-parameters-for-em-algorithm.html#cb53-107" tabindex="-1"></a>  <span class="do">## Run ADMM separately on each cluster ##</span></span>
<span id="cb53-108"><a href="initial-parameters-for-em-algorithm.html#cb53-108" tabindex="-1"></a>  <span class="do">#########################################</span></span>
<span id="cb53-109"><a href="initial-parameters-for-em-algorithm.html#cb53-109" tabindex="-1"></a>  admm_niters <span class="ot">=</span> admm_inner_iters <span class="ot">=</span> <span class="fu">vector</span>(<span class="at">length =</span> numclust, <span class="at">mode =</span> <span class="st">"list"</span>)</span>
<span id="cb53-110"><a href="initial-parameters-for-em-algorithm.html#cb53-110" tabindex="-1"></a>  <span class="cf">if</span>(first_iter) mus <span class="ot">=</span> <span class="fu">vector</span>(<span class="at">length =</span> numclust, <span class="at">mode =</span> <span class="st">"list"</span>)</span>
<span id="cb53-111"><a href="initial-parameters-for-em-algorithm.html#cb53-111" tabindex="-1"></a> <span class="co"># if(first_iter){</span></span>
<span id="cb53-112"><a href="initial-parameters-for-em-algorithm.html#cb53-112" tabindex="-1"></a>    Zs <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>numclust, <span class="cf">function</span>(x) <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> TT, <span class="at">ncol =</span> dimdat))</span>
<span id="cb53-113"><a href="initial-parameters-for-em-algorithm.html#cb53-113" tabindex="-1"></a>    Ws <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>numclust, <span class="cf">function</span>(x) <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> TT <span class="sc">-</span> l, <span class="at">ncol =</span> dimdat))</span>
<span id="cb53-114"><a href="initial-parameters-for-em-algorithm.html#cb53-114" tabindex="-1"></a>    uzs <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>numclust, <span class="cf">function</span>(x) <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> TT, <span class="at">ncol =</span> dimdat))</span>
<span id="cb53-115"><a href="initial-parameters-for-em-algorithm.html#cb53-115" tabindex="-1"></a>    uws <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>numclust, <span class="cf">function</span>(x) <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> TT <span class="sc">-</span> l, <span class="at">ncol =</span> dimdat))</span>
<span id="cb53-116"><a href="initial-parameters-for-em-algorithm.html#cb53-116" tabindex="-1"></a></span>
<span id="cb53-117"><a href="initial-parameters-for-em-algorithm.html#cb53-117" tabindex="-1"></a>   <span class="co"># Zs =  Ws =  Us  = vector(length = numclust, mode = "list")</span></span>
<span id="cb53-118"><a href="initial-parameters-for-em-algorithm.html#cb53-118" tabindex="-1"></a> <span class="co"># }</span></span>
<span id="cb53-119"><a href="initial-parameters-for-em-algorithm.html#cb53-119" tabindex="-1"></a></span>
<span id="cb53-120"><a href="initial-parameters-for-em-algorithm.html#cb53-120" tabindex="-1"></a>  <span class="do">## For every cluster, run LA-ADMM</span></span>
<span id="cb53-121"><a href="initial-parameters-for-em-algorithm.html#cb53-121" tabindex="-1"></a>  start.time <span class="ot">=</span> <span class="fu">Sys.time</span>()</span>
<span id="cb53-122"><a href="initial-parameters-for-em-algorithm.html#cb53-122" tabindex="-1"></a>  <span class="cf">for</span>(iclust <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>numclust){</span>
<span id="cb53-123"><a href="initial-parameters-for-em-algorithm.html#cb53-123" tabindex="-1"></a></span>
<span id="cb53-124"><a href="initial-parameters-for-em-algorithm.html#cb53-124" tabindex="-1"></a>    resp.iclust <span class="ot">&lt;-</span> <span class="fu">lapply</span>(resp, <span class="at">FUN =</span> <span class="cf">function</span>(r) <span class="fu">matrix</span>(r[,iclust]))</span>
<span id="cb53-125"><a href="initial-parameters-for-em-algorithm.html#cb53-125" tabindex="-1"></a></span>
<span id="cb53-126"><a href="initial-parameters-for-em-algorithm.html#cb53-126" tabindex="-1"></a>    <span class="do">## Possibly locally adaptive ADMM, for now just running with rho == lambda</span></span>
<span id="cb53-127"><a href="initial-parameters-for-em-algorithm.html#cb53-127" tabindex="-1"></a>    res <span class="ot">=</span> <a href="initial-parameters-for-em-algorithm.html#la_admm_oneclust">la_admm_oneclust</a>(<span class="at">K =</span> (<span class="cf">if</span>(local_adapt) local_adapt_niter <span class="cf">else</span> <span class="dv">1</span>),</span>
<span id="cb53-128"><a href="initial-parameters-for-em-algorithm.html#cb53-128" tabindex="-1"></a>                           <span class="at">local_adapt =</span> local_adapt,</span>
<span id="cb53-129"><a href="initial-parameters-for-em-algorithm.html#cb53-129" tabindex="-1"></a>                           <span class="at">iclust =</span> iclust,</span>
<span id="cb53-130"><a href="initial-parameters-for-em-algorithm.html#cb53-130" tabindex="-1"></a>                           <span class="at">niter =</span> niter,</span>
<span id="cb53-131"><a href="initial-parameters-for-em-algorithm.html#cb53-131" tabindex="-1"></a>                           <span class="at">TT =</span> TT, <span class="at">N =</span> N, <span class="at">dimdat =</span> dimdat, <span class="at">maxdev =</span> maxdev,</span>
<span id="cb53-132"><a href="initial-parameters-for-em-algorithm.html#cb53-132" tabindex="-1"></a>                           <span class="at">schurA =</span> schur_syl_A_by_clust[[iclust]],</span>
<span id="cb53-133"><a href="initial-parameters-for-em-algorithm.html#cb53-133" tabindex="-1"></a>                           <span class="at">schurB =</span> schur_syl_B_by_clust[[iclust]],</span>
<span id="cb53-134"><a href="initial-parameters-for-em-algorithm.html#cb53-134" tabindex="-1"></a>                           <span class="at">sigmainv =</span> sigmainv_list[[iclust]],</span>
<span id="cb53-135"><a href="initial-parameters-for-em-algorithm.html#cb53-135" tabindex="-1"></a>                           <span class="at">rho =</span> rho_init, </span>
<span id="cb53-136"><a href="initial-parameters-for-em-algorithm.html#cb53-136" tabindex="-1"></a>                           <span class="at">rhoinit =</span> rho_init, </span>
<span id="cb53-137"><a href="initial-parameters-for-em-algorithm.html#cb53-137" tabindex="-1"></a>                           <span class="do">## rho = (if(iclust == 1) rho_init else res$rho/2),</span></span>
<span id="cb53-138"><a href="initial-parameters-for-em-algorithm.html#cb53-138" tabindex="-1"></a>                           <span class="do">## rhoinit = (if(iclust == 1) rho_init else res$rho/2),</span></span>
<span id="cb53-139"><a href="initial-parameters-for-em-algorithm.html#cb53-139" tabindex="-1"></a>                           <span class="at">sigma =</span> sigma,</span>
<span id="cb53-140"><a href="initial-parameters-for-em-algorithm.html#cb53-140" tabindex="-1"></a>                           <span class="at">lambda =</span> lambda,</span>
<span id="cb53-141"><a href="initial-parameters-for-em-algorithm.html#cb53-141" tabindex="-1"></a>                           <span class="at">resp =</span> resp.iclust,</span>
<span id="cb53-142"><a href="initial-parameters-for-em-algorithm.html#cb53-142" tabindex="-1"></a>                           <span class="at">resp_sum =</span> resp.sum[,iclust],</span>
<span id="cb53-143"><a href="initial-parameters-for-em-algorithm.html#cb53-143" tabindex="-1"></a>                           <span class="at">l =</span> l,</span>
<span id="cb53-144"><a href="initial-parameters-for-em-algorithm.html#cb53-144" tabindex="-1"></a>                           <span class="at">Dlp1 =</span> Dlp1,</span>
<span id="cb53-145"><a href="initial-parameters-for-em-algorithm.html#cb53-145" tabindex="-1"></a>                           <span class="at">Dl =</span> Dl,</span>
<span id="cb53-146"><a href="initial-parameters-for-em-algorithm.html#cb53-146" tabindex="-1"></a>                           <span class="at">tDl =</span> tDl,</span>
<span id="cb53-147"><a href="initial-parameters-for-em-algorithm.html#cb53-147" tabindex="-1"></a>                           <span class="at">y =</span> ylist,</span>
<span id="cb53-148"><a href="initial-parameters-for-em-algorithm.html#cb53-148" tabindex="-1"></a>                           <span class="at">err_rel =</span> err_rel,</span>
<span id="cb53-149"><a href="initial-parameters-for-em-algorithm.html#cb53-149" tabindex="-1"></a>                           <span class="at">err_abs =</span> err_abs,</span>
<span id="cb53-150"><a href="initial-parameters-for-em-algorithm.html#cb53-150" tabindex="-1"></a>                           <span class="at">zerothresh =</span> zerothresh,</span>
<span id="cb53-151"><a href="initial-parameters-for-em-algorithm.html#cb53-151" tabindex="-1"></a>                           <span class="at">sigma_eig_by_clust =</span> sigma_eig_by_clust,</span>
<span id="cb53-152"><a href="initial-parameters-for-em-algorithm.html#cb53-152" tabindex="-1"></a>                           <span class="at">iter =</span> iter,</span>
<span id="cb53-153"><a href="initial-parameters-for-em-algorithm.html#cb53-153" tabindex="-1"></a></span>
<span id="cb53-154"><a href="initial-parameters-for-em-algorithm.html#cb53-154" tabindex="-1"></a>                           <span class="do">## Warm starts from previous *EM* iteration</span></span>
<span id="cb53-155"><a href="initial-parameters-for-em-algorithm.html#cb53-155" tabindex="-1"></a>                           <span class="at">first_iter =</span> first_iter,</span>
<span id="cb53-156"><a href="initial-parameters-for-em-algorithm.html#cb53-156" tabindex="-1"></a>                           <span class="do">## mu = mus[[iclust]], ## I think we want this.</span></span>
<span id="cb53-157"><a href="initial-parameters-for-em-algorithm.html#cb53-157" tabindex="-1"></a>                           <span class="at">uw =</span> uws[[iclust]],</span>
<span id="cb53-158"><a href="initial-parameters-for-em-algorithm.html#cb53-158" tabindex="-1"></a>                           <span class="at">uz =</span> uzs[[iclust]],</span>
<span id="cb53-159"><a href="initial-parameters-for-em-algorithm.html#cb53-159" tabindex="-1"></a>                           <span class="at">z =</span> Zs[[iclust]],</span>
<span id="cb53-160"><a href="initial-parameters-for-em-algorithm.html#cb53-160" tabindex="-1"></a>                           <span class="at">w =</span> Ws[[iclust]])</span>
<span id="cb53-161"><a href="initial-parameters-for-em-algorithm.html#cb53-161" tabindex="-1"></a>    <span class="do">## print(res$rho)</span></span>
<span id="cb53-162"><a href="initial-parameters-for-em-algorithm.html#cb53-162" tabindex="-1"></a></span>
<span id="cb53-163"><a href="initial-parameters-for-em-algorithm.html#cb53-163" tabindex="-1"></a>    <span class="do">## Store the results</span></span>
<span id="cb53-164"><a href="initial-parameters-for-em-algorithm.html#cb53-164" tabindex="-1"></a>    mus[[iclust]] <span class="ot">=</span> res<span class="sc">$</span>mu</span>
<span id="cb53-165"><a href="initial-parameters-for-em-algorithm.html#cb53-165" tabindex="-1"></a>    admm_niters[[iclust]] <span class="ot">=</span> res<span class="sc">$</span>kk</span>
<span id="cb53-166"><a href="initial-parameters-for-em-algorithm.html#cb53-166" tabindex="-1"></a>    admm_inner_iters[[iclust]] <span class="ot">=</span> res<span class="sc">$</span>inner.iter</span>
<span id="cb53-167"><a href="initial-parameters-for-em-algorithm.html#cb53-167" tabindex="-1"></a></span>
<span id="cb53-168"><a href="initial-parameters-for-em-algorithm.html#cb53-168" tabindex="-1"></a>    <span class="do">## Store other things for for warmstart</span></span>
<span id="cb53-169"><a href="initial-parameters-for-em-algorithm.html#cb53-169" tabindex="-1"></a>    <span class="do">## mus[[iclust]] = res$mu</span></span>
<span id="cb53-170"><a href="initial-parameters-for-em-algorithm.html#cb53-170" tabindex="-1"></a>    Zs[[iclust]] <span class="ot">=</span> res<span class="sc">$</span>Z</span>
<span id="cb53-171"><a href="initial-parameters-for-em-algorithm.html#cb53-171" tabindex="-1"></a>    uzs[[iclust]] <span class="ot">=</span> res<span class="sc">$</span>uz</span>
<span id="cb53-172"><a href="initial-parameters-for-em-algorithm.html#cb53-172" tabindex="-1"></a>    uws[[iclust]] <span class="ot">=</span> res<span class="sc">$</span>uw</span>
<span id="cb53-173"><a href="initial-parameters-for-em-algorithm.html#cb53-173" tabindex="-1"></a>    Ws[[iclust]] <span class="ot">=</span> res<span class="sc">$</span>W</span>
<span id="cb53-174"><a href="initial-parameters-for-em-algorithm.html#cb53-174" tabindex="-1"></a>    <span class="do">## The upper triangular matrix remains the same. (code missing?)</span></span>
<span id="cb53-175"><a href="initial-parameters-for-em-algorithm.html#cb53-175" tabindex="-1"></a></span>
<span id="cb53-176"><a href="initial-parameters-for-em-algorithm.html#cb53-176" tabindex="-1"></a>  }</span>
<span id="cb53-177"><a href="initial-parameters-for-em-algorithm.html#cb53-177" tabindex="-1"></a></span>
<span id="cb53-178"><a href="initial-parameters-for-em-algorithm.html#cb53-178" tabindex="-1"></a>  <span class="do">## Aggregate the yhats into one array</span></span>
<span id="cb53-179"><a href="initial-parameters-for-em-algorithm.html#cb53-179" tabindex="-1"></a>  mu_array <span class="ot">=</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim =</span> <span class="fu">c</span>(TT, dimdat, numclust))</span>
<span id="cb53-180"><a href="initial-parameters-for-em-algorithm.html#cb53-180" tabindex="-1"></a>  <span class="cf">for</span>(iclust <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>numclust){ mu_array[,,iclust] <span class="ot">=</span> mus[[iclust]] }</span>
<span id="cb53-181"><a href="initial-parameters-for-em-algorithm.html#cb53-181" tabindex="-1"></a></span>
<span id="cb53-182"><a href="initial-parameters-for-em-algorithm.html#cb53-182" tabindex="-1"></a>  <span class="do">## Each are lists of length |numclust|.</span></span>
<span id="cb53-183"><a href="initial-parameters-for-em-algorithm.html#cb53-183" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">mns =</span> mu_array,</span>
<span id="cb53-184"><a href="initial-parameters-for-em-algorithm.html#cb53-184" tabindex="-1"></a>              <span class="at">admm_niters =</span> admm_niters, </span>
<span id="cb53-185"><a href="initial-parameters-for-em-algorithm.html#cb53-185" tabindex="-1"></a>              <span class="at">admm_inner_iters =</span> admm_inner_iters,</span>
<span id="cb53-186"><a href="initial-parameters-for-em-algorithm.html#cb53-186" tabindex="-1"></a></span>
<span id="cb53-187"><a href="initial-parameters-for-em-algorithm.html#cb53-187" tabindex="-1"></a>              <span class="do">## For warmstarts</span></span>
<span id="cb53-188"><a href="initial-parameters-for-em-algorithm.html#cb53-188" tabindex="-1"></a>              <span class="at">Zs =</span> Zs,</span>
<span id="cb53-189"><a href="initial-parameters-for-em-algorithm.html#cb53-189" tabindex="-1"></a>              <span class="at">Ws =</span> Ws,</span>
<span id="cb53-190"><a href="initial-parameters-for-em-algorithm.html#cb53-190" tabindex="-1"></a>              <span class="at">uws =</span> uws,</span>
<span id="cb53-191"><a href="initial-parameters-for-em-algorithm.html#cb53-191" tabindex="-1"></a>              <span class="at">uzs =</span> uzs,</span>
<span id="cb53-192"><a href="initial-parameters-for-em-algorithm.html#cb53-192" tabindex="-1"></a>              <span class="at">N =</span> N,</span>
<span id="cb53-193"><a href="initial-parameters-for-em-algorithm.html#cb53-193" tabindex="-1"></a></span>
<span id="cb53-194"><a href="initial-parameters-for-em-algorithm.html#cb53-194" tabindex="-1"></a>              <span class="do">## Return the column</span></span>
<span id="cb53-195"><a href="initial-parameters-for-em-algorithm.html#cb53-195" tabindex="-1"></a>              <span class="at">rho =</span> res<span class="sc">$</span>rho,</span>
<span id="cb53-196"><a href="initial-parameters-for-em-algorithm.html#cb53-196" tabindex="-1"></a></span>
<span id="cb53-197"><a href="initial-parameters-for-em-algorithm.html#cb53-197" tabindex="-1"></a>              <span class="do">## For using in the Sigma M step</span></span>
<span id="cb53-198"><a href="initial-parameters-for-em-algorithm.html#cb53-198" tabindex="-1"></a>              <span class="at">ycentered_list =</span> ycentered_list,</span>
<span id="cb53-199"><a href="initial-parameters-for-em-algorithm.html#cb53-199" tabindex="-1"></a>              <span class="at">Xcentered_list =</span> Xcentered_list,</span>
<span id="cb53-200"><a href="initial-parameters-for-em-algorithm.html#cb53-200" tabindex="-1"></a>              <span class="at">yXcentered_list =</span> yXcentered_list,</span>
<span id="cb53-201"><a href="initial-parameters-for-em-algorithm.html#cb53-201" tabindex="-1"></a>              <span class="at">Qlist =</span> Qlist</span>
<span id="cb53-202"><a href="initial-parameters-for-em-algorithm.html#cb53-202" tabindex="-1"></a>  ))</span>
<span id="cb53-203"><a href="initial-parameters-for-em-algorithm.html#cb53-203" tabindex="-1"></a>}</span></code></pre></div>
<p>The locally adaptive admm for a single cluster involves an inner and outer
loop. The inner loop is an ADMM for a fixed <span class="math inline">\(\rho\)</span>. The outer loop is written
here in <code>la_admm_oneclust</code>, and runs the inner ADMM with a fixed step-size
<span class="math inline">\(\rho\)</span> while sequentially doubling <span class="math inline">\(\rho\)</span>.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="initial-parameters-for-em-algorithm.html#cb54-1" tabindex="-1"></a><span class="co">#' Locally adaptive ADMM.</span></span>
<span id="cb54-2"><a href="initial-parameters-for-em-algorithm.html#cb54-2" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb54-3"><a href="initial-parameters-for-em-algorithm.html#cb54-3" tabindex="-1"></a><span class="co">#' @param K</span></span>
<span id="cb54-4"><a href="initial-parameters-for-em-algorithm.html#cb54-4" tabindex="-1"></a><span class="co">#' @param ...</span></span>
<span id="cb54-5"><a href="initial-parameters-for-em-algorithm.html#cb54-5" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb54-6"><a href="initial-parameters-for-em-algorithm.html#cb54-6" tabindex="-1"></a><span class="co">#' @return</span></span>
<span id="cb54-7"><a href="initial-parameters-for-em-algorithm.html#cb54-7" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb54-8"><a href="initial-parameters-for-em-algorithm.html#cb54-8" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb54-9"><a href="initial-parameters-for-em-algorithm.html#cb54-9" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb54-10"><a href="initial-parameters-for-em-algorithm.html#cb54-10" tabindex="-1"></a><span id="la_admm_oneclust">la_admm_oneclust</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(K, ...){</span>
<span id="cb54-11"><a href="initial-parameters-for-em-algorithm.html#cb54-11" tabindex="-1"></a></span>
<span id="cb54-12"><a href="initial-parameters-for-em-algorithm.html#cb54-12" tabindex="-1"></a>  <span class="do">## Initialize arguments for ADMM.</span></span>
<span id="cb54-13"><a href="initial-parameters-for-em-algorithm.html#cb54-13" tabindex="-1"></a>  args <span class="ot">&lt;-</span> <span class="fu">list</span>(...)</span>
<span id="cb54-14"><a href="initial-parameters-for-em-algorithm.html#cb54-14" tabindex="-1"></a>  p <span class="ot">=</span> args<span class="sc">$</span>p</span>
<span id="cb54-15"><a href="initial-parameters-for-em-algorithm.html#cb54-15" tabindex="-1"></a>  l <span class="ot">=</span> args<span class="sc">$</span>l</span>
<span id="cb54-16"><a href="initial-parameters-for-em-algorithm.html#cb54-16" tabindex="-1"></a>  TT <span class="ot">=</span> args<span class="sc">$</span>TT</span>
<span id="cb54-17"><a href="initial-parameters-for-em-algorithm.html#cb54-17" tabindex="-1"></a>  dimdat <span class="ot">=</span> args<span class="sc">$</span>dimdat</span>
<span id="cb54-18"><a href="initial-parameters-for-em-algorithm.html#cb54-18" tabindex="-1"></a>  rhoinit <span class="ot">=</span> args<span class="sc">$</span>rhoinit</span>
<span id="cb54-19"><a href="initial-parameters-for-em-algorithm.html#cb54-19" tabindex="-1"></a></span>
<span id="cb54-20"><a href="initial-parameters-for-em-algorithm.html#cb54-20" tabindex="-1"></a>  <span class="do">## This initialization can come from the previous *EM* iteration.</span></span>
<span id="cb54-21"><a href="initial-parameters-for-em-algorithm.html#cb54-21" tabindex="-1"></a>  <span class="cf">if</span>(args<span class="sc">$</span>first_iter){</span>
<span id="cb54-22"><a href="initial-parameters-for-em-algorithm.html#cb54-22" tabindex="-1"></a>    mu <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> TT, <span class="at">ncol =</span> dimdat)</span>
<span id="cb54-23"><a href="initial-parameters-for-em-algorithm.html#cb54-23" tabindex="-1"></a>    Z <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> TT, <span class="at">ncol =</span> dimdat)</span>
<span id="cb54-24"><a href="initial-parameters-for-em-algorithm.html#cb54-24" tabindex="-1"></a>    W <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> TT<span class="sc">-</span>l, <span class="at">ncol =</span> dimdat)</span>
<span id="cb54-25"><a href="initial-parameters-for-em-algorithm.html#cb54-25" tabindex="-1"></a>    uz <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> TT, <span class="at">ncol =</span> dimdat)</span>
<span id="cb54-26"><a href="initial-parameters-for-em-algorithm.html#cb54-26" tabindex="-1"></a>    uw <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> TT <span class="sc">-</span> l, <span class="at">ncol =</span> dimdat)</span>
<span id="cb54-27"><a href="initial-parameters-for-em-algorithm.html#cb54-27" tabindex="-1"></a></span>
<span id="cb54-28"><a href="initial-parameters-for-em-algorithm.html#cb54-28" tabindex="-1"></a>    args[[<span class="st">'mu'</span>]] <span class="ot">&lt;-</span> mu</span>
<span id="cb54-29"><a href="initial-parameters-for-em-algorithm.html#cb54-29" tabindex="-1"></a>    args[[<span class="st">'z'</span>]] <span class="ot">&lt;-</span> Z</span>
<span id="cb54-30"><a href="initial-parameters-for-em-algorithm.html#cb54-30" tabindex="-1"></a>    args[[<span class="st">'w'</span>]] <span class="ot">&lt;-</span> W</span>
<span id="cb54-31"><a href="initial-parameters-for-em-algorithm.html#cb54-31" tabindex="-1"></a>    args[[<span class="st">'uz'</span>]] <span class="ot">&lt;-</span> uz</span>
<span id="cb54-32"><a href="initial-parameters-for-em-algorithm.html#cb54-32" tabindex="-1"></a>    args[[<span class="st">'uw'</span>]] <span class="ot">&lt;-</span> uw</span>
<span id="cb54-33"><a href="initial-parameters-for-em-algorithm.html#cb54-33" tabindex="-1"></a>  }</span>
<span id="cb54-34"><a href="initial-parameters-for-em-algorithm.html#cb54-34" tabindex="-1"></a></span>
<span id="cb54-35"><a href="initial-parameters-for-em-algorithm.html#cb54-35" tabindex="-1"></a>  cols <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb54-36"><a href="initial-parameters-for-em-algorithm.html#cb54-36" tabindex="-1"></a>  some_admm_objectives <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb54-37"><a href="initial-parameters-for-em-algorithm.html#cb54-37" tabindex="-1"></a></span>
<span id="cb54-38"><a href="initial-parameters-for-em-algorithm.html#cb54-38" tabindex="-1"></a></span>
<span id="cb54-39"><a href="initial-parameters-for-em-algorithm.html#cb54-39" tabindex="-1"></a>  <span class="do">## Run ADMM repeatedly with (1) double rho, and (2) previous b</span></span>
<span id="cb54-40"><a href="initial-parameters-for-em-algorithm.html#cb54-40" tabindex="-1"></a>  <span class="cf">for</span>(kk <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K){</span>
<span id="cb54-41"><a href="initial-parameters-for-em-algorithm.html#cb54-41" tabindex="-1"></a>    <span class="cf">if</span>(kk <span class="sc">&gt;</span> <span class="dv">1</span>){</span>
<span id="cb54-42"><a href="initial-parameters-for-em-algorithm.html#cb54-42" tabindex="-1"></a>      <span class="do">## Z = matrix(0, nrow = TT, ncol = dimdat)</span></span>
<span id="cb54-43"><a href="initial-parameters-for-em-algorithm.html#cb54-43" tabindex="-1"></a>      <span class="do">## W = matrix(0, nrow = TT - l , ncol = dimdat)</span></span>
<span id="cb54-44"><a href="initial-parameters-for-em-algorithm.html#cb54-44" tabindex="-1"></a>      <span class="do">## uz = matrix(0, nrow = TT, ncol = dimdat)</span></span>
<span id="cb54-45"><a href="initial-parameters-for-em-algorithm.html#cb54-45" tabindex="-1"></a>      <span class="do">## uw = matrix(0, nrow = TT - l , ncol = dimdat)</span></span>
<span id="cb54-46"><a href="initial-parameters-for-em-algorithm.html#cb54-46" tabindex="-1"></a></span>
<span id="cb54-47"><a href="initial-parameters-for-em-algorithm.html#cb54-47" tabindex="-1"></a>      <span class="do">## These ensure warm starts are true</span></span>
<span id="cb54-48"><a href="initial-parameters-for-em-algorithm.html#cb54-48" tabindex="-1"></a>      args[[<span class="st">'mu'</span>]] <span class="ot">&lt;-</span> mu</span>
<span id="cb54-49"><a href="initial-parameters-for-em-algorithm.html#cb54-49" tabindex="-1"></a>      args[[<span class="st">'z'</span>]] <span class="ot">&lt;-</span> Z</span>
<span id="cb54-50"><a href="initial-parameters-for-em-algorithm.html#cb54-50" tabindex="-1"></a>      args[[<span class="st">'w'</span>]] <span class="ot">&lt;-</span> W</span>
<span id="cb54-51"><a href="initial-parameters-for-em-algorithm.html#cb54-51" tabindex="-1"></a>      args[[<span class="st">'uz'</span>]] <span class="ot">&lt;-</span> uz</span>
<span id="cb54-52"><a href="initial-parameters-for-em-algorithm.html#cb54-52" tabindex="-1"></a>      args[[<span class="st">'uw'</span>]] <span class="ot">&lt;-</span> uw</span>
<span id="cb54-53"><a href="initial-parameters-for-em-algorithm.html#cb54-53" tabindex="-1"></a>      args[[<span class="st">'rho'</span>]] <span class="ot">&lt;-</span> rho</span>
<span id="cb54-54"><a href="initial-parameters-for-em-algorithm.html#cb54-54" tabindex="-1"></a>    }</span>
<span id="cb54-55"><a href="initial-parameters-for-em-algorithm.html#cb54-55" tabindex="-1"></a></span>
<span id="cb54-56"><a href="initial-parameters-for-em-algorithm.html#cb54-56" tabindex="-1"></a>    <span class="do">## Run ADMM</span></span>
<span id="cb54-57"><a href="initial-parameters-for-em-algorithm.html#cb54-57" tabindex="-1"></a>    args[[<span class="st">'outer_iter'</span>]] <span class="ot">&lt;-</span> kk</span>
<span id="cb54-58"><a href="initial-parameters-for-em-algorithm.html#cb54-58" tabindex="-1"></a></span>
<span id="cb54-59"><a href="initial-parameters-for-em-algorithm.html#cb54-59" tabindex="-1"></a>    <span class="do">## Call main function</span></span>
<span id="cb54-60"><a href="initial-parameters-for-em-algorithm.html#cb54-60" tabindex="-1"></a>    argn <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(args), as.name)</span>
<span id="cb54-61"><a href="initial-parameters-for-em-algorithm.html#cb54-61" tabindex="-1"></a>    <span class="fu">names</span>(argn) <span class="ot">&lt;-</span> <span class="fu">names</span>(args)</span>
<span id="cb54-62"><a href="initial-parameters-for-em-algorithm.html#cb54-62" tabindex="-1"></a>    call <span class="ot">&lt;-</span> <span class="fu">as.call</span>(<span class="fu">c</span>(<span class="fu">list</span>(<span class="fu">as.name</span>(<span class="st">"admm_oneclust"</span>)), argn))</span>
<span id="cb54-63"><a href="initial-parameters-for-em-algorithm.html#cb54-63" tabindex="-1"></a>    res <span class="ot">=</span> <span class="fu">eval</span>(call, args)</span>
<span id="cb54-64"><a href="initial-parameters-for-em-algorithm.html#cb54-64" tabindex="-1"></a></span>
<span id="cb54-65"><a href="initial-parameters-for-em-algorithm.html#cb54-65" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">abs</span>(res<span class="sc">$</span>mu)<span class="sc">&gt;</span><span class="fl">1E2</span>)){</span>
<span id="cb54-66"><a href="initial-parameters-for-em-algorithm.html#cb54-66" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">"mu is blowing up! Probably because the initial ADMM step size (rho) is too large (and possibly the ball constraint on the means is large."</span>) </span>
<span id="cb54-67"><a href="initial-parameters-for-em-algorithm.html#cb54-67" tabindex="-1"></a>    }</span>
<span id="cb54-68"><a href="initial-parameters-for-em-algorithm.html#cb54-68" tabindex="-1"></a></span>
<span id="cb54-69"><a href="initial-parameters-for-em-algorithm.html#cb54-69" tabindex="-1"></a>    some_admm_objectives <span class="ot">=</span> <span class="fu">c</span>(some_admm_objectives, res<span class="sc">$</span>single_admm_objective) </span>
<span id="cb54-70"><a href="initial-parameters-for-em-algorithm.html#cb54-70" tabindex="-1"></a></span>
<span id="cb54-71"><a href="initial-parameters-for-em-algorithm.html#cb54-71" tabindex="-1"></a>    <span class="do">## Handling the scenario where the objectives are all zero</span></span>
<span id="cb54-72"><a href="initial-parameters-for-em-algorithm.html#cb54-72" tabindex="-1"></a>    padding <span class="ot">=</span> <span class="fl">1E-12</span></span>
<span id="cb54-73"><a href="initial-parameters-for-em-algorithm.html#cb54-73" tabindex="-1"></a>    some_admm_objectives <span class="ot">=</span> some_admm_objectives <span class="sc">+</span> padding</span>
<span id="cb54-74"><a href="initial-parameters-for-em-algorithm.html#cb54-74" tabindex="-1"></a></span>
<span id="cb54-75"><a href="initial-parameters-for-em-algorithm.html#cb54-75" tabindex="-1"></a>    <span class="do">## See if outer iterations should terminate</span></span>
<span id="cb54-76"><a href="initial-parameters-for-em-algorithm.html#cb54-76" tabindex="-1"></a>    <span class="cf">if</span>(res<span class="sc">$</span>converge){</span>
<span id="cb54-77"><a href="initial-parameters-for-em-algorithm.html#cb54-77" tabindex="-1"></a>      res<span class="sc">$</span>converge <span class="ot">&lt;-</span> T</span>
<span id="cb54-78"><a href="initial-parameters-for-em-algorithm.html#cb54-78" tabindex="-1"></a>      <span class="cf">break</span></span>
<span id="cb54-79"><a href="initial-parameters-for-em-algorithm.html#cb54-79" tabindex="-1"></a>    }</span>
<span id="cb54-80"><a href="initial-parameters-for-em-algorithm.html#cb54-80" tabindex="-1"></a></span>
<span id="cb54-81"><a href="initial-parameters-for-em-algorithm.html#cb54-81" tabindex="-1"></a>    <span class="do">## Update some parameters; double the rho value, and update the B matrix</span></span>
<span id="cb54-82"><a href="initial-parameters-for-em-algorithm.html#cb54-82" tabindex="-1"></a>    rho <span class="ot">=</span> <span class="dv">2</span> <span class="sc">*</span> args<span class="sc">$</span>rho</span>
<span id="cb54-83"><a href="initial-parameters-for-em-algorithm.html#cb54-83" tabindex="-1"></a>    <span class="do">## tQ = 2 * args$schurB$tQ ## This seems wrong. Delete now.</span></span>
<span id="cb54-84"><a href="initial-parameters-for-em-algorithm.html#cb54-84" tabindex="-1"></a>    mu <span class="ot">=</span> res<span class="sc">$</span>mu</span>
<span id="cb54-85"><a href="initial-parameters-for-em-algorithm.html#cb54-85" tabindex="-1"></a>    Z <span class="ot">=</span> res<span class="sc">$</span>Z</span>
<span id="cb54-86"><a href="initial-parameters-for-em-algorithm.html#cb54-86" tabindex="-1"></a>    W <span class="ot">=</span> res<span class="sc">$</span>W</span>
<span id="cb54-87"><a href="initial-parameters-for-em-algorithm.html#cb54-87" tabindex="-1"></a>    uz <span class="ot">=</span> res<span class="sc">$</span>uz</span>
<span id="cb54-88"><a href="initial-parameters-for-em-algorithm.html#cb54-88" tabindex="-1"></a>    uw <span class="ot">=</span> res<span class="sc">$</span>uw</span>
<span id="cb54-89"><a href="initial-parameters-for-em-algorithm.html#cb54-89" tabindex="-1"></a>    <span class="do">## print("args$rho")</span></span>
<span id="cb54-90"><a href="initial-parameters-for-em-algorithm.html#cb54-90" tabindex="-1"></a>    <span class="do">## print(args$rho)</span></span>
<span id="cb54-91"><a href="initial-parameters-for-em-algorithm.html#cb54-91" tabindex="-1"></a>  }</span>
<span id="cb54-92"><a href="initial-parameters-for-em-algorithm.html#cb54-92" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span>res<span class="sc">$</span>converge)   <span class="fu">warning</span>(<span class="st">"ADMM didn't converge for one cluster."</span>)</span>
<span id="cb54-93"><a href="initial-parameters-for-em-algorithm.html#cb54-93" tabindex="-1"></a></span>
<span id="cb54-94"><a href="initial-parameters-for-em-algorithm.html#cb54-94" tabindex="-1"></a>  <span class="do">## Record how long the admm took; in terms of # iterations.</span></span>
<span id="cb54-95"><a href="initial-parameters-for-em-algorithm.html#cb54-95" tabindex="-1"></a>  res<span class="sc">$</span>kk <span class="ot">=</span> kk</span>
<span id="cb54-96"><a href="initial-parameters-for-em-algorithm.html#cb54-96" tabindex="-1"></a></span>
<span id="cb54-97"><a href="initial-parameters-for-em-algorithm.html#cb54-97" tabindex="-1"></a>  <span class="do">## Record the final rho</span></span>
<span id="cb54-98"><a href="initial-parameters-for-em-algorithm.html#cb54-98" tabindex="-1"></a>  res<span class="sc">$</span>rho <span class="ot">=</span> args<span class="sc">$</span>rho</span>
<span id="cb54-99"><a href="initial-parameters-for-em-algorithm.html#cb54-99" tabindex="-1"></a></span>
<span id="cb54-100"><a href="initial-parameters-for-em-algorithm.html#cb54-100" tabindex="-1"></a>  <span class="fu">return</span>(res)</span>
<span id="cb54-101"><a href="initial-parameters-for-em-algorithm.html#cb54-101" tabindex="-1"></a>}</span></code></pre></div>
<p>Next, the inner loop. The workhorse <code><a href="initial-parameters-for-em-algorithm.html#admm_oneclust">admm_oneclust</a>()</code> actually performs the ADMM
update for one cluster for a fixed step-size <span class="math inline">\(\rho\)</span> across optimization
iterations <code>iter=1,...,n</code>.</p>
<p>This <code><a href="initial-parameters-for-em-algorithm.html#admm_oneclust">admm_oneclust</a>()</code> uses the following helpers:</p>
<ul>
<li>
<code><a href="initial-parameters-for-em-algorithm.html#W_update_fused">W_update_fused</a>()</code>: this uses the <code>prox</code> function, which uses a RCpp function.
<code>prox_dp</code>.</li>
<li><code><a href="initial-parameters-for-em-algorithm.html#Z_update">Z_update</a>()</code></li>
<li><code><a href="initial-parameters-for-em-algorithm.html#U_update_Z">U_update_Z</a>()</code></li>
<li><code><a href="initial-parameters-for-em-algorithm.html#U_update_W">U_update_W</a>()</code></li>
</ul>
<p>A <code>prox_dp</code> function, written in C, will be used.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="initial-parameters-for-em-algorithm.html#cb55-1" tabindex="-1"></a><span class="co">#' Solve a fused lasso problem for the W update. Internally, a fused lasso dynamic</span></span>
<span id="cb55-2"><a href="initial-parameters-for-em-algorithm.html#cb55-2" tabindex="-1"></a><span class="co">#' programming solver \code{<a href="initial-parameters-for-em-algorithm.html#prox">prox</a>()} (which calls \code{prox_dp()} written in C)</span></span>
<span id="cb55-3"><a href="initial-parameters-for-em-algorithm.html#cb55-3" tabindex="-1"></a><span class="co">#' is used.</span></span>
<span id="cb55-4"><a href="initial-parameters-for-em-algorithm.html#cb55-4" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb55-5"><a href="initial-parameters-for-em-algorithm.html#cb55-5" tabindex="-1"></a><span id="W_update_fused">W_update_fused</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(l, TT, mu, uw, rho, lambda, Dl){</span>
<span id="cb55-6"><a href="initial-parameters-for-em-algorithm.html#cb55-6" tabindex="-1"></a></span>
<span id="cb55-7"><a href="initial-parameters-for-em-algorithm.html#cb55-7" tabindex="-1"></a>  <span class="co"># modified lambda for fused lasso routine</span></span>
<span id="cb55-8"><a href="initial-parameters-for-em-algorithm.html#cb55-8" tabindex="-1"></a>  mod_lam <span class="ot">&lt;-</span> lambda<span class="sc">/</span>rho</span>
<span id="cb55-9"><a href="initial-parameters-for-em-algorithm.html#cb55-9" tabindex="-1"></a></span>
<span id="cb55-10"><a href="initial-parameters-for-em-algorithm.html#cb55-10" tabindex="-1"></a>  <span class="co"># generating pseudo response xi</span></span>
<span id="cb55-11"><a href="initial-parameters-for-em-algorithm.html#cb55-11" tabindex="-1"></a>  <span class="cf">if</span>( l <span class="sc">&lt;</span> <span class="dv">0</span> ){</span>
<span id="cb55-12"><a href="initial-parameters-for-em-algorithm.html#cb55-12" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"l should never be /below/ zero!"</span>)</span>
<span id="cb55-13"><a href="initial-parameters-for-em-algorithm.html#cb55-13" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span>( l <span class="sc">==</span> <span class="dv">0</span> ){</span>
<span id="cb55-14"><a href="initial-parameters-for-em-algorithm.html#cb55-14" tabindex="-1"></a>    xi <span class="ot">&lt;-</span> mu <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>rho <span class="sc">*</span> uw  <span class="do">## This is faster</span></span>
<span id="cb55-15"><a href="initial-parameters-for-em-algorithm.html#cb55-15" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb55-16"><a href="initial-parameters-for-em-algorithm.html#cb55-16" tabindex="-1"></a>    xi <span class="ot">&lt;-</span> Dl <span class="sc">%*%</span> mu <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>rho <span class="sc">*</span> uw</span>
<span id="cb55-17"><a href="initial-parameters-for-em-algorithm.html#cb55-17" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">is.nan</span>(xi))) <span class="fu">browser</span>()</span>
<span id="cb55-18"><a href="initial-parameters-for-em-algorithm.html#cb55-18" tabindex="-1"></a></span>
<span id="cb55-19"><a href="initial-parameters-for-em-algorithm.html#cb55-19" tabindex="-1"></a>    <span class="do">## l = 2 is quadratic trend filtering</span></span>
<span id="cb55-20"><a href="initial-parameters-for-em-algorithm.html#cb55-20" tabindex="-1"></a>    <span class="do">## l = 1 is linear trend filtering</span></span>
<span id="cb55-21"><a href="initial-parameters-for-em-algorithm.html#cb55-21" tabindex="-1"></a>    <span class="do">## l = 0 is fused lasso</span></span>
<span id="cb55-22"><a href="initial-parameters-for-em-algorithm.html#cb55-22" tabindex="-1"></a>    <span class="do">## D^{(1)} is first differences, so it correponds to l=0</span></span>
<span id="cb55-23"><a href="initial-parameters-for-em-algorithm.html#cb55-23" tabindex="-1"></a>    <span class="do">## Dl = <a href="package-setup.html#gen_diff_mat">gen_diff_mat</a>(n = TT, l = l, x = x)  &lt;---  (T-l) x T matrix </span></span>
<span id="cb55-24"><a href="initial-parameters-for-em-algorithm.html#cb55-24" tabindex="-1"></a>  }</span>
<span id="cb55-25"><a href="initial-parameters-for-em-algorithm.html#cb55-25" tabindex="-1"></a></span>
<span id="cb55-26"><a href="initial-parameters-for-em-algorithm.html#cb55-26" tabindex="-1"></a>  <span class="do">## Running the fused LASSO</span></span>
<span id="cb55-27"><a href="initial-parameters-for-em-algorithm.html#cb55-27" tabindex="-1"></a>  <span class="do">## which solves min_zhat 1/2 |z-zhat|_2^2 + lambda |D^{(1)}zhat|</span></span>
<span id="cb55-28"><a href="initial-parameters-for-em-algorithm.html#cb55-28" tabindex="-1"></a>  <span class="do">## fit &lt;- <a href="initial-parameters-for-em-algorithm.html#prox">prox</a>(z = xi, lam = mod_lam)</span></span>
<span id="cb55-29"><a href="initial-parameters-for-em-algorithm.html#cb55-29" tabindex="-1"></a>  <span class="do">## fit &lt;- prox_dp(z = xi, lam = mod_lam) ## instead of FlowTF::prox()</span></span>
<span id="cb55-30"><a href="initial-parameters-for-em-algorithm.html#cb55-30" tabindex="-1"></a>  <span class="do">## fit &lt;- flowtrendprox::prox_dp(z = xi, lam = mod_lam) </span></span>
<span id="cb55-31"><a href="initial-parameters-for-em-algorithm.html#cb55-31" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> FlowTF<span class="sc">::</span><a href="initial-parameters-for-em-algorithm.html#prox">prox</a>(<span class="at">z =</span> xi, <span class="at">lam =</span> mod_lam) </span>
<span id="cb55-32"><a href="initial-parameters-for-em-algorithm.html#cb55-32" tabindex="-1"></a>  <span class="do">## </span><span class="al">TODO</span><span class="do">: eventually change to  fit &lt;- flowtrendprox::prox(z = xi, lam = mod_lam)</span></span>
<span id="cb55-33"><a href="initial-parameters-for-em-algorithm.html#cb55-33" tabindex="-1"></a></span>
<span id="cb55-34"><a href="initial-parameters-for-em-algorithm.html#cb55-34" tabindex="-1"></a>  <span class="fu">return</span>(fit)</span>
<span id="cb55-35"><a href="initial-parameters-for-em-algorithm.html#cb55-35" tabindex="-1"></a>}</span>
<span id="cb55-36"><a href="initial-parameters-for-em-algorithm.html#cb55-36" tabindex="-1"></a></span>
<span id="cb55-37"><a href="initial-parameters-for-em-algorithm.html#cb55-37" tabindex="-1"></a><span class="do">## This function is in FlowTF now. It's the last function there!</span></span>
<span id="cb55-38"><a href="initial-parameters-for-em-algorithm.html#cb55-38" tabindex="-1"></a><span class="do">## #' Fused LASSO for scalar inputs.</span></span>
<span id="cb55-39"><a href="initial-parameters-for-em-algorithm.html#cb55-39" tabindex="-1"></a><span class="do">## #'</span></span>
<span id="cb55-40"><a href="initial-parameters-for-em-algorithm.html#cb55-40" tabindex="-1"></a><span class="do">## #' @param z scalar input to be smoothed via the fused LASSO</span></span>
<span id="cb55-41"><a href="initial-parameters-for-em-algorithm.html#cb55-41" tabindex="-1"></a><span class="do">## #' @param lam  Fused LASSO smoothing parameter</span></span>
<span id="cb55-42"><a href="initial-parameters-for-em-algorithm.html#cb55-42" tabindex="-1"></a><span class="do">## #'</span></span>
<span id="cb55-43"><a href="initial-parameters-for-em-algorithm.html#cb55-43" tabindex="-1"></a><span class="do">## #' @return Estimates of the fused LASSO solution</span></span>
<span id="cb55-44"><a href="initial-parameters-for-em-algorithm.html#cb55-44" tabindex="-1"></a><span class="do">## #' @export prox</span></span>
<span id="cb55-45"><a href="initial-parameters-for-em-algorithm.html#cb55-45" tabindex="-1"></a><span class="do">## #'</span></span>
<span id="cb55-46"><a href="initial-parameters-for-em-algorithm.html#cb55-46" tabindex="-1"></a><span class="do">## #' @references All credit for writing this function goes to Ryan Tibshirani. See</span></span>
<span id="cb55-47"><a href="initial-parameters-for-em-algorithm.html#cb55-47" tabindex="-1"></a><span class="do">## #'   the original code for calling this function at</span></span>
<span id="cb55-48"><a href="initial-parameters-for-em-algorithm.html#cb55-48" tabindex="-1"></a><span class="do">## #'</span></span>
<span id="cb55-49"><a href="initial-parameters-for-em-algorithm.html#cb55-49" tabindex="-1"></a><span class="do">## #' @useDynLib FlowTF prox_dp </span></span>
<span id="cb55-50"><a href="initial-parameters-for-em-algorithm.html#cb55-50" tabindex="-1"></a><span class="do">## <span id="prox">prox</span> &lt;-  function(z, lam) {</span></span>
<span id="cb55-51"><a href="initial-parameters-for-em-algorithm.html#cb55-51" tabindex="-1"></a><span class="do">##   o &lt;- .C("prox_dp",  </span></span>
<span id="cb55-52"><a href="initial-parameters-for-em-algorithm.html#cb55-52" tabindex="-1"></a><span class="do">##           as.integer(length(z)),</span></span>
<span id="cb55-53"><a href="initial-parameters-for-em-algorithm.html#cb55-53" tabindex="-1"></a><span class="do">##           as.double(z),</span></span>
<span id="cb55-54"><a href="initial-parameters-for-em-algorithm.html#cb55-54" tabindex="-1"></a><span class="do">##           as.double(lam),</span></span>
<span id="cb55-55"><a href="initial-parameters-for-em-algorithm.html#cb55-55" tabindex="-1"></a><span class="do">##           as.double(numeric(length(z))),</span></span>
<span id="cb55-56"><a href="initial-parameters-for-em-algorithm.html#cb55-56" tabindex="-1"></a><span class="do">##           #  dup=FALSE,</span></span>
<span id="cb55-57"><a href="initial-parameters-for-em-algorithm.html#cb55-57" tabindex="-1"></a><span class="do">##           PACKAGE="FlowTF")</span></span>
<span id="cb55-58"><a href="initial-parameters-for-em-algorithm.html#cb55-58" tabindex="-1"></a></span>
<span id="cb55-59"><a href="initial-parameters-for-em-algorithm.html#cb55-59" tabindex="-1"></a><span class="do">##   return(o[[4]])</span></span>
<span id="cb55-60"><a href="initial-parameters-for-em-algorithm.html#cb55-60" tabindex="-1"></a><span class="do">## }</span></span>
<span id="cb55-61"><a href="initial-parameters-for-em-algorithm.html#cb55-61" tabindex="-1"></a></span>
<span id="cb55-62"><a href="initial-parameters-for-em-algorithm.html#cb55-62" tabindex="-1"></a><span id="Z_update">Z_update</span>  <span class="ot">&lt;-</span> <span class="cf">function</span>(m, Uz, C, rho){</span>
<span id="cb55-63"><a href="initial-parameters-for-em-algorithm.html#cb55-63" tabindex="-1"></a>  mat <span class="ot">=</span> m <span class="sc">+</span> Uz<span class="sc">/</span>rho</span>
<span id="cb55-64"><a href="initial-parameters-for-em-algorithm.html#cb55-64" tabindex="-1"></a>  Z <span class="ot">=</span> <a href="initial-parameters-for-em-algorithm.html#projCmat">projCmat</a>(mat, C)</span>
<span id="cb55-65"><a href="initial-parameters-for-em-algorithm.html#cb55-65" tabindex="-1"></a>  <span class="fu">return</span>(Z)</span>
<span id="cb55-66"><a href="initial-parameters-for-em-algorithm.html#cb55-66" tabindex="-1"></a>}</span>
<span id="cb55-67"><a href="initial-parameters-for-em-algorithm.html#cb55-67" tabindex="-1"></a></span>
<span id="cb55-68"><a href="initial-parameters-for-em-algorithm.html#cb55-68" tabindex="-1"></a><span class="co">#' Project /rows/ of matrix |mat| into a ball of size C.</span></span>
<span id="cb55-69"><a href="initial-parameters-for-em-algorithm.html#cb55-69" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb55-70"><a href="initial-parameters-for-em-algorithm.html#cb55-70" tabindex="-1"></a><span class="co">#' @param mat Matrix whose rows will be projected into a C-sized ball.</span></span>
<span id="cb55-71"><a href="initial-parameters-for-em-algorithm.html#cb55-71" tabindex="-1"></a><span class="co">#' @param C radius</span></span>
<span id="cb55-72"><a href="initial-parameters-for-em-algorithm.html#cb55-72" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb55-73"><a href="initial-parameters-for-em-algorithm.html#cb55-73" tabindex="-1"></a><span class="co">#' @return Projected matrix.</span></span>
<span id="cb55-74"><a href="initial-parameters-for-em-algorithm.html#cb55-74" tabindex="-1"></a><span id="projCmat">projCmat</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(mat, C){</span>
<span id="cb55-75"><a href="initial-parameters-for-em-algorithm.html#cb55-75" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(C)){</span>
<span id="cb55-76"><a href="initial-parameters-for-em-algorithm.html#cb55-76" tabindex="-1"></a>    vlens <span class="ot">=</span> <span class="fu">sqrt</span>(<span class="fu">rowSums</span>(mat <span class="sc">*</span> mat))</span>
<span id="cb55-77"><a href="initial-parameters-for-em-algorithm.html#cb55-77" tabindex="-1"></a>    inds <span class="ot">=</span> <span class="fu">which</span>(vlens <span class="sc">&gt;</span> C)</span>
<span id="cb55-78"><a href="initial-parameters-for-em-algorithm.html#cb55-78" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">length</span>(inds) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb55-79"><a href="initial-parameters-for-em-algorithm.html#cb55-79" tabindex="-1"></a>      mat[inds,] <span class="ot">=</span> mat[inds,] <span class="sc">*</span> C <span class="sc">/</span> vlens[inds]</span>
<span id="cb55-80"><a href="initial-parameters-for-em-algorithm.html#cb55-80" tabindex="-1"></a>    }</span>
<span id="cb55-81"><a href="initial-parameters-for-em-algorithm.html#cb55-81" tabindex="-1"></a>  }</span>
<span id="cb55-82"><a href="initial-parameters-for-em-algorithm.html#cb55-82" tabindex="-1"></a>  <span class="fu">return</span>(mat)</span>
<span id="cb55-83"><a href="initial-parameters-for-em-algorithm.html#cb55-83" tabindex="-1"></a>}</span></code></pre></div>
<p>We will test the <code>projCmat</code> function.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="initial-parameters-for-em-algorithm.html#cb56-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb56-2"><a href="initial-parameters-for-em-algorithm.html#cb56-2" tabindex="-1"></a>mat <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(<span class="dv">100</span>), <span class="at">ncol=</span><span class="dv">2</span>)</span>
<span id="cb56-3"><a href="initial-parameters-for-em-algorithm.html#cb56-3" tabindex="-1"></a>projected_mat <span class="ot">=</span> flowtrend<span class="sc">:::</span><a href="initial-parameters-for-em-algorithm.html#projCmat">projCmat</a>(mat, <span class="dv">1</span>)</span>
<span id="cb56-4"><a href="initial-parameters-for-em-algorithm.html#cb56-4" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">all</span>(projected_mat <span class="sc">%&gt;%</span> <span class="fu">apply</span>(<span class="dv">1</span>, <span class="cf">function</span>(myrow)<span class="fu">sum</span>(myrow<span class="sc">*</span>myrow)) <span class="sc">&lt;</span> <span class="dv">1</span><span class="fl">+1E-8</span>))</span></code></pre></div>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="initial-parameters-for-em-algorithm.html#cb57-1" tabindex="-1"></a><span class="co">#' @param U (T x dimdat) matrix.</span></span>
<span id="cb57-2"><a href="initial-parameters-for-em-algorithm.html#cb57-2" tabindex="-1"></a><span id="U_update_Z">U_update_Z</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(U, rho, mu, Z, TT){</span>
<span id="cb57-3"><a href="initial-parameters-for-em-algorithm.html#cb57-3" tabindex="-1"></a> <span class="co"># return(U + rho * (scale(mu, scale = F) - Z))</span></span>
<span id="cb57-4"><a href="initial-parameters-for-em-algorithm.html#cb57-4" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">nrow</span>(U) <span class="sc">==</span> TT)</span>
<span id="cb57-5"><a href="initial-parameters-for-em-algorithm.html#cb57-5" tabindex="-1"></a></span>
<span id="cb57-6"><a href="initial-parameters-for-em-algorithm.html#cb57-6" tabindex="-1"></a>  centered_mu <span class="ot">=</span> <span class="fu">sweep</span>(mu, <span class="dv">2</span>, <span class="fu">colMeans</span>(mu)) </span>
<span id="cb57-7"><a href="initial-parameters-for-em-algorithm.html#cb57-7" tabindex="-1"></a>  <span class="do">## stopifnot(all(abs(colMeans(centered_mu))&lt;1E-8))</span></span>
<span id="cb57-8"><a href="initial-parameters-for-em-algorithm.html#cb57-8" tabindex="-1"></a>  Unew <span class="ot">=</span> U <span class="sc">+</span> rho <span class="sc">*</span> (centered_mu <span class="sc">-</span> Z)</span>
<span id="cb57-9"><a href="initial-parameters-for-em-algorithm.html#cb57-9" tabindex="-1"></a></span>
<span id="cb57-10"><a href="initial-parameters-for-em-algorithm.html#cb57-10" tabindex="-1"></a>  <span class="do">## Expect a (T-l) x dimdat matrix.</span></span>
<span id="cb57-11"><a href="initial-parameters-for-em-algorithm.html#cb57-11" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="fu">dim</span>(U) <span class="sc">==</span> <span class="fu">dim</span>(Unew))) </span>
<span id="cb57-12"><a href="initial-parameters-for-em-algorithm.html#cb57-12" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">nrow</span>(U) <span class="sc">==</span> TT)</span>
<span id="cb57-13"><a href="initial-parameters-for-em-algorithm.html#cb57-13" tabindex="-1"></a>  <span class="fu">return</span>(Unew)</span>
<span id="cb57-14"><a href="initial-parameters-for-em-algorithm.html#cb57-14" tabindex="-1"></a>}</span>
<span id="cb57-15"><a href="initial-parameters-for-em-algorithm.html#cb57-15" tabindex="-1"></a></span>
<span id="cb57-16"><a href="initial-parameters-for-em-algorithm.html#cb57-16" tabindex="-1"></a><span class="co">#' @param U ((T-l) x dimdat) matrix.</span></span>
<span id="cb57-17"><a href="initial-parameters-for-em-algorithm.html#cb57-17" tabindex="-1"></a><span id="U_update_W">U_update_W</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(U, rho, mu, W, l, Dl, TT){</span>
<span id="cb57-18"><a href="initial-parameters-for-em-algorithm.html#cb57-18" tabindex="-1"></a></span>
<span id="cb57-19"><a href="initial-parameters-for-em-algorithm.html#cb57-19" tabindex="-1"></a>  <span class="co"># l = 2 is quadratic trend filtering </span></span>
<span id="cb57-20"><a href="initial-parameters-for-em-algorithm.html#cb57-20" tabindex="-1"></a>  <span class="co"># l = 1 is linear trend filtering</span></span>
<span id="cb57-21"><a href="initial-parameters-for-em-algorithm.html#cb57-21" tabindex="-1"></a>  <span class="co"># l = 0 is fused lasso</span></span>
<span id="cb57-22"><a href="initial-parameters-for-em-algorithm.html#cb57-22" tabindex="-1"></a>  <span class="co"># D^{(1)} is first differences, so it correponds to l=0</span></span>
<span id="cb57-23"><a href="initial-parameters-for-em-algorithm.html#cb57-23" tabindex="-1"></a>  <span class="co"># D^{(l+1)} is used for order-l trend filtering.</span></span>
<span id="cb57-24"><a href="initial-parameters-for-em-algorithm.html#cb57-24" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">nrow</span>(W) <span class="sc">==</span> TT <span class="sc">-</span> l)</span>
<span id="cb57-25"><a href="initial-parameters-for-em-algorithm.html#cb57-25" tabindex="-1"></a>  <span class="do">## if(l == 0){</span></span>
<span id="cb57-26"><a href="initial-parameters-for-em-algorithm.html#cb57-26" tabindex="-1"></a>  <span class="do">##   Unew = U +  rho * (mu - W)</span></span>
<span id="cb57-27"><a href="initial-parameters-for-em-algorithm.html#cb57-27" tabindex="-1"></a>  <span class="do">## } else {</span></span>
<span id="cb57-28"><a href="initial-parameters-for-em-algorithm.html#cb57-28" tabindex="-1"></a>  <span class="do">##   Unew = U + rho * ( diff(mu, differences = l) - W)</span></span>
<span id="cb57-29"><a href="initial-parameters-for-em-algorithm.html#cb57-29" tabindex="-1"></a>  <span class="do">## }</span></span>
<span id="cb57-30"><a href="initial-parameters-for-em-algorithm.html#cb57-30" tabindex="-1"></a>  Unew <span class="ot">&lt;-</span> U <span class="sc">+</span> rho <span class="sc">*</span> (Dl <span class="sc">%*%</span> mu <span class="sc">-</span> W)</span>
<span id="cb57-31"><a href="initial-parameters-for-em-algorithm.html#cb57-31" tabindex="-1"></a></span>
<span id="cb57-32"><a href="initial-parameters-for-em-algorithm.html#cb57-32" tabindex="-1"></a>  <span class="do">## Expect a (T-l) x dimdat matrix.</span></span>
<span id="cb57-33"><a href="initial-parameters-for-em-algorithm.html#cb57-33" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="fu">dim</span>(U) <span class="sc">==</span> <span class="fu">dim</span>(Unew))) </span>
<span id="cb57-34"><a href="initial-parameters-for-em-algorithm.html#cb57-34" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">nrow</span>(U) <span class="sc">==</span> TT<span class="sc">-</span>l)</span>
<span id="cb57-35"><a href="initial-parameters-for-em-algorithm.html#cb57-35" tabindex="-1"></a>  <span class="fu">return</span>(Unew)</span>
<span id="cb57-36"><a href="initial-parameters-for-em-algorithm.html#cb57-36" tabindex="-1"></a>}</span></code></pre></div>
<p>Here is that main workhorse <code><a href="initial-parameters-for-em-algorithm.html#admm_oneclust">admm_oneclust</a>()</code>.</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="initial-parameters-for-em-algorithm.html#cb58-1" tabindex="-1"></a><span class="co">#' One cluster's admm for a fixed step size (rho).</span></span>
<span id="cb58-2"><a href="initial-parameters-for-em-algorithm.html#cb58-2" tabindex="-1"></a><span id="admm_oneclust">admm_oneclust</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">iclust =</span> <span class="dv">1</span>, niter, y,</span>
<span id="cb58-3"><a href="initial-parameters-for-em-algorithm.html#cb58-3" tabindex="-1"></a>                          Dl, tDl, Dlp1, <span class="at">l =</span> <span class="cn">NULL</span>,</span>
<span id="cb58-4"><a href="initial-parameters-for-em-algorithm.html#cb58-4" tabindex="-1"></a>                          TT, N, dimdat, maxdev,</span>
<span id="cb58-5"><a href="initial-parameters-for-em-algorithm.html#cb58-5" tabindex="-1"></a>                          rho,</span>
<span id="cb58-6"><a href="initial-parameters-for-em-algorithm.html#cb58-6" tabindex="-1"></a>                          <span class="at">rhoinit =</span> rho,</span>
<span id="cb58-7"><a href="initial-parameters-for-em-algorithm.html#cb58-7" tabindex="-1"></a>                          Xinv,</span>
<span id="cb58-8"><a href="initial-parameters-for-em-algorithm.html#cb58-8" tabindex="-1"></a>                          schurA,</span>
<span id="cb58-9"><a href="initial-parameters-for-em-algorithm.html#cb58-9" tabindex="-1"></a>                          schurB,</span>
<span id="cb58-10"><a href="initial-parameters-for-em-algorithm.html#cb58-10" tabindex="-1"></a>                          sigmainv,</span>
<span id="cb58-11"><a href="initial-parameters-for-em-algorithm.html#cb58-11" tabindex="-1"></a>                          lambda,</span>
<span id="cb58-12"><a href="initial-parameters-for-em-algorithm.html#cb58-12" tabindex="-1"></a>                          resp,</span>
<span id="cb58-13"><a href="initial-parameters-for-em-algorithm.html#cb58-13" tabindex="-1"></a>                          resp_sum,</span>
<span id="cb58-14"><a href="initial-parameters-for-em-algorithm.html#cb58-14" tabindex="-1"></a>                          ylist, <span class="at">err_rel =</span> <span class="fl">1e-3</span>, <span class="at">err_abs =</span> <span class="dv">0</span>,</span>
<span id="cb58-15"><a href="initial-parameters-for-em-algorithm.html#cb58-15" tabindex="-1"></a>                          zerothresh,</span>
<span id="cb58-16"><a href="initial-parameters-for-em-algorithm.html#cb58-16" tabindex="-1"></a>                          mu, </span>
<span id="cb58-17"><a href="initial-parameters-for-em-algorithm.html#cb58-17" tabindex="-1"></a>                          z,</span>
<span id="cb58-18"><a href="initial-parameters-for-em-algorithm.html#cb58-18" tabindex="-1"></a>                          w,</span>
<span id="cb58-19"><a href="initial-parameters-for-em-algorithm.html#cb58-19" tabindex="-1"></a>                          uw,</span>
<span id="cb58-20"><a href="initial-parameters-for-em-algorithm.html#cb58-20" tabindex="-1"></a>                          uz,</span>
<span id="cb58-21"><a href="initial-parameters-for-em-algorithm.html#cb58-21" tabindex="-1"></a>                          <span class="do">## warmstart = FALSE,</span></span>
<span id="cb58-22"><a href="initial-parameters-for-em-algorithm.html#cb58-22" tabindex="-1"></a>                          <span class="do">## mu.warm = if(!warmstart) NULL,</span></span>
<span id="cb58-23"><a href="initial-parameters-for-em-algorithm.html#cb58-23" tabindex="-1"></a>                          first_iter,<span class="do">## Not used </span></span>
<span id="cb58-24"><a href="initial-parameters-for-em-algorithm.html#cb58-24" tabindex="-1"></a>                          iter,</span>
<span id="cb58-25"><a href="initial-parameters-for-em-algorithm.html#cb58-25" tabindex="-1"></a>                          outer_iter,</span>
<span id="cb58-26"><a href="initial-parameters-for-em-algorithm.html#cb58-26" tabindex="-1"></a>                          local_adapt,</span>
<span id="cb58-27"><a href="initial-parameters-for-em-algorithm.html#cb58-27" tabindex="-1"></a>                          sigma,</span>
<span id="cb58-28"><a href="initial-parameters-for-em-algorithm.html#cb58-28" tabindex="-1"></a>                          sigma_eig_by_clust){</span>
<span id="cb58-29"><a href="initial-parameters-for-em-algorithm.html#cb58-29" tabindex="-1"></a></span>
<span id="cb58-30"><a href="initial-parameters-for-em-algorithm.html#cb58-30" tabindex="-1"></a>  <span class="do">## Initialize the variables </span><span class="al">###</span></span>
<span id="cb58-31"><a href="initial-parameters-for-em-algorithm.html#cb58-31" tabindex="-1"></a>  <span class="do">## resid_mat = matrix(NA, nrow = ceiling(niter/5), ncol = 4)</span></span>
<span id="cb58-32"><a href="initial-parameters-for-em-algorithm.html#cb58-32" tabindex="-1"></a>  <span class="do">## colnames(resid_mat) = c("primresid", "primerr", "dualresid", "dualerr")</span></span>
<span id="cb58-33"><a href="initial-parameters-for-em-algorithm.html#cb58-33" tabindex="-1"></a>  resid_mat <span class="ot">=</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">ceiling</span>(niter<span class="sc">/</span><span class="dv">5</span>), <span class="at">ncol =</span> <span class="dv">6</span>)</span>
<span id="cb58-34"><a href="initial-parameters-for-em-algorithm.html#cb58-34" tabindex="-1"></a>  <span class="fu">colnames</span>(resid_mat) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"prim1"</span>, <span class="st">"prim2"</span>, <span class="st">"primresid"</span>, <span class="st">"primerr"</span>, <span class="st">"dualresid"</span>, <span class="st">"dualerr"</span>)</span>
<span id="cb58-35"><a href="initial-parameters-for-em-algorithm.html#cb58-35" tabindex="-1"></a>  rhofac <span class="ot">=</span> rho <span class="sc">/</span> rhoinit </span>
<span id="cb58-36"><a href="initial-parameters-for-em-algorithm.html#cb58-36" tabindex="-1"></a></span>
<span id="cb58-37"><a href="initial-parameters-for-em-algorithm.html#cb58-37" tabindex="-1"></a>  </span>
<span id="cb58-38"><a href="initial-parameters-for-em-algorithm.html#cb58-38" tabindex="-1"></a></span>
<span id="cb58-39"><a href="initial-parameters-for-em-algorithm.html#cb58-39" tabindex="-1"></a>  <span class="do">## This doesn't change over iterations</span></span>
<span id="cb58-40"><a href="initial-parameters-for-em-algorithm.html#cb58-40" tabindex="-1"></a>  schurB <span class="ot">=</span> <a href="initial-parameters-for-em-algorithm.html#myschur">myschur</a>(schurB<span class="sc">$</span>orig <span class="sc">*</span> rhofac) <span class="do">## In flowmix, this is done on A. Here, it's done on B (in AX + XB + C = 0).</span></span>
<span id="cb58-41"><a href="initial-parameters-for-em-algorithm.html#cb58-41" tabindex="-1"></a>  TA <span class="ot">=</span> schurA<span class="sc">$</span>T <span class="do">##* rhofac</span></span>
<span id="cb58-42"><a href="initial-parameters-for-em-algorithm.html#cb58-42" tabindex="-1"></a>  TB <span class="ot">=</span> schurB<span class="sc">$</span>T</span>
<span id="cb58-43"><a href="initial-parameters-for-em-algorithm.html#cb58-43" tabindex="-1"></a>  UA <span class="ot">=</span> schurA<span class="sc">$</span>Q</span>
<span id="cb58-44"><a href="initial-parameters-for-em-algorithm.html#cb58-44" tabindex="-1"></a>  UB <span class="ot">=</span> schurB<span class="sc">$</span>Q</span>
<span id="cb58-45"><a href="initial-parameters-for-em-algorithm.html#cb58-45" tabindex="-1"></a>  tUA <span class="ot">=</span> schurA<span class="sc">$</span>tQ</span>
<span id="cb58-46"><a href="initial-parameters-for-em-algorithm.html#cb58-46" tabindex="-1"></a>  tUB <span class="ot">=</span> schurB<span class="sc">$</span>tQ</span>
<span id="cb58-47"><a href="initial-parameters-for-em-algorithm.html#cb58-47" tabindex="-1"></a></span>
<span id="cb58-48"><a href="initial-parameters-for-em-algorithm.html#cb58-48" tabindex="-1"></a>  <span class="do">## This also doesn't change over iterations</span></span>
<span id="cb58-49"><a href="initial-parameters-for-em-algorithm.html#cb58-49" tabindex="-1"></a>  C1 <span class="ot">&lt;-</span> <span class="fu">do.call</span>(cbind, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="at">FUN =</span> <span class="cf">function</span>(tt){</span>
<span id="cb58-50"><a href="initial-parameters-for-em-algorithm.html#cb58-50" tabindex="-1"></a>      multmat <span class="ot">&lt;-</span> <span class="fu">apply</span>(y[[tt]], <span class="at">FUN =</span> <span class="cf">function</span>(yy) yy <span class="sc">*</span> resp[[tt]], <span class="at">MARGIN =</span> <span class="dv">2</span>)</span>
<span id="cb58-51"><a href="initial-parameters-for-em-algorithm.html#cb58-51" tabindex="-1"></a>      sigmainv <span class="sc">%*%</span> <span class="fu">colSums</span>(multmat)</span>
<span id="cb58-52"><a href="initial-parameters-for-em-algorithm.html#cb58-52" tabindex="-1"></a>    }))</span>
<span id="cb58-53"><a href="initial-parameters-for-em-algorithm.html#cb58-53" tabindex="-1"></a></span>
<span id="cb58-54"><a href="initial-parameters-for-em-algorithm.html#cb58-54" tabindex="-1"></a></span>
<span id="cb58-55"><a href="initial-parameters-for-em-algorithm.html#cb58-55" tabindex="-1"></a>  <span class="cf">for</span>(iter <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>niter){</span>
<span id="cb58-56"><a href="initial-parameters-for-em-algorithm.html#cb58-56" tabindex="-1"></a>    syl_C <span class="ot">&lt;-</span> <a href="initial-parameters-for-em-algorithm.html#get_C_mat">get_C_mat</a>(<span class="at">C1 =</span> C1, <span class="at">resp_sum =</span> resp_sum, <span class="at">TT =</span> TT, <span class="at">dimdat =</span> dimdat,</span>
<span id="cb58-57"><a href="initial-parameters-for-em-algorithm.html#cb58-57" tabindex="-1"></a>                       <span class="at">Sigma_inv =</span> sigmainv, <span class="at">N =</span> N, <span class="at">Dl =</span> Dl, <span class="at">rho =</span> rho,</span>
<span id="cb58-58"><a href="initial-parameters-for-em-algorithm.html#cb58-58" tabindex="-1"></a>                       <span class="at">z =</span> z, <span class="at">w =</span> w, <span class="at">uz =</span> uz, <span class="at">uw =</span> uw, <span class="at">l=</span>l)</span>
<span id="cb58-59"><a href="initial-parameters-for-em-algorithm.html#cb58-59" tabindex="-1"></a>    FF <span class="ot">=</span>  (<span class="sc">-</span><span class="dv">1</span>) <span class="sc">*</span> tUA <span class="sc">%*%</span> syl_C <span class="sc">%*%</span> UB</span>
<span id="cb58-60"><a href="initial-parameters-for-em-algorithm.html#cb58-60" tabindex="-1"></a>    mu <span class="ot">=</span> UA <span class="sc">%*%</span> <span class="fu">matrix_function_solve_triangular_sylvester_barebonesC2</span>(TA, TB, FF) <span class="sc">%*%</span> tUB</span>
<span id="cb58-61"><a href="initial-parameters-for-em-algorithm.html#cb58-61" tabindex="-1"></a>    mu <span class="ot">=</span> <span class="fu">t</span>(mu)</span>
<span id="cb58-62"><a href="initial-parameters-for-em-algorithm.html#cb58-62" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">nrow</span>(mu) <span class="sc">==</span> TT)</span>
<span id="cb58-63"><a href="initial-parameters-for-em-algorithm.html#cb58-63" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">ncol</span>(mu) <span class="sc">==</span> dimdat)</span>
<span id="cb58-64"><a href="initial-parameters-for-em-algorithm.html#cb58-64" tabindex="-1"></a></span>
<span id="cb58-65"><a href="initial-parameters-for-em-algorithm.html#cb58-65" tabindex="-1"></a>    <span class="do">## if(warmstart &amp; iter == 1){</span></span>
<span id="cb58-66"><a href="initial-parameters-for-em-algorithm.html#cb58-66" tabindex="-1"></a>    <span class="do">##   print("warmed up mu!")</span></span>
<span id="cb58-67"><a href="initial-parameters-for-em-algorithm.html#cb58-67" tabindex="-1"></a>    <span class="do">##   mu = mu.warm</span></span>
<span id="cb58-68"><a href="initial-parameters-for-em-algorithm.html#cb58-68" tabindex="-1"></a>    <span class="do">## }</span></span>
<span id="cb58-69"><a href="initial-parameters-for-em-algorithm.html#cb58-69" tabindex="-1"></a></span>
<span id="cb58-70"><a href="initial-parameters-for-em-algorithm.html#cb58-70" tabindex="-1"></a>    centered_mu <span class="ot">=</span> <span class="fu">sweep</span>(mu, <span class="dv">2</span>, <span class="fu">colMeans</span>(mu)) </span>
<span id="cb58-71"><a href="initial-parameters-for-em-algorithm.html#cb58-71" tabindex="-1"></a>    <span class="do">## stopifnot(all(abs(colMeans(centered_mu))&lt;1E-8))</span></span>
<span id="cb58-72"><a href="initial-parameters-for-em-algorithm.html#cb58-72" tabindex="-1"></a>    z <span class="ot">&lt;-</span> <a href="initial-parameters-for-em-algorithm.html#Z_update">Z_update</a>(centered_mu, <span class="at">Uz =</span> uz, <span class="at">C =</span> maxdev, <span class="at">rho =</span> rho)</span>
<span id="cb58-73"><a href="initial-parameters-for-em-algorithm.html#cb58-73" tabindex="-1"></a></span>
<span id="cb58-74"><a href="initial-parameters-for-em-algorithm.html#cb58-74" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">abs</span>(mu)<span class="sc">&gt;</span><span class="fl">1E2</span>)){</span>
<span id="cb58-75"><a href="initial-parameters-for-em-algorithm.html#cb58-75" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">"mu is blowing up!"</span>)</span>
<span id="cb58-76"><a href="initial-parameters-for-em-algorithm.html#cb58-76" tabindex="-1"></a>      <span class="do">## break</span></span>
<span id="cb58-77"><a href="initial-parameters-for-em-algorithm.html#cb58-77" tabindex="-1"></a>    }</span>
<span id="cb58-78"><a href="initial-parameters-for-em-algorithm.html#cb58-78" tabindex="-1"></a>    wlist <span class="ot">=</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>dimdat, <span class="cf">function</span>(j){</span>
<span id="cb58-79"><a href="initial-parameters-for-em-algorithm.html#cb58-79" tabindex="-1"></a>      <a href="initial-parameters-for-em-algorithm.html#W_update_fused">W_update_fused</a>(<span class="at">l =</span> l, <span class="at">TT =</span> TT, <span class="at">mu =</span> mu[, j, <span class="at">drop =</span> <span class="cn">TRUE</span>],</span>
<span id="cb58-80"><a href="initial-parameters-for-em-algorithm.html#cb58-80" tabindex="-1"></a>                     <span class="at">rho =</span> rho, <span class="at">lambda =</span> lambda,</span>
<span id="cb58-81"><a href="initial-parameters-for-em-algorithm.html#cb58-81" tabindex="-1"></a>                     <span class="at">uw =</span> uw[,j,<span class="at">drop=</span><span class="cn">TRUE</span>],</span>
<span id="cb58-82"><a href="initial-parameters-for-em-algorithm.html#cb58-82" tabindex="-1"></a>                     <span class="at">Dl =</span> Dl)})</span>
<span id="cb58-83"><a href="initial-parameters-for-em-algorithm.html#cb58-83" tabindex="-1"></a>    w <span class="ot">&lt;-</span> <span class="fu">do.call</span>(cbind, wlist)</span>
<span id="cb58-84"><a href="initial-parameters-for-em-algorithm.html#cb58-84" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">nrow</span>(w) <span class="sc">==</span> TT<span class="sc">-</span>l)</span>
<span id="cb58-85"><a href="initial-parameters-for-em-algorithm.html#cb58-85" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">ncol</span>(w) <span class="sc">==</span> dimdat)</span>
<span id="cb58-86"><a href="initial-parameters-for-em-algorithm.html#cb58-86" tabindex="-1"></a></span>
<span id="cb58-87"><a href="initial-parameters-for-em-algorithm.html#cb58-87" tabindex="-1"></a></span>
<span id="cb58-88"><a href="initial-parameters-for-em-algorithm.html#cb58-88" tabindex="-1"></a>    uz <span class="ot">=</span> <a href="initial-parameters-for-em-algorithm.html#U_update_Z">U_update_Z</a>(uz, rho, mu, z, TT)</span>
<span id="cb58-89"><a href="initial-parameters-for-em-algorithm.html#cb58-89" tabindex="-1"></a></span>
<span id="cb58-90"><a href="initial-parameters-for-em-algorithm.html#cb58-90" tabindex="-1"></a></span>
<span id="cb58-91"><a href="initial-parameters-for-em-algorithm.html#cb58-91" tabindex="-1"></a>    <span class="do">## uw = <a href="initial-parameters-for-em-algorithm.html#U_update_W">U_update_W</a>(uw, rho, mu, w, l, TT)</span></span>
<span id="cb58-92"><a href="initial-parameters-for-em-algorithm.html#cb58-92" tabindex="-1"></a>    uw <span class="ot">=</span> <a href="initial-parameters-for-em-algorithm.html#U_update_W">U_update_W</a>(uw, rho, mu, w, l, Dl, TT)</span>
<span id="cb58-93"><a href="initial-parameters-for-em-algorithm.html#cb58-93" tabindex="-1"></a></span>
<span id="cb58-94"><a href="initial-parameters-for-em-algorithm.html#cb58-94" tabindex="-1"></a></span>
<span id="cb58-95"><a href="initial-parameters-for-em-algorithm.html#cb58-95" tabindex="-1"></a>    <span class="do">## Check convergence</span></span>
<span id="cb58-96"><a href="initial-parameters-for-em-algorithm.html#cb58-96" tabindex="-1"></a>    <span class="cf">if</span>( iter <span class="sc">&gt;</span> <span class="dv">1</span>  <span class="sc">&amp;</span> iter <span class="sc">%%</span> <span class="dv">5</span> <span class="sc">==</span> <span class="dv">0</span>){<span class="do">## &amp; !local_adapt){</span></span>
<span id="cb58-97"><a href="initial-parameters-for-em-algorithm.html#cb58-97" tabindex="-1"></a></span>
<span id="cb58-98"><a href="initial-parameters-for-em-algorithm.html#cb58-98" tabindex="-1"></a>      <span class="do">## Calculate convergence criterion</span></span>
<span id="cb58-99"><a href="initial-parameters-for-em-algorithm.html#cb58-99" tabindex="-1"></a>      obj <span class="ot">=</span> <a href="initial-parameters-for-em-algorithm.html#check_converge">check_converge</a>(mu, rho,</span>
<span id="cb58-100"><a href="initial-parameters-for-em-algorithm.html#cb58-100" tabindex="-1"></a>                           w, z,</span>
<span id="cb58-101"><a href="initial-parameters-for-em-algorithm.html#cb58-101" tabindex="-1"></a>                           w_prev, z_prev,</span>
<span id="cb58-102"><a href="initial-parameters-for-em-algorithm.html#cb58-102" tabindex="-1"></a>                           uw, uz,</span>
<span id="cb58-103"><a href="initial-parameters-for-em-algorithm.html#cb58-103" tabindex="-1"></a>                           Dl, tDl, <span class="at">err_rel =</span> err_rel, <span class="at">err_abs =</span> err_abs)</span>
<span id="cb58-104"><a href="initial-parameters-for-em-algorithm.html#cb58-104" tabindex="-1"></a></span>
<span id="cb58-105"><a href="initial-parameters-for-em-algorithm.html#cb58-105" tabindex="-1"></a>      jj <span class="ot">=</span> (iter<span class="sc">/</span> <span class="dv">5</span>)</span>
<span id="cb58-106"><a href="initial-parameters-for-em-algorithm.html#cb58-106" tabindex="-1"></a>      resid_mat[jj,] <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb58-107"><a href="initial-parameters-for-em-algorithm.html#cb58-107" tabindex="-1"></a>          <span class="fu">norm</span>(obj<span class="sc">$</span>primal_resid1, <span class="st">"F"</span>), <span class="do">## Temp</span></span>
<span id="cb58-108"><a href="initial-parameters-for-em-algorithm.html#cb58-108" tabindex="-1"></a>          <span class="fu">norm</span>(obj<span class="sc">$</span>primal_resid2, <span class="st">"F"</span>), <span class="do">## Temp</span></span>
<span id="cb58-109"><a href="initial-parameters-for-em-algorithm.html#cb58-109" tabindex="-1"></a>          <span class="fu">norm</span>(obj<span class="sc">$</span>primal_resid, <span class="st">"F"</span>),</span>
<span id="cb58-110"><a href="initial-parameters-for-em-algorithm.html#cb58-110" tabindex="-1"></a>                         obj<span class="sc">$</span>primal_err,</span>
<span id="cb58-111"><a href="initial-parameters-for-em-algorithm.html#cb58-111" tabindex="-1"></a>                         <span class="fu">norm</span>(obj<span class="sc">$</span>dual_resid,<span class="st">"F"</span>),</span>
<span id="cb58-112"><a href="initial-parameters-for-em-algorithm.html#cb58-112" tabindex="-1"></a>                         obj<span class="sc">$</span>dual_err)</span>
<span id="cb58-113"><a href="initial-parameters-for-em-algorithm.html#cb58-113" tabindex="-1"></a></span>
<span id="cb58-114"><a href="initial-parameters-for-em-algorithm.html#cb58-114" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">is.na</span>(obj<span class="sc">$</span>converge)){</span>
<span id="cb58-115"><a href="initial-parameters-for-em-algorithm.html#cb58-115" tabindex="-1"></a>        obj<span class="sc">$</span>converge <span class="ot">=</span> converge <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb58-116"><a href="initial-parameters-for-em-algorithm.html#cb58-116" tabindex="-1"></a>        <span class="fu">warning</span>(<span class="st">"Convergence was NA"</span>)</span>
<span id="cb58-117"><a href="initial-parameters-for-em-algorithm.html#cb58-117" tabindex="-1"></a>      }</span>
<span id="cb58-118"><a href="initial-parameters-for-em-algorithm.html#cb58-118" tabindex="-1"></a>      <span class="cf">if</span>(obj<span class="sc">$</span>converge){</span>
<span id="cb58-119"><a href="initial-parameters-for-em-algorithm.html#cb58-119" tabindex="-1"></a>        converge <span class="ot">=</span> <span class="cn">TRUE</span></span>
<span id="cb58-120"><a href="initial-parameters-for-em-algorithm.html#cb58-120" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb58-121"><a href="initial-parameters-for-em-algorithm.html#cb58-121" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb58-122"><a href="initial-parameters-for-em-algorithm.html#cb58-122" tabindex="-1"></a>        converge <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb58-123"><a href="initial-parameters-for-em-algorithm.html#cb58-123" tabindex="-1"></a>      }</span>
<span id="cb58-124"><a href="initial-parameters-for-em-algorithm.html#cb58-124" tabindex="-1"></a>    }</span>
<span id="cb58-125"><a href="initial-parameters-for-em-algorithm.html#cb58-125" tabindex="-1"></a>    w_prev <span class="ot">=</span> w</span>
<span id="cb58-126"><a href="initial-parameters-for-em-algorithm.html#cb58-126" tabindex="-1"></a>    z_prev <span class="ot">=</span> z</span>
<span id="cb58-127"><a href="initial-parameters-for-em-algorithm.html#cb58-127" tabindex="-1"></a>  }</span>
<span id="cb58-128"><a href="initial-parameters-for-em-algorithm.html#cb58-128" tabindex="-1"></a></span>
<span id="cb58-129"><a href="initial-parameters-for-em-algorithm.html#cb58-129" tabindex="-1"></a>  <span class="cf">if</span>(<span class="cn">FALSE</span>){</span>
<span id="cb58-130"><a href="initial-parameters-for-em-algorithm.html#cb58-130" tabindex="-1"></a>    <span class="do">## Calculate optimization objective values for this cluster.</span></span>
<span id="cb58-131"><a href="initial-parameters-for-em-algorithm.html#cb58-131" tabindex="-1"></a>    obj.value <span class="ot">&lt;-</span> <a href="initial-parameters-for-em-algorithm.html#objective_per_cluster">objective_per_cluster</a>(<span class="at">y =</span> y, <span class="at">mu =</span> mu, <span class="at">resp =</span> resp,</span>
<span id="cb58-132"><a href="initial-parameters-for-em-algorithm.html#cb58-132" tabindex="-1"></a>                                       <span class="at">Sigma_inv =</span> sigmainv, <span class="at">TT =</span> TT,</span>
<span id="cb58-133"><a href="initial-parameters-for-em-algorithm.html#cb58-133" tabindex="-1"></a>                                       <span class="at">d =</span> dimdat, <span class="at">Dlp1 =</span> Dlp1, <span class="at">Dl =</span> Dl, <span class="at">l =</span> l,</span>
<span id="cb58-134"><a href="initial-parameters-for-em-algorithm.html#cb58-134" tabindex="-1"></a>                                       <span class="at">maxdev =</span> maxdev, <span class="at">lambda =</span> lambda,</span>
<span id="cb58-135"><a href="initial-parameters-for-em-algorithm.html#cb58-135" tabindex="-1"></a>                                       <span class="at">rho =</span> rho, <span class="at">N =</span> N)</span>
<span id="cb58-136"><a href="initial-parameters-for-em-algorithm.html#cb58-136" tabindex="-1"></a>    <span class="do">## This is very expensive to do within each ADMM iteration, so it's commented out for now.</span></span>
<span id="cb58-137"><a href="initial-parameters-for-em-algorithm.html#cb58-137" tabindex="-1"></a>  }</span>
<span id="cb58-138"><a href="initial-parameters-for-em-algorithm.html#cb58-138" tabindex="-1"></a>  obj.value <span class="ot">=</span> <span class="cn">NA</span></span>
<span id="cb58-139"><a href="initial-parameters-for-em-algorithm.html#cb58-139" tabindex="-1"></a></span>
<span id="cb58-140"><a href="initial-parameters-for-em-algorithm.html#cb58-140" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">mu =</span> mu,</span>
<span id="cb58-141"><a href="initial-parameters-for-em-algorithm.html#cb58-141" tabindex="-1"></a>              <span class="at">resid_mat =</span> resid_mat,</span>
<span id="cb58-142"><a href="initial-parameters-for-em-algorithm.html#cb58-142" tabindex="-1"></a>              <span class="at">converge =</span> converge,</span>
<span id="cb58-143"><a href="initial-parameters-for-em-algorithm.html#cb58-143" tabindex="-1"></a>              <span class="do">## Other variables to return.</span></span>
<span id="cb58-144"><a href="initial-parameters-for-em-algorithm.html#cb58-144" tabindex="-1"></a>              <span class="at">Z =</span> z,</span>
<span id="cb58-145"><a href="initial-parameters-for-em-algorithm.html#cb58-145" tabindex="-1"></a>              <span class="at">W =</span> w,</span>
<span id="cb58-146"><a href="initial-parameters-for-em-algorithm.html#cb58-146" tabindex="-1"></a>              <span class="at">uz =</span> uz,</span>
<span id="cb58-147"><a href="initial-parameters-for-em-algorithm.html#cb58-147" tabindex="-1"></a>              <span class="at">uw =</span> uw,</span>
<span id="cb58-148"><a href="initial-parameters-for-em-algorithm.html#cb58-148" tabindex="-1"></a>              <span class="at">inner.iter =</span> iter,</span>
<span id="cb58-149"><a href="initial-parameters-for-em-algorithm.html#cb58-149" tabindex="-1"></a>              <span class="at">single_admm_objective =</span> obj.value))</span>
<span id="cb58-150"><a href="initial-parameters-for-em-algorithm.html#cb58-150" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="helpers-for-m-step-mu" class="section level3 hasAnchor" number="4.2.4">
<h3>
<span class="header-section-number">4.2.4</span> Helpers for M step (<span class="math inline">\(\mu\)</span>)<a href="initial-parameters-for-em-algorithm.html#helpers-for-m-step-mu" class="anchor-section" aria-label="Anchor link to header"></a>
</h3>
<p>First, let’s start with a few helper functions.</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="initial-parameters-for-em-algorithm.html#cb59-1" tabindex="-1"></a><span class="co">#' @param TT Number of time points.</span></span>
<span id="cb59-2"><a href="initial-parameters-for-em-algorithm.html#cb59-2" tabindex="-1"></a><span id="etilde_mat">etilde_mat</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(TT){</span>
<span id="cb59-3"><a href="initial-parameters-for-em-algorithm.html#cb59-3" tabindex="-1"></a></span>
<span id="cb59-4"><a href="initial-parameters-for-em-algorithm.html#cb59-4" tabindex="-1"></a>  mats <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="at">FUN =</span> <span class="cf">function</span>(t){</span>
<span id="cb59-5"><a href="initial-parameters-for-em-algorithm.html#cb59-5" tabindex="-1"></a>    e_vec <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, TT)</span>
<span id="cb59-6"><a href="initial-parameters-for-em-algorithm.html#cb59-6" tabindex="-1"></a>    e_vec[t] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb59-7"><a href="initial-parameters-for-em-algorithm.html#cb59-7" tabindex="-1"></a>    (e_vec <span class="sc">-</span> <span class="dv">1</span><span class="sc">/</span>TT) <span class="sc">%*%</span> <span class="fu">t</span>(e_vec <span class="sc">-</span> <span class="dv">1</span><span class="sc">/</span>TT)</span>
<span id="cb59-8"><a href="initial-parameters-for-em-algorithm.html#cb59-8" tabindex="-1"></a>  })</span>
<span id="cb59-9"><a href="initial-parameters-for-em-algorithm.html#cb59-9" tabindex="-1"></a>  <span class="fu">Reduce</span>(<span class="st">'+'</span>, mats)</span>
<span id="cb59-10"><a href="initial-parameters-for-em-algorithm.html#cb59-10" tabindex="-1"></a>}</span>
<span id="cb59-11"><a href="initial-parameters-for-em-algorithm.html#cb59-11" tabindex="-1"></a></span>
<span id="cb59-12"><a href="initial-parameters-for-em-algorithm.html#cb59-12" tabindex="-1"></a><span id="get_AB_mats">get_AB_mats</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(y, resp, Sigma_inv, e_mat, Dlsqrd, N, Dlp1, Dl, rho, z, w, uz, uw){</span>
<span id="cb59-13"><a href="initial-parameters-for-em-algorithm.html#cb59-13" tabindex="-1"></a></span>
<span id="cb59-14"><a href="initial-parameters-for-em-algorithm.html#cb59-14" tabindex="-1"></a>  <span class="co"># A matrix</span></span>
<span id="cb59-15"><a href="initial-parameters-for-em-algorithm.html#cb59-15" tabindex="-1"></a>  A <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>N <span class="sc">*</span> Sigma_inv</span>
<span id="cb59-16"><a href="initial-parameters-for-em-algorithm.html#cb59-16" tabindex="-1"></a></span>
<span id="cb59-17"><a href="initial-parameters-for-em-algorithm.html#cb59-17" tabindex="-1"></a>  <span class="co"># B matrix</span></span>
<span id="cb59-18"><a href="initial-parameters-for-em-algorithm.html#cb59-18" tabindex="-1"></a>  sum_resp <span class="ot">&lt;-</span> <span class="fu">sapply</span>(resp, sum)</span>
<span id="cb59-19"><a href="initial-parameters-for-em-algorithm.html#cb59-19" tabindex="-1"></a>  <span class="co">#B &lt;- rho*(t(Dl)%*%Dl + e_mat)%*% diag(1/unlist(sum_resp))</span></span>
<span id="cb59-20"><a href="initial-parameters-for-em-algorithm.html#cb59-20" tabindex="-1"></a>  B <span class="ot">&lt;-</span> rho<span class="sc">*</span>(Dlsqrd <span class="sc">+</span> e_mat)</span>
<span id="cb59-21"><a href="initial-parameters-for-em-algorithm.html#cb59-21" tabindex="-1"></a>  B <span class="ot">&lt;-</span> B<span class="sc">/</span>sum_resp[<span class="fu">col</span>(B)]</span>
<span id="cb59-22"><a href="initial-parameters-for-em-algorithm.html#cb59-22" tabindex="-1"></a>  <span class="co">#B &lt;- rho*(Dlsqrd + e_mat)  %*% diag(1/unlist(sum_resp))</span></span>
<span id="cb59-23"><a href="initial-parameters-for-em-algorithm.html#cb59-23" tabindex="-1"></a></span>
<span id="cb59-24"><a href="initial-parameters-for-em-algorithm.html#cb59-24" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">A =</span> A, <span class="at">B =</span> B))</span>
<span id="cb59-25"><a href="initial-parameters-for-em-algorithm.html#cb59-25" tabindex="-1"></a>}</span>
<span id="cb59-26"><a href="initial-parameters-for-em-algorithm.html#cb59-26" tabindex="-1"></a></span>
<span id="cb59-27"><a href="initial-parameters-for-em-algorithm.html#cb59-27" tabindex="-1"></a><span id="get_C_mat">get_C_mat</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(C1, resp_sum, TT, dimdat, Sigma_inv, e_mat, N, Dlp1, Dl,</span>
<span id="cb59-28"><a href="initial-parameters-for-em-algorithm.html#cb59-28" tabindex="-1"></a>                      rho, z, w, uz, uw, l){</span>
<span id="cb59-29"><a href="initial-parameters-for-em-algorithm.html#cb59-29" tabindex="-1"></a></span>
<span id="cb59-30"><a href="initial-parameters-for-em-algorithm.html#cb59-30" tabindex="-1"></a>  C2 <span class="ot">&lt;-</span> <span class="fu">t</span>(uz <span class="sc">-</span> rho<span class="sc">*</span>z)</span>
<span id="cb59-31"><a href="initial-parameters-for-em-algorithm.html#cb59-31" tabindex="-1"></a></span>
<span id="cb59-32"><a href="initial-parameters-for-em-algorithm.html#cb59-32" tabindex="-1"></a>  <span class="co"># averaging</span></span>
<span id="cb59-33"><a href="initial-parameters-for-em-algorithm.html#cb59-33" tabindex="-1"></a>  C2 <span class="ot">&lt;-</span> C2 <span class="sc">-</span> <span class="fu">rowMeans</span>(C2)</span>
<span id="cb59-34"><a href="initial-parameters-for-em-algorithm.html#cb59-34" tabindex="-1"></a></span>
<span id="cb59-35"><a href="initial-parameters-for-em-algorithm.html#cb59-35" tabindex="-1"></a>  <span class="co"># third component</span></span>
<span id="cb59-36"><a href="initial-parameters-for-em-algorithm.html#cb59-36" tabindex="-1"></a>  C3 <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>dimdat, <span class="at">FUN =</span> <span class="cf">function</span>(j){</span>
<span id="cb59-37"><a href="initial-parameters-for-em-algorithm.html#cb59-37" tabindex="-1"></a>    ((uw[,j, <span class="at">drop=</span><span class="cn">TRUE</span>] <span class="sc">-</span> rho <span class="sc">*</span> w[,j,<span class="at">drop=</span><span class="cn">TRUE</span>]) <span class="sc">%*%</span> Dl) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb59-38"><a href="initial-parameters-for-em-algorithm.html#cb59-38" tabindex="-1"></a>  }))</span>
<span id="cb59-39"><a href="initial-parameters-for-em-algorithm.html#cb59-39" tabindex="-1"></a></span>
<span id="cb59-40"><a href="initial-parameters-for-em-algorithm.html#cb59-40" tabindex="-1"></a>  <span class="co"># combining</span></span>
<span id="cb59-41"><a href="initial-parameters-for-em-algorithm.html#cb59-41" tabindex="-1"></a>  C <span class="ot">&lt;-</span>  (<span class="sc">-</span><span class="dv">1</span><span class="sc">/</span>N <span class="sc">*</span> C1 <span class="sc">+</span> C2 <span class="sc">+</span> C3)</span>
<span id="cb59-42"><a href="initial-parameters-for-em-algorithm.html#cb59-42" tabindex="-1"></a>  C <span class="ot">&lt;-</span> C<span class="sc">/</span>resp_sum[<span class="fu">col</span>(C)]</span>
<span id="cb59-43"><a href="initial-parameters-for-em-algorithm.html#cb59-43" tabindex="-1"></a>  <span class="fu">return</span>(C)</span>
<span id="cb59-44"><a href="initial-parameters-for-em-algorithm.html#cb59-44" tabindex="-1"></a>}</span>
<span id="cb59-45"><a href="initial-parameters-for-em-algorithm.html#cb59-45" tabindex="-1"></a></span>
<span id="cb59-46"><a href="initial-parameters-for-em-algorithm.html#cb59-46" tabindex="-1"></a></span>
<span id="cb59-47"><a href="initial-parameters-for-em-algorithm.html#cb59-47" tabindex="-1"></a><span class="co">#' @param mat Matrix to Schur-decompose.</span></span>
<span id="cb59-48"><a href="initial-parameters-for-em-algorithm.html#cb59-48" tabindex="-1"></a><span id="myschur">myschur</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(mat){</span>
<span id="cb59-49"><a href="initial-parameters-for-em-algorithm.html#cb59-49" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">nrow</span>(mat) <span class="sc">==</span> <span class="fu">ncol</span>(mat))</span>
<span id="cb59-50"><a href="initial-parameters-for-em-algorithm.html#cb59-50" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.numeric</span>(mat) <span class="sc">&amp;</span> <span class="fu">length</span>(mat)<span class="sc">==</span><span class="dv">1</span>) mat <span class="ot">=</span> mat <span class="sc">%&gt;%</span> <span class="fu">as.matrix</span>()</span>
<span id="cb59-51"><a href="initial-parameters-for-em-algorithm.html#cb59-51" tabindex="-1"></a>  obj <span class="ot">=</span> Matrix<span class="sc">::</span><span class="fu">Schur</span>(mat)</span>
<span id="cb59-52"><a href="initial-parameters-for-em-algorithm.html#cb59-52" tabindex="-1"></a>  obj<span class="sc">$</span>tQ <span class="ot">=</span> <span class="fu">t</span>(obj<span class="sc">$</span>Q)</span>
<span id="cb59-53"><a href="initial-parameters-for-em-algorithm.html#cb59-53" tabindex="-1"></a>  obj<span class="sc">$</span>orig <span class="ot">=</span> mat</span>
<span id="cb59-54"><a href="initial-parameters-for-em-algorithm.html#cb59-54" tabindex="-1"></a>  <span class="fu">return</span>(obj)</span>
<span id="cb59-55"><a href="initial-parameters-for-em-algorithm.html#cb59-55" tabindex="-1"></a>}</span></code></pre></div>
<p>Here’s a function to check convergence of the ADMM with a fixed step size.</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="initial-parameters-for-em-algorithm.html#cb60-1" tabindex="-1"></a><span class="co">#' Check convergence of ADMM with a fixed step size (rho).</span></span>
<span id="cb60-2"><a href="initial-parameters-for-em-algorithm.html#cb60-2" tabindex="-1"></a><span id="check_converge">check_converge</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(mu, rho, w, z, w_prev, z_prev, uw, uz, Dl, tDl,</span>
<span id="cb60-3"><a href="initial-parameters-for-em-algorithm.html#cb60-3" tabindex="-1"></a>                     <span class="at">err_rel =</span> <span class="fl">1E-4</span>,</span>
<span id="cb60-4"><a href="initial-parameters-for-em-algorithm.html#cb60-4" tabindex="-1"></a>                     <span class="at">err_abs =</span> <span class="dv">0</span></span>
<span id="cb60-5"><a href="initial-parameters-for-em-algorithm.html#cb60-5" tabindex="-1"></a>){</span>
<span id="cb60-6"><a href="initial-parameters-for-em-algorithm.html#cb60-6" tabindex="-1"></a></span>
<span id="cb60-7"><a href="initial-parameters-for-em-algorithm.html#cb60-7" tabindex="-1"></a>  <span class="do">## Constraints are: Ax + Bz =c, where x = mu, z =(w, z)</span></span>
<span id="cb60-8"><a href="initial-parameters-for-em-algorithm.html#cb60-8" tabindex="-1"></a>  prim1 <span class="ot">=</span> <span class="fu">rbind</span>(Dl <span class="sc">%*%</span> mu, mu <span class="sc">-</span> <span class="fu">colMeans</span>(mu))</span>
<span id="cb60-9"><a href="initial-parameters-for-em-algorithm.html#cb60-9" tabindex="-1"></a>  prim2 <span class="ot">=</span> <span class="fu">rbind</span>(<span class="sc">-</span>w, <span class="sc">-</span>z)</span>
<span id="cb60-10"><a href="initial-parameters-for-em-algorithm.html#cb60-10" tabindex="-1"></a>  primal_resid <span class="ot">=</span> prim1 <span class="sc">+</span> prim2   <span class="do">## Ax + Bz - c</span></span>
<span id="cb60-11"><a href="initial-parameters-for-em-algorithm.html#cb60-11" tabindex="-1"></a></span>
<span id="cb60-12"><a href="initial-parameters-for-em-algorithm.html#cb60-12" tabindex="-1"></a>  change_z <span class="ot">=</span> z <span class="sc">-</span> z_prev</span>
<span id="cb60-13"><a href="initial-parameters-for-em-algorithm.html#cb60-13" tabindex="-1"></a>  change_w <span class="ot">=</span> w <span class="sc">-</span> w_prev</span>
<span id="cb60-14"><a href="initial-parameters-for-em-algorithm.html#cb60-14" tabindex="-1"></a>  dual_resid <span class="ot">=</span> rho <span class="sc">*</span> (<span class="sc">-</span>(change_z <span class="sc">-</span> <span class="fu">colMeans</span>(change_z)) <span class="sc">-</span> tDl <span class="sc">%*%</span> change_w)</span>
<span id="cb60-15"><a href="initial-parameters-for-em-algorithm.html#cb60-15" tabindex="-1"></a>  tAU <span class="ot">=</span> (uz <span class="sc">-</span> <span class="fu">colMeans</span>(uz)) <span class="sc">+</span> tDl <span class="sc">%*%</span> uw</span>
<span id="cb60-16"><a href="initial-parameters-for-em-algorithm.html#cb60-16" tabindex="-1"></a>         </span>
<span id="cb60-17"><a href="initial-parameters-for-em-algorithm.html#cb60-17" tabindex="-1"></a>  <span class="do">## Form primal and dual tolerances.</span></span>
<span id="cb60-18"><a href="initial-parameters-for-em-algorithm.html#cb60-18" tabindex="-1"></a>  primal_err <span class="ot">=</span> <span class="fu">sqrt</span>(<span class="fu">length</span>(primal_resid)) <span class="sc">*</span> err_abs <span class="sc">+</span></span>
<span id="cb60-19"><a href="initial-parameters-for-em-algorithm.html#cb60-19" tabindex="-1"></a>    err_rel <span class="sc">*</span> <span class="fu">max</span>(<span class="fu">norm</span>(prim1, <span class="st">"F"</span>), <span class="fu">norm</span>(prim2, <span class="st">"F"</span>))</span>
<span id="cb60-20"><a href="initial-parameters-for-em-algorithm.html#cb60-20" tabindex="-1"></a>  dual_err <span class="ot">=</span> <span class="fu">sqrt</span>(<span class="fu">length</span>(dual_resid)) <span class="sc">*</span> err_abs <span class="sc">+</span></span>
<span id="cb60-21"><a href="initial-parameters-for-em-algorithm.html#cb60-21" tabindex="-1"></a>    err_rel <span class="sc">*</span> <span class="fu">norm</span>(tAU, <span class="st">"F"</span>)</span>
<span id="cb60-22"><a href="initial-parameters-for-em-algorithm.html#cb60-22" tabindex="-1"></a></span>
<span id="cb60-23"><a href="initial-parameters-for-em-algorithm.html#cb60-23" tabindex="-1"></a>  <span class="do">## Check convergence.</span></span>
<span id="cb60-24"><a href="initial-parameters-for-em-algorithm.html#cb60-24" tabindex="-1"></a>  primal_resid_size <span class="ot">=</span> <span class="fu">norm</span>(primal_resid, <span class="st">"F"</span>)</span>
<span id="cb60-25"><a href="initial-parameters-for-em-algorithm.html#cb60-25" tabindex="-1"></a>  dual_resid_size <span class="ot">=</span> <span class="fu">norm</span>(dual_resid, <span class="st">"F"</span>)</span>
<span id="cb60-26"><a href="initial-parameters-for-em-algorithm.html#cb60-26" tabindex="-1"></a>  primal_converge <span class="ot">=</span> ( primal_resid_size  <span class="sc">&lt;=</span> primal_err )</span>
<span id="cb60-27"><a href="initial-parameters-for-em-algorithm.html#cb60-27" tabindex="-1"></a>  dual_converge <span class="ot">=</span> ( dual_resid_size <span class="sc">&lt;=</span> dual_err )</span>
<span id="cb60-28"><a href="initial-parameters-for-em-algorithm.html#cb60-28" tabindex="-1"></a></span>
<span id="cb60-29"><a href="initial-parameters-for-em-algorithm.html#cb60-29" tabindex="-1"></a>  <span class="do">## Some checks (trying to address problems with |converge|).</span></span>
<span id="cb60-30"><a href="initial-parameters-for-em-algorithm.html#cb60-30" tabindex="-1"></a>  assertthat<span class="sc">::</span><span class="fu">assert_that</span>(<span class="fu">is.numeric</span>(primal_resid_size))</span>
<span id="cb60-31"><a href="initial-parameters-for-em-algorithm.html#cb60-31" tabindex="-1"></a>  assertthat<span class="sc">::</span><span class="fu">assert_that</span>(<span class="fu">is.numeric</span>(primal_err))</span>
<span id="cb60-32"><a href="initial-parameters-for-em-algorithm.html#cb60-32" tabindex="-1"></a>  assertthat<span class="sc">::</span><span class="fu">assert_that</span>(<span class="fu">is.numeric</span>(dual_resid_size))</span>
<span id="cb60-33"><a href="initial-parameters-for-em-algorithm.html#cb60-33" tabindex="-1"></a>  assertthat<span class="sc">::</span><span class="fu">assert_that</span>(<span class="fu">is.numeric</span>(dual_err))</span>
<span id="cb60-34"><a href="initial-parameters-for-em-algorithm.html#cb60-34" tabindex="-1"></a></span>
<span id="cb60-35"><a href="initial-parameters-for-em-algorithm.html#cb60-35" tabindex="-1"></a>  <span class="do">## return(primal_converge &amp; dual_converge)</span></span>
<span id="cb60-36"><a href="initial-parameters-for-em-algorithm.html#cb60-36" tabindex="-1"></a>  converge <span class="ot">=</span> primal_converge <span class="sc">&amp;</span> dual_converge</span>
<span id="cb60-37"><a href="initial-parameters-for-em-algorithm.html#cb60-37" tabindex="-1"></a></span>
<span id="cb60-38"><a href="initial-parameters-for-em-algorithm.html#cb60-38" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb60-39"><a href="initial-parameters-for-em-algorithm.html#cb60-39" tabindex="-1"></a>      <span class="at">primal_resid1 =</span> prim1,</span>
<span id="cb60-40"><a href="initial-parameters-for-em-algorithm.html#cb60-40" tabindex="-1"></a>      <span class="at">primal_resid2 =</span> prim2,</span>
<span id="cb60-41"><a href="initial-parameters-for-em-algorithm.html#cb60-41" tabindex="-1"></a>      <span class="at">primal_resid =</span> primal_resid,</span>
<span id="cb60-42"><a href="initial-parameters-for-em-algorithm.html#cb60-42" tabindex="-1"></a>      <span class="at">primal_err =</span> primal_err,</span>
<span id="cb60-43"><a href="initial-parameters-for-em-algorithm.html#cb60-43" tabindex="-1"></a>      <span class="at">dual_resid =</span> dual_resid,</span>
<span id="cb60-44"><a href="initial-parameters-for-em-algorithm.html#cb60-44" tabindex="-1"></a>      <span class="at">dual_err =</span> dual_err,</span>
<span id="cb60-45"><a href="initial-parameters-for-em-algorithm.html#cb60-45" tabindex="-1"></a>      <span class="at">converge =</span> converge))</span>
<span id="cb60-46"><a href="initial-parameters-for-em-algorithm.html#cb60-46" tabindex="-1"></a>}</span></code></pre></div>
<p>Here’s a function to compute the augmented Lagrangian of the M-step (this is not used for now).</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="initial-parameters-for-em-algorithm.html#cb61-1" tabindex="-1"></a><span class="co">#' computes the Augmented lagrangian.</span></span>
<span id="cb61-2"><a href="initial-parameters-for-em-algorithm.html#cb61-2" tabindex="-1"></a><span id="aug_lagr">aug_lagr</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(y, TT, d, z, w, l, uz, uw, mu, resp, Sigma_inv, Dlp1, Dl, maxdev, lambda, rho, N){</span>
<span id="cb61-3"><a href="initial-parameters-for-em-algorithm.html#cb61-3" tabindex="-1"></a>  mu_dd <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(mu)</span>
<span id="cb61-4"><a href="initial-parameters-for-em-algorithm.html#cb61-4" tabindex="-1"></a></span>
<span id="cb61-5"><a href="initial-parameters-for-em-algorithm.html#cb61-5" tabindex="-1"></a>  <span class="co"># Check the Z's for ball constraint, up to a tolerance of 1e-4</span></span>
<span id="cb61-6"><a href="initial-parameters-for-em-algorithm.html#cb61-6" tabindex="-1"></a>  znorms <span class="ot">&lt;-</span> <span class="fu">apply</span>(z, <span class="at">FUN =</span> <span class="cf">function</span>(zz) <span class="fu">sqrt</span>(<span class="fu">sum</span>(zz<span class="sc">^</span><span class="dv">2</span>)), <span class="at">MARGIN =</span> <span class="dv">1</span>)</span>
<span id="cb61-7"><a href="initial-parameters-for-em-algorithm.html#cb61-7" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">is.na</span>(znorms))) <span class="fu">browser</span>()</span>
<span id="cb61-8"><a href="initial-parameters-for-em-algorithm.html#cb61-8" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">any</span>(znorms <span class="sc">&gt;</span> (maxdev <span class="sc">+</span> <span class="fl">1e-4</span>))){</span>
<span id="cb61-9"><a href="initial-parameters-for-em-algorithm.html#cb61-9" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="st">"||z||_2 &gt; maxdev, current iterate not feasible."</span>)</span>
<span id="cb61-10"><a href="initial-parameters-for-em-algorithm.html#cb61-10" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">Inf</span>)</span>
<span id="cb61-11"><a href="initial-parameters-for-em-algorithm.html#cb61-11" tabindex="-1"></a>  }</span>
<span id="cb61-12"><a href="initial-parameters-for-em-algorithm.html#cb61-12" tabindex="-1"></a></span>
<span id="cb61-13"><a href="initial-parameters-for-em-algorithm.html#cb61-13" tabindex="-1"></a>  aug1 <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">do.call</span>(cbind, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="at">FUN =</span> <span class="cf">function</span>(t){</span>
<span id="cb61-14"><a href="initial-parameters-for-em-algorithm.html#cb61-14" tabindex="-1"></a>    multmat <span class="ot">&lt;-</span> <span class="fu">apply</span>(y[[t]], <span class="at">FUN =</span> <span class="cf">function</span>(yy){</span>
<span id="cb61-15"><a href="initial-parameters-for-em-algorithm.html#cb61-15" tabindex="-1"></a>      <span class="fu">t</span>(yy <span class="sc">-</span> mu[,t]) <span class="sc">%*%</span> Sigma_inv <span class="sc">%*%</span> (yy <span class="sc">-</span> mu[,t])}, <span class="at">MARGIN =</span> <span class="dv">1</span>)</span>
<span id="cb61-16"><a href="initial-parameters-for-em-algorithm.html#cb61-16" tabindex="-1"></a>    <span class="fu">sum</span>(<span class="dv">1</span><span class="sc">/</span>(<span class="dv">2</span><span class="sc">*</span>N) <span class="sc">*</span> resp[[t]]<span class="sc">*</span>multmat)</span>
<span id="cb61-17"><a href="initial-parameters-for-em-algorithm.html#cb61-17" tabindex="-1"></a>  })))</span>
<span id="cb61-18"><a href="initial-parameters-for-em-algorithm.html#cb61-18" tabindex="-1"></a></span>
<span id="cb61-19"><a href="initial-parameters-for-em-algorithm.html#cb61-19" tabindex="-1"></a>  aug2 <span class="ot">&lt;-</span> lambda<span class="sc">*</span><span class="fu">sum</span>(<span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>d, <span class="at">FUN =</span> <span class="cf">function</span>(j)</span>
<span id="cb61-20"><a href="initial-parameters-for-em-algorithm.html#cb61-20" tabindex="-1"></a>    <span class="fu">sum</span>(<span class="fu">abs</span>(<span class="fu">diff</span>(w[j,], <span class="at">differences =</span> <span class="dv">1</span>))))))</span>
<span id="cb61-21"><a href="initial-parameters-for-em-algorithm.html#cb61-21" tabindex="-1"></a></span>
<span id="cb61-22"><a href="initial-parameters-for-em-algorithm.html#cb61-22" tabindex="-1"></a>  aug3 <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">do.call</span>(cbind, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="at">FUN =</span> <span class="cf">function</span>(t){</span>
<span id="cb61-23"><a href="initial-parameters-for-em-algorithm.html#cb61-23" tabindex="-1"></a>    uz[t,]<span class="sc">%*%</span>(mu[,t] <span class="sc">-</span> mu_dd <span class="sc">-</span> z[t,]) <span class="sc">+</span> rho<span class="sc">/</span><span class="dv">2</span> <span class="sc">*</span> <span class="fu">sum</span>((mu[,t] <span class="sc">-</span> mu_dd <span class="sc">-</span> z[t,])<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb61-24"><a href="initial-parameters-for-em-algorithm.html#cb61-24" tabindex="-1"></a>  })))</span>
<span id="cb61-25"><a href="initial-parameters-for-em-algorithm.html#cb61-25" tabindex="-1"></a></span>
<span id="cb61-26"><a href="initial-parameters-for-em-algorithm.html#cb61-26" tabindex="-1"></a></span>
<span id="cb61-27"><a href="initial-parameters-for-em-algorithm.html#cb61-27" tabindex="-1"></a>  aug4 <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>d, <span class="at">FUN =</span> <span class="cf">function</span>(j){</span>
<span id="cb61-28"><a href="initial-parameters-for-em-algorithm.html#cb61-28" tabindex="-1"></a>    uw[,j] <span class="sc">%*%</span> (Dl <span class="sc">%*%</span> mu[j,]  <span class="sc">-</span> w[j,]) <span class="sc">+</span> rho<span class="sc">/</span><span class="dv">2</span> <span class="sc">*</span> <span class="fu">sum</span>((Dl <span class="sc">%*%</span> mu[j,] <span class="sc">-</span> w[j,])<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb61-29"><a href="initial-parameters-for-em-algorithm.html#cb61-29" tabindex="-1"></a>  })))</span>
<span id="cb61-30"><a href="initial-parameters-for-em-algorithm.html#cb61-30" tabindex="-1"></a></span>
<span id="cb61-31"><a href="initial-parameters-for-em-algorithm.html#cb61-31" tabindex="-1"></a>  total <span class="ot">&lt;-</span> aug1 <span class="sc">+</span> aug2 <span class="sc">+</span> aug3 <span class="sc">+</span> aug4</span>
<span id="cb61-32"><a href="initial-parameters-for-em-algorithm.html#cb61-32" tabindex="-1"></a></span>
<span id="cb61-33"><a href="initial-parameters-for-em-algorithm.html#cb61-33" tabindex="-1"></a>  <span class="fu">return</span>(total)</span>
<span id="cb61-34"><a href="initial-parameters-for-em-algorithm.html#cb61-34" tabindex="-1"></a>}</span></code></pre></div>
<p>Here’s a function to calculate the objective value for the ADMM.</p>
<p><span class="math display">\[\frac{1}{2N} \sum_{t=1}^T \sum_{i=1}^{n_t} \hat{\gamma}_{it} (y_i^{(t)} - \mu_{\cdot
       t})^T \hat{\Sigma}^{-1} ( y_i^{(t)} - \mu_{\cdot t}) + \lambda
     \sum_{j=1}^d \|D^{(l+1)}\mu_{j\cdot }\|_1\]</span></p>
<p>(This is the penalized surrogate objective <span class="math inline">\(Q_{\tilde \theta}(\mu, \Sigma,
\pi) + \lambda \sum_{j=1}^d \|D^{(l+1)} \mu_{j \cdot}\|_1\)</span>, taking only the
parts, and leaving out a constant <span class="math inline">\(C=-\frac{d}{2}\log(2\pi) - \frac{1}{2} \log
det(\Sigma_k)\)</span>, since the constant <span class="math inline">\(C\)</span> doesn’t change over ADMM iterations.)</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="initial-parameters-for-em-algorithm.html#cb62-1" tabindex="-1"></a><span class="co">#' computes the ADMM objective for one cluster</span></span>
<span id="cb62-2"><a href="initial-parameters-for-em-algorithm.html#cb62-2" tabindex="-1"></a><span id="objective_per_cluster">objective_per_cluster</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(y, TT, d, l, mu, resp, Sigma_inv, Dlp1, Dl,</span>
<span id="cb62-3"><a href="initial-parameters-for-em-algorithm.html#cb62-3" tabindex="-1"></a>                                  maxdev, lambda, rho, N){</span>
<span id="cb62-4"><a href="initial-parameters-for-em-algorithm.html#cb62-4" tabindex="-1"></a>  </span>
<span id="cb62-5"><a href="initial-parameters-for-em-algorithm.html#cb62-5" tabindex="-1"></a>  aug1 <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">do.call</span>(cbind, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="at">FUN =</span> <span class="cf">function</span>(tt){</span>
<span id="cb62-6"><a href="initial-parameters-for-em-algorithm.html#cb62-6" tabindex="-1"></a>    multmat <span class="ot">&lt;-</span> <span class="fu">apply</span>(y[[tt]], <span class="at">FUN =</span> <span class="cf">function</span>(yy){</span>
<span id="cb62-7"><a href="initial-parameters-for-em-algorithm.html#cb62-7" tabindex="-1"></a>      <span class="fu">t</span>(yy <span class="sc">-</span> mu[tt,]) <span class="sc">%*%</span> Sigma_inv <span class="sc">%*%</span> (yy <span class="sc">-</span> mu[tt,])}, <span class="at">MARGIN =</span> <span class="dv">1</span>)</span>
<span id="cb62-8"><a href="initial-parameters-for-em-algorithm.html#cb62-8" tabindex="-1"></a>    <span class="fu">sum</span>(<span class="dv">1</span><span class="sc">/</span>(<span class="dv">2</span><span class="sc">*</span>N) <span class="sc">*</span> resp[[tt]] <span class="sc">*</span> multmat)</span>
<span id="cb62-9"><a href="initial-parameters-for-em-algorithm.html#cb62-9" tabindex="-1"></a>  })))</span>
<span id="cb62-10"><a href="initial-parameters-for-em-algorithm.html#cb62-10" tabindex="-1"></a></span>
<span id="cb62-11"><a href="initial-parameters-for-em-algorithm.html#cb62-11" tabindex="-1"></a>  aug2 <span class="ot">&lt;-</span> lambda<span class="sc">*</span><span class="fu">sum</span>(<span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>d, <span class="at">FUN =</span> <span class="cf">function</span>(j)</span>
<span id="cb62-12"><a href="initial-parameters-for-em-algorithm.html#cb62-12" tabindex="-1"></a>    <span class="fu">sum</span>(<span class="fu">abs</span>(<span class="fu">diff</span>(mu[,j], <span class="at">differences =</span> l))))))</span>
<span id="cb62-13"><a href="initial-parameters-for-em-algorithm.html#cb62-13" tabindex="-1"></a></span>
<span id="cb62-14"><a href="initial-parameters-for-em-algorithm.html#cb62-14" tabindex="-1"></a>  total <span class="ot">&lt;-</span> aug1 <span class="sc">+</span> aug2</span>
<span id="cb62-15"><a href="initial-parameters-for-em-algorithm.html#cb62-15" tabindex="-1"></a>  <span class="fu">return</span>(total)</span>
<span id="cb62-16"><a href="initial-parameters-for-em-algorithm.html#cb62-16" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="all-rcpp-functions" class="section level3 hasAnchor" number="4.2.5">
<h3>
<span class="header-section-number">4.2.5</span> All Rcpp functions<a href="initial-parameters-for-em-algorithm.html#all-rcpp-functions" class="anchor-section" aria-label="Anchor link to header"></a>
</h3>
<p>The main function we write in Rcpp is the “barebones” Sylvester equation solver
that takes upper-triangular coefficient matrices.</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb63-1"><a href="initial-parameters-for-em-algorithm.html#cb63-1" tabindex="-1"></a><span class="co">// [[Rcpp::depends(RcppArmadillo)]]</span></span>
<span id="cb63-2"><a href="initial-parameters-for-em-algorithm.html#cb63-2" tabindex="-1"></a><span class="co">// [[Rcpp::depends(RcppEigen)]]</span></span>
<span id="cb63-3"><a href="initial-parameters-for-em-algorithm.html#cb63-3" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;RcppArmadillo.h&gt;</span></span>
<span id="cb63-4"><a href="initial-parameters-for-em-algorithm.html#cb63-4" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;RcppEigen.h&gt;</span></span>
<span id="cb63-5"><a href="initial-parameters-for-em-algorithm.html#cb63-5" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;numeric&gt;</span></span>
<span id="cb63-6"><a href="initial-parameters-for-em-algorithm.html#cb63-6" tabindex="-1"></a></span>
<span id="cb63-7"><a href="initial-parameters-for-em-algorithm.html#cb63-7" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> arma<span class="op">;</span></span>
<span id="cb63-8"><a href="initial-parameters-for-em-algorithm.html#cb63-8" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Eigen<span class="op">;</span></span>
<span id="cb63-9"><a href="initial-parameters-for-em-algorithm.html#cb63-9" tabindex="-1"></a></span>
<span id="cb63-10"><a href="initial-parameters-for-em-algorithm.html#cb63-10" tabindex="-1"></a><span class="kw">using</span> Eigen<span class="op">::</span>Map<span class="op">;</span>                       <span class="co">// 'maps' rather than copies</span></span>
<span id="cb63-11"><a href="initial-parameters-for-em-algorithm.html#cb63-11" tabindex="-1"></a><span class="kw">using</span> Eigen<span class="op">::</span>MatrixXd<span class="op">;</span>                  <span class="co">// variable size matrix, double precision</span></span>
<span id="cb63-12"><a href="initial-parameters-for-em-algorithm.html#cb63-12" tabindex="-1"></a></span>
<span id="cb63-13"><a href="initial-parameters-for-em-algorithm.html#cb63-13" tabindex="-1"></a><span class="co">//' Solve "barebones" sylvester equation that takes upper triangular matrices as coefficients.</span></span>
<span id="cb63-14"><a href="initial-parameters-for-em-algorithm.html#cb63-14" tabindex="-1"></a><span class="co">//'</span></span>
<span id="cb63-15"><a href="initial-parameters-for-em-algorithm.html#cb63-15" tabindex="-1"></a><span class="co">//' @param TA Upper-triangular matrix</span></span>
<span id="cb63-16"><a href="initial-parameters-for-em-algorithm.html#cb63-16" tabindex="-1"></a><span class="co">//' @param TB Upper-triangular matrix</span></span>
<span id="cb63-17"><a href="initial-parameters-for-em-algorithm.html#cb63-17" tabindex="-1"></a><span class="co">//' @param C matrix</span></span>
<span id="cb63-18"><a href="initial-parameters-for-em-algorithm.html#cb63-18" tabindex="-1"></a><span class="co">//' @export</span></span>
<span id="cb63-19"><a href="initial-parameters-for-em-algorithm.html#cb63-19" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb63-20"><a href="initial-parameters-for-em-algorithm.html#cb63-20" tabindex="-1"></a>Eigen<span class="op">::</span>MatrixXd matrix_function_solve_triangular_sylvester_barebonesC2<span class="op">(</span><span class="at">const</span> Eigen<span class="op">::</span>MatrixXd <span class="op">&amp;</span> TA<span class="op">,</span> </span>
<span id="cb63-21"><a href="initial-parameters-for-em-algorithm.html#cb63-21" tabindex="-1"></a>                                     <span class="at">const</span> Eigen<span class="op">::</span>MatrixXd <span class="op">&amp;</span> TB<span class="op">,</span></span>
<span id="cb63-22"><a href="initial-parameters-for-em-algorithm.html#cb63-22" tabindex="-1"></a>                                     <span class="at">const</span> Eigen<span class="op">::</span>MatrixXd <span class="op">&amp;</span> C<span class="op">){</span></span>
<span id="cb63-23"><a href="initial-parameters-for-em-algorithm.html#cb63-23" tabindex="-1"></a>  <span class="co">// Eigen::eigen_assert(TA.rows() == TA.cols());</span></span>
<span id="cb63-24"><a href="initial-parameters-for-em-algorithm.html#cb63-24" tabindex="-1"></a>  <span class="co">// Eigen::eigen_assert(TA.Eigen::isUpperTriangular());</span></span>
<span id="cb63-25"><a href="initial-parameters-for-em-algorithm.html#cb63-25" tabindex="-1"></a>  <span class="co">// Eigen::eigen_assert(TB.rows() == TB.cols());</span></span>
<span id="cb63-26"><a href="initial-parameters-for-em-algorithm.html#cb63-26" tabindex="-1"></a>  <span class="co">// Eigen::eigen_assert(TB.Eigen::isUpperTriangular());</span></span>
<span id="cb63-27"><a href="initial-parameters-for-em-algorithm.html#cb63-27" tabindex="-1"></a>  <span class="co">// Eigen::eigen_assert(C.rows() == TA.rows());</span></span>
<span id="cb63-28"><a href="initial-parameters-for-em-algorithm.html#cb63-28" tabindex="-1"></a>  <span class="co">// Eigen::eigen_assert(C.cols() == TB.rows());</span></span>
<span id="cb63-29"><a href="initial-parameters-for-em-algorithm.html#cb63-29" tabindex="-1"></a></span>
<span id="cb63-30"><a href="initial-parameters-for-em-algorithm.html#cb63-30" tabindex="-1"></a>  <span class="co">// typedef typename MatrixType::Index Index; </span></span>
<span id="cb63-31"><a href="initial-parameters-for-em-algorithm.html#cb63-31" tabindex="-1"></a>  <span class="co">// typedef typename MatrixType::Scalar Scalar;</span></span>
<span id="cb63-32"><a href="initial-parameters-for-em-algorithm.html#cb63-32" tabindex="-1"></a></span>
<span id="cb63-33"><a href="initial-parameters-for-em-algorithm.html#cb63-33" tabindex="-1"></a>  <span class="dt">int</span> m <span class="op">=</span> TA<span class="op">.</span>rows<span class="op">();</span></span>
<span id="cb63-34"><a href="initial-parameters-for-em-algorithm.html#cb63-34" tabindex="-1"></a>  <span class="dt">int</span> n <span class="op">=</span> TB<span class="op">.</span>rows<span class="op">();</span></span>
<span id="cb63-35"><a href="initial-parameters-for-em-algorithm.html#cb63-35" tabindex="-1"></a>  Eigen<span class="op">::</span>MatrixXd X<span class="op">(</span>m<span class="op">,</span> n<span class="op">);</span></span>
<span id="cb63-36"><a href="initial-parameters-for-em-algorithm.html#cb63-36" tabindex="-1"></a></span>
<span id="cb63-37"><a href="initial-parameters-for-em-algorithm.html#cb63-37" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> m <span class="op">-</span> <span class="dv">1</span><span class="op">;</span> i <span class="op">&gt;=</span> <span class="dv">0</span><span class="op">;</span> <span class="op">--</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb63-38"><a href="initial-parameters-for-em-algorithm.html#cb63-38" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> n<span class="op">;</span> <span class="op">++</span>j<span class="op">)</span> <span class="op">{</span></span>
<span id="cb63-39"><a href="initial-parameters-for-em-algorithm.html#cb63-39" tabindex="-1"></a></span>
<span id="cb63-40"><a href="initial-parameters-for-em-algorithm.html#cb63-40" tabindex="-1"></a>      <span class="co">// Compute T_A X = \sum_{k=i+1}^m T_A_{ik} X_{kj}</span></span>
<span id="cb63-41"><a href="initial-parameters-for-em-algorithm.html#cb63-41" tabindex="-1"></a>      <span class="dt">double</span> TAX<span class="op">;</span></span>
<span id="cb63-42"><a href="initial-parameters-for-em-algorithm.html#cb63-42" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>i <span class="op">==</span> m <span class="op">-</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb63-43"><a href="initial-parameters-for-em-algorithm.html#cb63-43" tabindex="-1"></a>        TAX <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb63-44"><a href="initial-parameters-for-em-algorithm.html#cb63-44" tabindex="-1"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb63-45"><a href="initial-parameters-for-em-algorithm.html#cb63-45" tabindex="-1"></a>    MatrixXd TAXmatrix <span class="op">=</span> TA<span class="op">.</span>row<span class="op">(</span>i<span class="op">).</span>tail<span class="op">(</span>m<span class="op">-</span><span class="dv">1</span><span class="op">-</span>i<span class="op">)</span> <span class="op">*</span> X<span class="op">.</span>col<span class="op">(</span>j<span class="op">).</span>tail<span class="op">(</span>m<span class="op">-</span><span class="dv">1</span><span class="op">-</span>i<span class="op">);</span></span>
<span id="cb63-46"><a href="initial-parameters-for-em-algorithm.html#cb63-46" tabindex="-1"></a>        TAX <span class="op">=</span> TAXmatrix<span class="op">(</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb63-47"><a href="initial-parameters-for-em-algorithm.html#cb63-47" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb63-48"><a href="initial-parameters-for-em-algorithm.html#cb63-48" tabindex="-1"></a></span>
<span id="cb63-49"><a href="initial-parameters-for-em-algorithm.html#cb63-49" tabindex="-1"></a>      <span class="co">// Compute X T_B = \sum_{k=1}^{j-1} X_{ik} T_B_{kj}</span></span>
<span id="cb63-50"><a href="initial-parameters-for-em-algorithm.html#cb63-50" tabindex="-1"></a>      <span class="dt">double</span> XTB<span class="op">;</span></span>
<span id="cb63-51"><a href="initial-parameters-for-em-algorithm.html#cb63-51" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>j <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb63-52"><a href="initial-parameters-for-em-algorithm.html#cb63-52" tabindex="-1"></a>        XTB <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb63-53"><a href="initial-parameters-for-em-algorithm.html#cb63-53" tabindex="-1"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb63-54"><a href="initial-parameters-for-em-algorithm.html#cb63-54" tabindex="-1"></a>        MatrixXd XTBmatrix <span class="op">=</span> X<span class="op">.</span>row<span class="op">(</span>i<span class="op">).</span>head<span class="op">(</span>j<span class="op">)</span> <span class="op">*</span> TB<span class="op">.</span>col<span class="op">(</span>j<span class="op">).</span>head<span class="op">(</span>j<span class="op">);</span></span>
<span id="cb63-55"><a href="initial-parameters-for-em-algorithm.html#cb63-55" tabindex="-1"></a>        XTB <span class="op">=</span> XTBmatrix<span class="op">(</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb63-56"><a href="initial-parameters-for-em-algorithm.html#cb63-56" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb63-57"><a href="initial-parameters-for-em-algorithm.html#cb63-57" tabindex="-1"></a></span>
<span id="cb63-58"><a href="initial-parameters-for-em-algorithm.html#cb63-58" tabindex="-1"></a>      X<span class="op">(</span>i<span class="op">,</span>j<span class="op">)</span> <span class="op">=</span> <span class="op">(</span>C<span class="op">(</span>i<span class="op">,</span>j<span class="op">)</span> <span class="op">-</span> TAX <span class="op">-</span> XTB<span class="op">)</span> <span class="op">/</span> <span class="op">(</span>TA<span class="op">(</span>i<span class="op">,</span>i<span class="op">)</span> <span class="op">+</span> TB<span class="op">(</span>j<span class="op">,</span>j<span class="op">));</span></span>
<span id="cb63-59"><a href="initial-parameters-for-em-algorithm.html#cb63-59" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb63-60"><a href="initial-parameters-for-em-algorithm.html#cb63-60" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb63-61"><a href="initial-parameters-for-em-algorithm.html#cb63-61" tabindex="-1"></a>  <span class="cf">return</span> X<span class="op">;</span></span>
<span id="cb63-62"><a href="initial-parameters-for-em-algorithm.html#cb63-62" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Also, we define a faster <code>dmvnorm</code> function written in C++.</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb64-1"><a href="initial-parameters-for-em-algorithm.html#cb64-1" tabindex="-1"></a><span class="co">// [[Rcpp::depends(RcppArmadillo)]]</span></span>
<span id="cb64-2"><a href="initial-parameters-for-em-algorithm.html#cb64-2" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;RcppArmadillo.h&gt;</span></span>
<span id="cb64-3"><a href="initial-parameters-for-em-algorithm.html#cb64-3" tabindex="-1"></a></span>
<span id="cb64-4"><a href="initial-parameters-for-em-algorithm.html#cb64-4" tabindex="-1"></a><span class="at">static</span> <span class="dt">double</span> <span class="at">const</span> log2pi <span class="op">=</span> <span class="bu">std::</span>log<span class="op">(</span><span class="fl">2.0</span> <span class="op">*</span> M_PI<span class="op">);</span></span>
<span id="cb64-5"><a href="initial-parameters-for-em-algorithm.html#cb64-5" tabindex="-1"></a></span>
<span id="cb64-6"><a href="initial-parameters-for-em-algorithm.html#cb64-6" tabindex="-1"></a><span class="co">/* C++ version of the dtrmv BLAS function */</span></span>
<span id="cb64-7"><a href="initial-parameters-for-em-algorithm.html#cb64-7" tabindex="-1"></a><span class="dt">void</span> inplace_tri_mat_mult<span class="op">(</span>arma<span class="op">::</span>rowvec <span class="op">&amp;</span>x<span class="op">,</span> arma<span class="op">::</span>mat <span class="at">const</span> <span class="op">&amp;</span>trimat<span class="op">){</span></span>
<span id="cb64-8"><a href="initial-parameters-for-em-algorithm.html#cb64-8" tabindex="-1"></a>  arma<span class="op">::</span>uword <span class="at">const</span> n <span class="op">=</span> trimat<span class="op">.</span>n_cols<span class="op">;</span></span>
<span id="cb64-9"><a href="initial-parameters-for-em-algorithm.html#cb64-9" tabindex="-1"></a></span>
<span id="cb64-10"><a href="initial-parameters-for-em-algorithm.html#cb64-10" tabindex="-1"></a>  <span class="cf">for</span><span class="op">(</span><span class="dt">unsigned</span> j <span class="op">=</span> n<span class="op">;</span> j<span class="op">--</span> <span class="op">&gt;</span> <span class="dv">0</span><span class="op">;){</span></span>
<span id="cb64-11"><a href="initial-parameters-for-em-algorithm.html#cb64-11" tabindex="-1"></a>    <span class="dt">double</span> tmp<span class="op">(</span><span class="fl">0.</span><span class="op">);</span></span>
<span id="cb64-12"><a href="initial-parameters-for-em-algorithm.html#cb64-12" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span><span class="dt">unsigned</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;=</span> j<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span></span>
<span id="cb64-13"><a href="initial-parameters-for-em-algorithm.html#cb64-13" tabindex="-1"></a>      tmp <span class="op">+=</span> trimat<span class="op">.</span>at<span class="op">(</span>i<span class="op">,</span> j<span class="op">)</span> <span class="op">*</span> x<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb64-14"><a href="initial-parameters-for-em-algorithm.html#cb64-14" tabindex="-1"></a>    x<span class="op">[</span>j<span class="op">]</span> <span class="op">=</span> tmp<span class="op">;</span></span>
<span id="cb64-15"><a href="initial-parameters-for-em-algorithm.html#cb64-15" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb64-16"><a href="initial-parameters-for-em-algorithm.html#cb64-16" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb64-17"><a href="initial-parameters-for-em-algorithm.html#cb64-17" tabindex="-1"></a></span>
<span id="cb64-18"><a href="initial-parameters-for-em-algorithm.html#cb64-18" tabindex="-1"></a></span>
<span id="cb64-19"><a href="initial-parameters-for-em-algorithm.html#cb64-19" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb64-20"><a href="initial-parameters-for-em-algorithm.html#cb64-20" tabindex="-1"></a>arma<span class="op">::</span>vec dmvnorm_arma_fast<span class="op">(</span>arma<span class="op">::</span>mat <span class="at">const</span> <span class="op">&amp;</span>x<span class="op">,</span></span>
<span id="cb64-21"><a href="initial-parameters-for-em-algorithm.html#cb64-21" tabindex="-1"></a>                           arma<span class="op">::</span>rowvec <span class="at">const</span> <span class="op">&amp;</span>mean<span class="op">,</span></span>
<span id="cb64-22"><a href="initial-parameters-for-em-algorithm.html#cb64-22" tabindex="-1"></a>                           arma<span class="op">::</span>mat <span class="at">const</span> <span class="op">&amp;</span>sigma<span class="op">,</span></span>
<span id="cb64-23"><a href="initial-parameters-for-em-algorithm.html#cb64-23" tabindex="-1"></a>                           <span class="dt">bool</span> <span class="at">const</span> logd <span class="op">=</span> <span class="kw">false</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb64-24"><a href="initial-parameters-for-em-algorithm.html#cb64-24" tabindex="-1"></a>    <span class="kw">using</span> arma<span class="op">::</span>uword<span class="op">;</span></span>
<span id="cb64-25"><a href="initial-parameters-for-em-algorithm.html#cb64-25" tabindex="-1"></a>    uword <span class="at">const</span> n <span class="op">=</span> x<span class="op">.</span>n_rows<span class="op">,</span></span>
<span id="cb64-26"><a href="initial-parameters-for-em-algorithm.html#cb64-26" tabindex="-1"></a>             xdim <span class="op">=</span> x<span class="op">.</span>n_cols<span class="op">;</span></span>
<span id="cb64-27"><a href="initial-parameters-for-em-algorithm.html#cb64-27" tabindex="-1"></a>    arma<span class="op">::</span>vec out<span class="op">(</span>n<span class="op">);</span></span>
<span id="cb64-28"><a href="initial-parameters-for-em-algorithm.html#cb64-28" tabindex="-1"></a>    arma<span class="op">::</span>mat <span class="at">const</span> rooti <span class="op">=</span> arma<span class="op">::</span>inv<span class="op">(</span>trimatu<span class="op">(</span>arma<span class="op">::</span>chol<span class="op">(</span>sigma<span class="op">)));</span></span>
<span id="cb64-29"><a href="initial-parameters-for-em-algorithm.html#cb64-29" tabindex="-1"></a>    <span class="dt">double</span> <span class="at">const</span> rootisum <span class="op">=</span> arma<span class="op">::</span>sum<span class="op">(</span>log<span class="op">(</span>rooti<span class="op">.</span>diag<span class="op">())),</span></span>
<span id="cb64-30"><a href="initial-parameters-for-em-algorithm.html#cb64-30" tabindex="-1"></a>                constants <span class="op">=</span> <span class="op">-(</span><span class="dt">double</span><span class="op">)</span>xdim<span class="op">/</span><span class="fl">2.0</span> <span class="op">*</span> log2pi<span class="op">,</span></span>
<span id="cb64-31"><a href="initial-parameters-for-em-algorithm.html#cb64-31" tabindex="-1"></a>              other_terms <span class="op">=</span> rootisum <span class="op">+</span> constants<span class="op">;</span></span>
<span id="cb64-32"><a href="initial-parameters-for-em-algorithm.html#cb64-32" tabindex="-1"></a></span>
<span id="cb64-33"><a href="initial-parameters-for-em-algorithm.html#cb64-33" tabindex="-1"></a>    arma<span class="op">::</span>rowvec z<span class="op">;</span></span>
<span id="cb64-34"><a href="initial-parameters-for-em-algorithm.html#cb64-34" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>uword i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb64-35"><a href="initial-parameters-for-em-algorithm.html#cb64-35" tabindex="-1"></a>        z <span class="op">=</span> <span class="op">(</span>x<span class="op">.</span>row<span class="op">(</span>i<span class="op">)</span> <span class="op">-</span> mean<span class="op">);</span></span>
<span id="cb64-36"><a href="initial-parameters-for-em-algorithm.html#cb64-36" tabindex="-1"></a>        inplace_tri_mat_mult<span class="op">(</span>z<span class="op">,</span> rooti<span class="op">);</span></span>
<span id="cb64-37"><a href="initial-parameters-for-em-algorithm.html#cb64-37" tabindex="-1"></a>        out<span class="op">(</span>i<span class="op">)</span> <span class="op">=</span> other_terms <span class="op">-</span> <span class="fl">0.5</span> <span class="op">*</span> arma<span class="op">::</span>dot<span class="op">(</span>z<span class="op">,</span> z<span class="op">);</span></span>
<span id="cb64-38"><a href="initial-parameters-for-em-algorithm.html#cb64-38" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb64-39"><a href="initial-parameters-for-em-algorithm.html#cb64-39" tabindex="-1"></a></span>
<span id="cb64-40"><a href="initial-parameters-for-em-algorithm.html#cb64-40" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>logd<span class="op">)</span></span>
<span id="cb64-41"><a href="initial-parameters-for-em-algorithm.html#cb64-41" tabindex="-1"></a>      <span class="cf">return</span> out<span class="op">;</span></span>
<span id="cb64-42"><a href="initial-parameters-for-em-algorithm.html#cb64-42" tabindex="-1"></a>    <span class="cf">return</span> exp<span class="op">(</span>out<span class="op">);</span></span>
<span id="cb64-43"><a href="initial-parameters-for-em-algorithm.html#cb64-43" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb64-44"><a href="initial-parameters-for-em-algorithm.html#cb64-44" tabindex="-1"></a></span>
<span id="cb64-45"><a href="initial-parameters-for-em-algorithm.html#cb64-45" tabindex="-1"></a><span class="co">// All credit goes to https://gallery.rcpp.org/articles/dmvnorm_arma/</span></span></code></pre></div>
<p>We need this blob
(from <a href="https://github.com/jacobbien/litr-project/blob/main/examples/make-an-r-package-with-armadillo/create-witharmadillo.Rmd" class="uri">https://github.com/jacobbien/litr-project/blob/main/examples/make-an-r-package-with-armadillo/create-witharmadillo.Rmd</a> ):</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="initial-parameters-for-em-algorithm.html#cb65-1" tabindex="-1"></a>usethis<span class="sc">::</span><span class="fu">use_rcpp_armadillo</span>(<span class="at">name =</span> <span class="st">"code"</span>)</span>
<span id="cb65-2"><a href="initial-parameters-for-em-algorithm.html#cb65-2" tabindex="-1"></a>usethis<span class="sc">::</span><span class="fu">use_rcpp_eigen</span>(<span class="at">name =</span> <span class="st">"code"</span>)</span></code></pre></div>
<pre><code>## ✔ Leaving 'src/code.cpp' unchanged
## • Edit 'src/code.cpp'
## ✔ Adding 'RcppArmadillo' to LinkingTo field in DESCRIPTION
## ✔ Created 'src/Makevars' and 'src/Makevars.win' with requested compilation settings.</code></pre>
<pre><code>## ✔ Leaving 'src/code.cpp' unchanged
## • Edit 'src/code.cpp'
## ✔ Adding 'RcppEigen' to LinkingTo field in DESCRIPTION
## ✔ Adding '@import RcppEigen' to 'R/flowtrend-package.R'
## • Run `devtools::document()` to update 'NAMESPACE'</code></pre>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="initial-parameters-for-em-algorithm.html#cb68-1" tabindex="-1"></a><span class="co">#' Testing against \code{<a href="initial-parameters-for-em-algorithm.html#Mstep_mu">Mstep_mu</a>()}, for ONE cluster.</span></span>
<span id="cb68-2"><a href="initial-parameters-for-em-algorithm.html#cb68-2" tabindex="-1"></a><span class="co">#' @param ylist</span></span>
<span id="cb68-3"><a href="initial-parameters-for-em-algorithm.html#cb68-3" tabindex="-1"></a><span class="co">#' @param resp</span></span>
<span id="cb68-4"><a href="initial-parameters-for-em-algorithm.html#cb68-4" tabindex="-1"></a><span class="co">#' @param lambda</span></span>
<span id="cb68-5"><a href="initial-parameters-for-em-algorithm.html#cb68-5" tabindex="-1"></a><span class="co">#' @param l</span></span>
<span id="cb68-6"><a href="initial-parameters-for-em-algorithm.html#cb68-6" tabindex="-1"></a><span class="co">#' @param Sigma_inv inverse of Sigma</span></span>
<span id="cb68-7"><a href="initial-parameters-for-em-algorithm.html#cb68-7" tabindex="-1"></a><span class="co">#' @param x covariates</span></span>
<span id="cb68-8"><a href="initial-parameters-for-em-algorithm.html#cb68-8" tabindex="-1"></a><span id="Mstep_mu_cvxr">Mstep_mu_cvxr</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(ylist,</span>
<span id="cb68-9"><a href="initial-parameters-for-em-algorithm.html#cb68-9" tabindex="-1"></a>                          resp,</span>
<span id="cb68-10"><a href="initial-parameters-for-em-algorithm.html#cb68-10" tabindex="-1"></a>                          lambda,</span>
<span id="cb68-11"><a href="initial-parameters-for-em-algorithm.html#cb68-11" tabindex="-1"></a>                          l,</span>
<span id="cb68-12"><a href="initial-parameters-for-em-algorithm.html#cb68-12" tabindex="-1"></a>                          Sigma_inv, </span>
<span id="cb68-13"><a href="initial-parameters-for-em-algorithm.html#cb68-13" tabindex="-1"></a>                          <span class="at">x =</span> <span class="cn">NULL</span>,</span>
<span id="cb68-14"><a href="initial-parameters-for-em-algorithm.html#cb68-14" tabindex="-1"></a>                          <span class="at">thresh =</span> <span class="fl">1E-8</span>,</span>
<span id="cb68-15"><a href="initial-parameters-for-em-algorithm.html#cb68-15" tabindex="-1"></a>                          <span class="at">maxdev =</span> <span class="cn">NULL</span>,</span>
<span id="cb68-16"><a href="initial-parameters-for-em-algorithm.html#cb68-16" tabindex="-1"></a>                          dimdat,</span>
<span id="cb68-17"><a href="initial-parameters-for-em-algorithm.html#cb68-17" tabindex="-1"></a>                          N,</span>
<span id="cb68-18"><a href="initial-parameters-for-em-algorithm.html#cb68-18" tabindex="-1"></a>                          <span class="at">ecos_thresh =</span> <span class="fl">1E-8</span>,</span>
<span id="cb68-19"><a href="initial-parameters-for-em-algorithm.html#cb68-19" tabindex="-1"></a>                          <span class="at">scs_eps =</span> <span class="fl">1E-5</span>){</span>
<span id="cb68-20"><a href="initial-parameters-for-em-algorithm.html#cb68-20" tabindex="-1"></a>  </span>
<span id="cb68-21"><a href="initial-parameters-for-em-algorithm.html#cb68-21" tabindex="-1"></a>  <span class="do">## Define dimensions</span></span>
<span id="cb68-22"><a href="initial-parameters-for-em-algorithm.html#cb68-22" tabindex="-1"></a>  TT <span class="ot">=</span> <span class="fu">length</span>(ylist)</span>
<span id="cb68-23"><a href="initial-parameters-for-em-algorithm.html#cb68-23" tabindex="-1"></a>  </span>
<span id="cb68-24"><a href="initial-parameters-for-em-algorithm.html#cb68-24" tabindex="-1"></a>  <span class="do">## Responsibility Weighted Data</span></span>
<span id="cb68-25"><a href="initial-parameters-for-em-algorithm.html#cb68-25" tabindex="-1"></a>  ytildes <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="at">FUN =</span> <span class="cf">function</span>(tt){</span>
<span id="cb68-26"><a href="initial-parameters-for-em-algorithm.html#cb68-26" tabindex="-1"></a>    yy <span class="ot">&lt;-</span> ylist[[tt]]</span>
<span id="cb68-27"><a href="initial-parameters-for-em-algorithm.html#cb68-27" tabindex="-1"></a>    g <span class="ot">&lt;-</span> resp[[tt]]</span>
<span id="cb68-28"><a href="initial-parameters-for-em-algorithm.html#cb68-28" tabindex="-1"></a>    yy <span class="ot">&lt;-</span> <span class="fu">apply</span>(yy, <span class="at">MARGIN =</span> <span class="dv">2</span>, <span class="at">FUN =</span> <span class="cf">function</span>(x) x <span class="sc">*</span> g)</span>
<span id="cb68-29"><a href="initial-parameters-for-em-algorithm.html#cb68-29" tabindex="-1"></a>    yrow <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>), <span class="at">nrow=</span><span class="dv">1</span>, <span class="at">ncol=</span>dimdat)</span>
<span id="cb68-30"><a href="initial-parameters-for-em-algorithm.html#cb68-30" tabindex="-1"></a>    yrow[<span class="dv">1</span>,] <span class="ot">=</span> <span class="fu">colSums</span>(yy)</span>
<span id="cb68-31"><a href="initial-parameters-for-em-algorithm.html#cb68-31" tabindex="-1"></a>    yrow</span>
<span id="cb68-32"><a href="initial-parameters-for-em-algorithm.html#cb68-32" tabindex="-1"></a>  }) <span class="sc">%&gt;%</span> <span class="fu">do.call</span>(rbind, .)</span>
<span id="cb68-33"><a href="initial-parameters-for-em-algorithm.html#cb68-33" tabindex="-1"></a>  </span>
<span id="cb68-34"><a href="initial-parameters-for-em-algorithm.html#cb68-34" tabindex="-1"></a>  <span class="do">## Auxiliary term, needed to make the objective interpretable</span></span>
<span id="cb68-35"><a href="initial-parameters-for-em-algorithm.html#cb68-35" tabindex="-1"></a>  aux.y <span class="ot">&lt;-</span> <span class="fu">Reduce</span>(<span class="st">"+"</span>, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="at">FUN =</span> <span class="cf">function</span>(tt){</span>
<span id="cb68-36"><a href="initial-parameters-for-em-algorithm.html#cb68-36" tabindex="-1"></a>    yy <span class="ot">&lt;-</span> ylist[[tt]]</span>
<span id="cb68-37"><a href="initial-parameters-for-em-algorithm.html#cb68-37" tabindex="-1"></a>    g <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(resp[[tt]])</span>
<span id="cb68-38"><a href="initial-parameters-for-em-algorithm.html#cb68-38" tabindex="-1"></a>    yy <span class="ot">&lt;-</span> <span class="fu">apply</span>(yy, <span class="at">MARGIN =</span> <span class="dv">2</span>, <span class="at">FUN =</span> <span class="cf">function</span>(x) x <span class="sc">*</span> g)</span>
<span id="cb68-39"><a href="initial-parameters-for-em-algorithm.html#cb68-39" tabindex="-1"></a>    <span class="fu">sum</span>(<span class="fu">diag</span>(yy <span class="sc">%*%</span> Sigma_inv <span class="sc">%*%</span> <span class="fu">t</span>(yy)))</span>
<span id="cb68-40"><a href="initial-parameters-for-em-algorithm.html#cb68-40" tabindex="-1"></a>  }))</span>
<span id="cb68-41"><a href="initial-parameters-for-em-algorithm.html#cb68-41" tabindex="-1"></a>  </span>
<span id="cb68-42"><a href="initial-parameters-for-em-algorithm.html#cb68-42" tabindex="-1"></a>  <span class="do">## Mu, d x T matrix</span></span>
<span id="cb68-43"><a href="initial-parameters-for-em-algorithm.html#cb68-43" tabindex="-1"></a>  mumat <span class="ot">&lt;-</span> CVXR<span class="sc">::</span><span class="fu">Variable</span>(<span class="at">cols=</span>dimdat, <span class="at">rows=</span>TT)</span>
<span id="cb68-44"><a href="initial-parameters-for-em-algorithm.html#cb68-44" tabindex="-1"></a>  </span>
<span id="cb68-45"><a href="initial-parameters-for-em-algorithm.html#cb68-45" tabindex="-1"></a>  <span class="do">## Summed sqrt responsibilities - needed in the objective.</span></span>
<span id="cb68-46"><a href="initial-parameters-for-em-algorithm.html#cb68-46" tabindex="-1"></a>  resp.sum.sqrt <span class="ot">&lt;-</span> <span class="fu">lapply</span>(resp, <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">sqrt</span>(<span class="fu">sum</span>(x)))</span>
<span id="cb68-47"><a href="initial-parameters-for-em-algorithm.html#cb68-47" tabindex="-1"></a>  </span>
<span id="cb68-48"><a href="initial-parameters-for-em-algorithm.html#cb68-48" tabindex="-1"></a>  <span class="do">## Differencing Matrix, (TT-(l+1)) x TT </span></span>
<span id="cb68-49"><a href="initial-parameters-for-em-algorithm.html#cb68-49" tabindex="-1"></a>  Dlp1 <span class="ot">&lt;-</span> <a href="package-setup.html#gen_diff_mat">gen_diff_mat</a>(<span class="at">n =</span> TT, <span class="at">l =</span> l<span class="sc">+</span><span class="dv">1</span>, <span class="at">x =</span> x)</span>
<span id="cb68-50"><a href="initial-parameters-for-em-algorithm.html#cb68-50" tabindex="-1"></a>  <span class="co"># l = 2 is quadratic trend filtering</span></span>
<span id="cb68-51"><a href="initial-parameters-for-em-algorithm.html#cb68-51" tabindex="-1"></a>  <span class="co"># l = 1 is linear trend filtering</span></span>
<span id="cb68-52"><a href="initial-parameters-for-em-algorithm.html#cb68-52" tabindex="-1"></a>  <span class="co"># l = 0 is fused lasso</span></span>
<span id="cb68-53"><a href="initial-parameters-for-em-algorithm.html#cb68-53" tabindex="-1"></a>  </span>
<span id="cb68-54"><a href="initial-parameters-for-em-algorithm.html#cb68-54" tabindex="-1"></a>  <span class="do">## Forming the objective</span></span>
<span id="cb68-55"><a href="initial-parameters-for-em-algorithm.html#cb68-55" tabindex="-1"></a>  obj <span class="ot">=</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">2</span><span class="sc">*</span>N) <span class="sc">*</span>( <span class="fu">Reduce</span>(<span class="st">"+"</span>, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="at">FUN =</span> <span class="cf">function</span>(tt) CVXR<span class="sc">::</span><span class="fu">quad_form</span>(<span class="fu">t</span>(resp.sum.sqrt[[tt]]<span class="sc">*</span>mumat[tt,]), Sigma_inv))) <span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> <span class="fu">Reduce</span>(<span class="st">"+"</span>, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="at">FUN =</span> <span class="cf">function</span>(tt) <span class="fu">t</span>(ytildes[tt,]) <span class="sc">%*%</span> Sigma_inv <span class="sc">%*%</span> <span class="fu">t</span>(mumat[tt,]))) <span class="sc">+</span> aux.y) <span class="sc">+</span> lambda <span class="sc">*</span> <span class="fu">sum</span>(CVXR<span class="sc">::</span><span class="fu">sum_entries</span>(<span class="fu">abs</span>(Dlp1 <span class="sc">%*%</span> mumat), <span class="at">axis =</span> <span class="dv">1</span>))</span>
<span id="cb68-56"><a href="initial-parameters-for-em-algorithm.html#cb68-56" tabindex="-1"></a></span>
<span id="cb68-57"><a href="initial-parameters-for-em-algorithm.html#cb68-57" tabindex="-1"></a>  <span class="do">##Reduce("+", lapply(1:TT, FUN = function(tt) t(ytildes[tt,]) %*% Sigma_inv %*% (mumat[tt,]))) + aux.y</span></span>
<span id="cb68-58"><a href="initial-parameters-for-em-algorithm.html#cb68-58" tabindex="-1"></a>  <span class="do">## a = t(resp.sum.sqrt[[tt]]*mumat[tt,])</span></span>
<span id="cb68-59"><a href="initial-parameters-for-em-algorithm.html#cb68-59" tabindex="-1"></a>  <span class="do">## CVXR::quad_form(resp.sum.sqrt[[tt]]*mumat[tt,], Sigma_inv)</span></span>
<span id="cb68-60"><a href="initial-parameters-for-em-algorithm.html#cb68-60" tabindex="-1"></a>    </span>
<span id="cb68-61"><a href="initial-parameters-for-em-algorithm.html#cb68-61" tabindex="-1"></a>    </span>
<span id="cb68-62"><a href="initial-parameters-for-em-algorithm.html#cb68-62" tabindex="-1"></a>  <span class="do">## resp.sum.sqrt[[tt]]*mumat[tt,] %&gt;% dim()</span></span>
<span id="cb68-63"><a href="initial-parameters-for-em-algorithm.html#cb68-63" tabindex="-1"></a>  <span class="do">## dim(Sigma_inv)</span></span>
<span id="cb68-64"><a href="initial-parameters-for-em-algorithm.html#cb68-64" tabindex="-1"></a>  <span class="do">## mumat %&gt;% dim()</span></span>
<span id="cb68-65"><a href="initial-parameters-for-em-algorithm.html#cb68-65" tabindex="-1"></a>  <span class="do">## ( (resp.sum.sqrt[[tt]]) * mumat[tt,]) %&gt;% dim()</span></span>
<span id="cb68-66"><a href="initial-parameters-for-em-algorithm.html#cb68-66" tabindex="-1"></a>  </span>
<span id="cb68-67"><a href="initial-parameters-for-em-algorithm.html#cb68-67" tabindex="-1"></a></span>
<span id="cb68-68"><a href="initial-parameters-for-em-algorithm.html#cb68-68" tabindex="-1"></a>  <span class="do">## Putting together the ball constraint</span></span>
<span id="cb68-69"><a href="initial-parameters-for-em-algorithm.html#cb68-69" tabindex="-1"></a>  rowmns <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rep</span>(<span class="dv">1</span>, TT<span class="sc">^</span><span class="dv">2</span>), <span class="at">nrow =</span> TT)<span class="sc">/</span>TT</span>
<span id="cb68-70"><a href="initial-parameters-for-em-algorithm.html#cb68-70" tabindex="-1"></a>  mu_dotdot <span class="ot">&lt;-</span> rowmns <span class="sc">%*%</span> mumat</span>
<span id="cb68-71"><a href="initial-parameters-for-em-algorithm.html#cb68-71" tabindex="-1"></a>  constraints <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb68-72"><a href="initial-parameters-for-em-algorithm.html#cb68-72" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(maxdev)){</span>
<span id="cb68-73"><a href="initial-parameters-for-em-algorithm.html#cb68-73" tabindex="-1"></a>    constraints <span class="ot">=</span> <span class="fu">list</span>(CVXR<span class="sc">::</span><span class="fu">sum_entries</span>(CVXR<span class="sc">::</span><span class="fu">square</span>(mumat <span class="sc">-</span> mu_dotdot), <span class="at">axis =</span> <span class="dv">2</span>) <span class="sc">&lt;=</span> <span class="fu">rep</span>(maxdev<span class="sc">^</span><span class="dv">2</span>, TT) )</span>
<span id="cb68-74"><a href="initial-parameters-for-em-algorithm.html#cb68-74" tabindex="-1"></a>  }</span>
<span id="cb68-75"><a href="initial-parameters-for-em-algorithm.html#cb68-75" tabindex="-1"></a>  </span>
<span id="cb68-76"><a href="initial-parameters-for-em-algorithm.html#cb68-76" tabindex="-1"></a>  <span class="do">## Try all two CVXR solvers.</span></span>
<span id="cb68-77"><a href="initial-parameters-for-em-algorithm.html#cb68-77" tabindex="-1"></a>  prob <span class="ot">&lt;-</span> CVXR<span class="sc">::</span><span class="fu">Problem</span>(CVXR<span class="sc">::</span><span class="fu">Minimize</span>(obj), constraints)</span>
<span id="cb68-78"><a href="initial-parameters-for-em-algorithm.html#cb68-78" tabindex="-1"></a>  result <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb68-79"><a href="initial-parameters-for-em-algorithm.html#cb68-79" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb68-80"><a href="initial-parameters-for-em-algorithm.html#cb68-80" tabindex="-1"></a>    CVXR<span class="sc">::</span><span class="fu">solve</span>(prob, <span class="at">solver=</span><span class="st">"ECOS"</span>,</span>
<span id="cb68-81"><a href="initial-parameters-for-em-algorithm.html#cb68-81" tabindex="-1"></a>          <span class="at">FEASTOL =</span> ecos_thresh, <span class="at">RELTOL =</span> ecos_thresh, <span class="at">ABSTOL =</span> ecos_thresh)</span>
<span id="cb68-82"><a href="initial-parameters-for-em-algorithm.html#cb68-82" tabindex="-1"></a>  }, <span class="at">error=</span><span class="cf">function</span>(err){</span>
<span id="cb68-83"><a href="initial-parameters-for-em-algorithm.html#cb68-83" tabindex="-1"></a>    err<span class="sc">$</span>message <span class="ot">=</span> <span class="fu">paste</span>(err<span class="sc">$</span>message, </span>
<span id="cb68-84"><a href="initial-parameters-for-em-algorithm.html#cb68-84" tabindex="-1"></a>                        <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="st">"Lasso solver using ECOS has failed."</span> ,<span class="at">sep=</span><span class="st">""</span>)</span>
<span id="cb68-85"><a href="initial-parameters-for-em-algorithm.html#cb68-85" tabindex="-1"></a>    <span class="fu">cat</span>(err<span class="sc">$</span>message, <span class="at">fill=</span><span class="cn">TRUE</span>)</span>
<span id="cb68-86"><a href="initial-parameters-for-em-algorithm.html#cb68-86" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb68-87"><a href="initial-parameters-for-em-algorithm.html#cb68-87" tabindex="-1"></a>  })</span>
<span id="cb68-88"><a href="initial-parameters-for-em-algorithm.html#cb68-88" tabindex="-1"></a>  </span>
<span id="cb68-89"><a href="initial-parameters-for-em-algorithm.html#cb68-89" tabindex="-1"></a>  <span class="do">## If anything is wrong, flag to use SCS solver</span></span>
<span id="cb68-90"><a href="initial-parameters-for-em-algorithm.html#cb68-90" tabindex="-1"></a>  scs <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb68-91"><a href="initial-parameters-for-em-algorithm.html#cb68-91" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(result)){</span>
<span id="cb68-92"><a href="initial-parameters-for-em-algorithm.html#cb68-92" tabindex="-1"></a>    scs <span class="ot">=</span> <span class="cn">TRUE</span></span>
<span id="cb68-93"><a href="initial-parameters-for-em-algorithm.html#cb68-93" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb68-94"><a href="initial-parameters-for-em-algorithm.html#cb68-94" tabindex="-1"></a>    <span class="cf">if</span>(result<span class="sc">$</span>status <span class="sc">!=</span> <span class="st">"optimal"</span>) scs <span class="ot">=</span> <span class="cn">TRUE</span></span>
<span id="cb68-95"><a href="initial-parameters-for-em-algorithm.html#cb68-95" tabindex="-1"></a>  }</span>
<span id="cb68-96"><a href="initial-parameters-for-em-algorithm.html#cb68-96" tabindex="-1"></a>  </span>
<span id="cb68-97"><a href="initial-parameters-for-em-algorithm.html#cb68-97" tabindex="-1"></a>  <span class="do">## Use the SCS solver</span></span>
<span id="cb68-98"><a href="initial-parameters-for-em-algorithm.html#cb68-98" tabindex="-1"></a>  <span class="cf">if</span>(scs){</span>
<span id="cb68-99"><a href="initial-parameters-for-em-algorithm.html#cb68-99" tabindex="-1"></a>    result <span class="ot">=</span> CVXR<span class="sc">::</span><span class="fu">solve</span>(prob, <span class="at">solver=</span><span class="st">"SCS"</span>, <span class="at">eps =</span> scs_eps)</span>
<span id="cb68-100"><a href="initial-parameters-for-em-algorithm.html#cb68-100" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">is.na</span>(result<span class="sc">$</span><span class="fu">getValue</span>(mumat)))){ <span class="do">## A clumsy way to check.</span></span>
<span id="cb68-101"><a href="initial-parameters-for-em-algorithm.html#cb68-101" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">"Lasso solver using both ECOS and SCS has failed."</span>, <span class="at">sep=</span><span class="st">""</span>)</span>
<span id="cb68-102"><a href="initial-parameters-for-em-algorithm.html#cb68-102" tabindex="-1"></a>    }</span>
<span id="cb68-103"><a href="initial-parameters-for-em-algorithm.html#cb68-103" tabindex="-1"></a>  }</span>
<span id="cb68-104"><a href="initial-parameters-for-em-algorithm.html#cb68-104" tabindex="-1"></a>  </span>
<span id="cb68-105"><a href="initial-parameters-for-em-algorithm.html#cb68-105" tabindex="-1"></a>  <span class="do">## Record Interesting Parameters</span></span>
<span id="cb68-106"><a href="initial-parameters-for-em-algorithm.html#cb68-106" tabindex="-1"></a>  num_iters <span class="ot">&lt;-</span> result<span class="sc">$</span>num_iters</span>
<span id="cb68-107"><a href="initial-parameters-for-em-algorithm.html#cb68-107" tabindex="-1"></a>  status <span class="ot">&lt;-</span> result<span class="sc">$</span>status</span>
<span id="cb68-108"><a href="initial-parameters-for-em-algorithm.html#cb68-108" tabindex="-1"></a>  mumat <span class="ot">&lt;-</span> result<span class="sc">$</span><span class="fu">getValue</span>(mumat)</span>
<span id="cb68-109"><a href="initial-parameters-for-em-algorithm.html#cb68-109" tabindex="-1"></a>  val <span class="ot">&lt;-</span> result<span class="sc">$</span>value</span>
<span id="cb68-110"><a href="initial-parameters-for-em-algorithm.html#cb68-110" tabindex="-1"></a>  </span>
<span id="cb68-111"><a href="initial-parameters-for-em-algorithm.html#cb68-111" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">mu =</span> mumat, <span class="at">value =</span> val, <span class="at">status =</span> status, <span class="at">num_iters =</span> num_iters))</span>
<span id="cb68-112"><a href="initial-parameters-for-em-algorithm.html#cb68-112" tabindex="-1"></a>}</span></code></pre></div>
<p>This function solves the following problem:</p>
<p><span class="math display">\[
\begin{align*}
&amp;\text{minimize}_{\mu}
{\frac{1}{2N}
    \sum_{t=1}^T \sum_{i=1}^{n_t} \hat{\gamma}_{it} (y_i^{(t)} - \mu_{\cdot t})^\top \hat{\Sigma}^{-1} ( y_i^{(t)} - \mu_{\cdot t})
  + \lambda \sum_{j=1}^d \|D^{(l)}\mu_{j\cdot }\|_1}\\
&amp;\text{subject to}\;\; {\| \mu_{\cdot t} - \bar{\mu}_{\cdot \cdot}\|_2 \le r \;\;\forall t=1,\cdots, T, }
\end{align*}
\]</span></p>
<p>and is directly equivalent to <code><a href="initial-parameters-for-em-algorithm.html#Mstep_mu">Mstep_mu</a>()</code>. The resulting solution and the
objective value should be the same. Let’s check that.</p>
<p>First, set up some objects to run <code><a href="initial-parameters-for-em-algorithm.html#Mstep_mu">Mstep_mu</a>()</code> and <code><a href="initial-parameters-for-em-algorithm.html#Mstep_mu_cvxr">Mstep_mu_cvxr</a>()</code>.</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="initial-parameters-for-em-algorithm.html#cb69-1" tabindex="-1"></a>numclust <span class="ot">=</span> <span class="dv">3</span></span>
<span id="cb69-2"><a href="initial-parameters-for-em-algorithm.html#cb69-2" tabindex="-1"></a>TT <span class="ot">=</span> <span class="dv">100</span></span>
<span id="cb69-3"><a href="initial-parameters-for-em-algorithm.html#cb69-3" tabindex="-1"></a>dimdat <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb69-4"><a href="initial-parameters-for-em-algorithm.html#cb69-4" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">0</span>)</span>
<span id="cb69-5"><a href="initial-parameters-for-em-algorithm.html#cb69-5" tabindex="-1"></a>dt <span class="ot">=</span> <a href="package-setup.html#gendat_1d">gendat_1d</a>(<span class="at">TT =</span> TT, <span class="at">ntlist =</span> <span class="fu">rep</span>(TT, <span class="dv">100</span>))</span>
<span id="cb69-6"><a href="initial-parameters-for-em-algorithm.html#cb69-6" tabindex="-1"></a>ylist <span class="ot">=</span> dt <span class="sc">%&gt;%</span> <a href="package-setup.html#dt2ylist">dt2ylist</a>()</span>
<span id="cb69-7"><a href="initial-parameters-for-em-algorithm.html#cb69-7" tabindex="-1"></a>sigma <span class="ot">=</span> <a href="initial-parameters-for-em-algorithm.html#init_sigma">init_sigma</a>(ylist, numclust) <span class="do">## (T x numclust x (dimdat x dimdat))</span></span>
<span id="cb69-8"><a href="initial-parameters-for-em-algorithm.html#cb69-8" tabindex="-1"></a>mn <span class="ot">=</span> <a href="initial-parameters-for-em-algorithm.html#init_mn">init_mn</a>(ylist, numclust, TT, dimdat)<span class="do">##, countslist = countslist) </span></span>
<span id="cb69-9"><a href="initial-parameters-for-em-algorithm.html#cb69-9" tabindex="-1"></a>prob <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">/</span>numclust, <span class="at">nrow =</span> TT, <span class="at">ncol =</span> numclust) <span class="do">## Initialize to all 1/K.</span></span>
<span id="cb69-10"><a href="initial-parameters-for-em-algorithm.html#cb69-10" tabindex="-1"></a>resp <span class="ot">=</span> <a href="initial-parameters-for-em-algorithm.html#Estep">Estep</a>(mn, sigma, prob, <span class="at">ylist =</span> ylist, numclust)</span>
<span id="cb69-11"><a href="initial-parameters-for-em-algorithm.html#cb69-11" tabindex="-1"></a>lambda <span class="ot">=</span> .<span class="dv">01</span></span>
<span id="cb69-12"><a href="initial-parameters-for-em-algorithm.html#cb69-12" tabindex="-1"></a>l <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb69-13"><a href="initial-parameters-for-em-algorithm.html#cb69-13" tabindex="-1"></a>x <span class="ot">=</span> <span class="dv">1</span><span class="sc">:</span>TT</span>
<span id="cb69-14"><a href="initial-parameters-for-em-algorithm.html#cb69-14" tabindex="-1"></a>Dlp1 <span class="ot">=</span> <a href="package-setup.html#gen_diff_mat">gen_diff_mat</a>(<span class="at">n =</span> TT, <span class="at">l =</span> l<span class="sc">+</span><span class="dv">1</span>, <span class="at">x =</span> x)</span>
<span id="cb69-15"><a href="initial-parameters-for-em-algorithm.html#cb69-15" tabindex="-1"></a>Dl <span class="ot">=</span> <a href="package-setup.html#gen_diff_mat">gen_diff_mat</a>(<span class="at">n =</span> TT, <span class="at">l =</span> l, <span class="at">x =</span> x)</span>
<span id="cb69-16"><a href="initial-parameters-for-em-algorithm.html#cb69-16" tabindex="-1"></a>Dlsqrd <span class="ot">&lt;-</span> <span class="fu">t</span>(Dl) <span class="sc">%*%</span> Dl</span>
<span id="cb69-17"><a href="initial-parameters-for-em-algorithm.html#cb69-17" tabindex="-1"></a>maxdev <span class="ot">=</span> <span class="cn">NULL</span></span></code></pre></div>
<p>Then, compare the result of the two implementations. They should look identical.</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="initial-parameters-for-em-algorithm.html#cb70-1" tabindex="-1"></a><span class="do">## overall ADMM</span></span>
<span id="cb70-2"><a href="initial-parameters-for-em-algorithm.html#cb70-2" tabindex="-1"></a>res1 <span class="ot">=</span> <a href="initial-parameters-for-em-algorithm.html#Mstep_mu">Mstep_mu</a>(resp, ylist, lambda, <span class="at">l=</span>l, <span class="at">sigma=</span>sigma, <span class="at">Dlsqrd =</span> Dlsqrd, <span class="at">Dl=</span>Dl, <span class="at">Dlp1=</span>Dlp1, <span class="at">TT=</span>TT, <span class="at">N=</span>N, <span class="at">dimdat=</span>dimdat, <span class="at">e_mat=</span><a href="initial-parameters-for-em-algorithm.html#etilde_mat">etilde_mat</a>(<span class="at">TT =</span> TT),</span>
<span id="cb70-3"><a href="initial-parameters-for-em-algorithm.html#cb70-3" tabindex="-1"></a>                <span class="at">maxdev =</span> maxdev)</span>
<span id="cb70-4"><a href="initial-parameters-for-em-algorithm.html#cb70-4" tabindex="-1"></a>mn1 <span class="ot">=</span> res1<span class="sc">$</span>mns</span>
<span id="cb70-5"><a href="initial-parameters-for-em-algorithm.html#cb70-5" tabindex="-1"></a></span>
<span id="cb70-6"><a href="initial-parameters-for-em-algorithm.html#cb70-6" tabindex="-1"></a><span class="do">## CVXR just ONE cluster</span></span>
<span id="cb70-7"><a href="initial-parameters-for-em-algorithm.html#cb70-7" tabindex="-1"></a>res2list <span class="ot">=</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>numclust, <span class="cf">function</span>(iclust){</span>
<span id="cb70-8"><a href="initial-parameters-for-em-algorithm.html#cb70-8" tabindex="-1"></a>  Sigma_inv_oneclust <span class="ot">=</span> <span class="fu">solve</span>(sigma[iclust,,])</span>
<span id="cb70-9"><a href="initial-parameters-for-em-algorithm.html#cb70-9" tabindex="-1"></a>  resp_oneclist <span class="ot">=</span> <span class="fu">lapply</span>(resp, <span class="cf">function</span>(resp_onetime){resp_onetime[,iclust, drop<span class="ot">=</span><span class="cn">FALSE</span>]})</span>
<span id="cb70-10"><a href="initial-parameters-for-em-algorithm.html#cb70-10" tabindex="-1"></a>  N <span class="ot">=</span> <span class="fu">sum</span>(<span class="fu">unlist</span>(resp))</span>
<span id="cb70-11"><a href="initial-parameters-for-em-algorithm.html#cb70-11" tabindex="-1"></a>  res2 <span class="ot">=</span> <a href="initial-parameters-for-em-algorithm.html#Mstep_mu_cvxr">Mstep_mu_cvxr</a>(ylist, resp_oneclist,</span>
<span id="cb70-12"><a href="initial-parameters-for-em-algorithm.html#cb70-12" tabindex="-1"></a>                       lambda, l,  Sigma_inv_oneclust,</span>
<span id="cb70-13"><a href="initial-parameters-for-em-algorithm.html#cb70-13" tabindex="-1"></a>                       <span class="at">thresh =</span> <span class="fl">1E-8</span>, <span class="at">maxdev =</span> maxdev, dimdat, N) </span>
<span id="cb70-14"><a href="initial-parameters-for-em-algorithm.html#cb70-14" tabindex="-1"></a>  res2<span class="sc">$</span>mu</span>
<span id="cb70-15"><a href="initial-parameters-for-em-algorithm.html#cb70-15" tabindex="-1"></a>})</span>
<span id="cb70-16"><a href="initial-parameters-for-em-algorithm.html#cb70-16" tabindex="-1"></a>mn2 <span class="ot">=</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim=</span><span class="fu">c</span>(<span class="dv">100</span>, dimdat, <span class="dv">3</span>))</span>
<span id="cb70-17"><a href="initial-parameters-for-em-algorithm.html#cb70-17" tabindex="-1"></a><span class="cf">for</span>(iclust <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>numclust){</span>
<span id="cb70-18"><a href="initial-parameters-for-em-algorithm.html#cb70-18" tabindex="-1"></a>  mn2[,,iclust] <span class="ot">=</span> res2list[[iclust]] <span class="sc">%&gt;%</span>  <span class="fu">as.matrix</span>()</span>
<span id="cb70-19"><a href="initial-parameters-for-em-algorithm.html#cb70-19" tabindex="-1"></a>}</span>
<span id="cb70-20"><a href="initial-parameters-for-em-algorithm.html#cb70-20" tabindex="-1"></a></span>
<span id="cb70-21"><a href="initial-parameters-for-em-algorithm.html#cb70-21" tabindex="-1"></a>  </span>
<span id="cb70-22"><a href="initial-parameters-for-em-algorithm.html#cb70-22" tabindex="-1"></a><span class="do">## Plot them</span></span>
<span id="cb70-23"><a href="initial-parameters-for-em-algorithm.html#cb70-23" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x =</span> dt<span class="sc">$</span>time, <span class="at">y=</span>dt<span class="sc">$</span>Y, <span class="at">col =</span> <span class="fu">rgb</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="fl">0.04</span>),</span>
<span id="cb70-24"><a href="initial-parameters-for-em-algorithm.html#cb70-24" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">'admm (solid) vs cvxr (dashed)'</span>,</span>
<span id="cb70-25"><a href="initial-parameters-for-em-algorithm.html#cb70-25" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="st">""</span>, <span class="at">xlab =</span> <span class="st">"time"</span>)</span>
<span id="cb70-26"><a href="initial-parameters-for-em-algorithm.html#cb70-26" tabindex="-1"></a>mn1[,<span class="dv">1</span>,] <span class="sc">%&gt;%</span> <span class="fu">matlines</span>(<span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">lty =</span> <span class="dv">1</span>)</span>
<span id="cb70-27"><a href="initial-parameters-for-em-algorithm.html#cb70-27" tabindex="-1"></a>mn2[,<span class="dv">1</span>,] <span class="sc">%&gt;%</span> <span class="fu">matlines</span>(<span class="at">lwd =</span> <span class="dv">3</span>, <span class="at">lty =</span> <span class="dv">3</span>)</span></code></pre></div>
<p>Next, do this for uneven inputs.</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="initial-parameters-for-em-algorithm.html#cb71-1" tabindex="-1"></a><span class="do">## Setup</span></span>
<span id="cb71-2"><a href="initial-parameters-for-em-algorithm.html#cb71-2" tabindex="-1"></a>numclust <span class="ot">=</span> <span class="dv">3</span></span>
<span id="cb71-3"><a href="initial-parameters-for-em-algorithm.html#cb71-3" tabindex="-1"></a>TT <span class="ot">=</span> <span class="dv">100</span></span>
<span id="cb71-4"><a href="initial-parameters-for-em-algorithm.html#cb71-4" tabindex="-1"></a>dimdat <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb71-5"><a href="initial-parameters-for-em-algorithm.html#cb71-5" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">0</span>)</span>
<span id="cb71-6"><a href="initial-parameters-for-em-algorithm.html#cb71-6" tabindex="-1"></a>dt <span class="ot">=</span> <a href="package-setup.html#gendat_1d">gendat_1d</a>(<span class="at">TT =</span> TT, <span class="at">ntlist =</span> <span class="fu">rep</span>(TT, <span class="dv">100</span>))</span>
<span id="cb71-7"><a href="initial-parameters-for-em-algorithm.html#cb71-7" tabindex="-1"></a>ylist <span class="ot">=</span> dt <span class="sc">%&gt;%</span> <a href="package-setup.html#dt2ylist">dt2ylist</a>()</span>
<span id="cb71-8"><a href="initial-parameters-for-em-algorithm.html#cb71-8" tabindex="-1"></a></span>
<span id="cb71-9"><a href="initial-parameters-for-em-algorithm.html#cb71-9" tabindex="-1"></a><span class="do">## Subset them</span></span>
<span id="cb71-10"><a href="initial-parameters-for-em-algorithm.html#cb71-10" tabindex="-1"></a>ylist <span class="ot">=</span> ylist[<span class="sc">-</span><span class="fu">seq</span>(<span class="at">from=</span><span class="dv">10</span>,<span class="at">to=</span><span class="dv">100</span>,<span class="at">by=</span><span class="dv">10</span>)]</span>
<span id="cb71-11"><a href="initial-parameters-for-em-algorithm.html#cb71-11" tabindex="-1"></a>x <span class="ot">=</span> (<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>)[<span class="sc">-</span><span class="fu">seq</span>(<span class="at">from=</span><span class="dv">10</span>,<span class="at">to=</span><span class="dv">100</span>,<span class="at">by=</span><span class="dv">10</span>)]</span>
<span id="cb71-12"><a href="initial-parameters-for-em-algorithm.html#cb71-12" tabindex="-1"></a></span>
<span id="cb71-13"><a href="initial-parameters-for-em-algorithm.html#cb71-13" tabindex="-1"></a>sigma <span class="ot">=</span> <a href="initial-parameters-for-em-algorithm.html#init_sigma">init_sigma</a>(ylist, numclust) <span class="do">## (T x numclust x (dimdat x dimdat))</span></span>
<span id="cb71-14"><a href="initial-parameters-for-em-algorithm.html#cb71-14" tabindex="-1"></a>mn <span class="ot">=</span> <a href="initial-parameters-for-em-algorithm.html#init_mn">init_mn</a>(ylist, numclust, TT, dimdat)<span class="do">##, countslist = countslist)</span></span>
<span id="cb71-15"><a href="initial-parameters-for-em-algorithm.html#cb71-15" tabindex="-1"></a>prob <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">/</span>numclust, <span class="at">nrow =</span> TT, <span class="at">ncol =</span> numclust) <span class="do">## Initialize to all 1/K.</span></span>
<span id="cb71-16"><a href="initial-parameters-for-em-algorithm.html#cb71-16" tabindex="-1"></a>resp <span class="ot">=</span> <a href="initial-parameters-for-em-algorithm.html#Estep">Estep</a>(mn, sigma, prob, <span class="at">ylist =</span> ylist, numclust)</span>
<span id="cb71-17"><a href="initial-parameters-for-em-algorithm.html#cb71-17" tabindex="-1"></a>lambda <span class="ot">=</span> .<span class="dv">1</span></span>
<span id="cb71-18"><a href="initial-parameters-for-em-algorithm.html#cb71-18" tabindex="-1"></a>l <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb71-19"><a href="initial-parameters-for-em-algorithm.html#cb71-19" tabindex="-1"></a><span class="do">##x = 1:TT</span></span>
<span id="cb71-20"><a href="initial-parameters-for-em-algorithm.html#cb71-20" tabindex="-1"></a>Dlp1 <span class="ot">=</span> <a href="package-setup.html#gen_diff_mat">gen_diff_mat</a>(<span class="at">n =</span> <span class="fu">length</span>(x), <span class="at">l =</span> l<span class="sc">+</span><span class="dv">1</span>, <span class="at">x =</span> x)</span>
<span id="cb71-21"><a href="initial-parameters-for-em-algorithm.html#cb71-21" tabindex="-1"></a>Dl <span class="ot">=</span> <a href="package-setup.html#gen_diff_mat">gen_diff_mat</a>(<span class="at">n =</span> <span class="fu">length</span>(x), <span class="at">l =</span> l, <span class="at">x =</span> x)</span>
<span id="cb71-22"><a href="initial-parameters-for-em-algorithm.html#cb71-22" tabindex="-1"></a>Dlsqrd <span class="ot">&lt;-</span> <span class="fu">t</span>(Dl) <span class="sc">%*%</span> Dl</span>
<span id="cb71-23"><a href="initial-parameters-for-em-algorithm.html#cb71-23" tabindex="-1"></a>maxdev <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb71-24"><a href="initial-parameters-for-em-algorithm.html#cb71-24" tabindex="-1"></a></span>
<span id="cb71-25"><a href="initial-parameters-for-em-algorithm.html#cb71-25" tabindex="-1"></a></span>
<span id="cb71-26"><a href="initial-parameters-for-em-algorithm.html#cb71-26" tabindex="-1"></a><span class="do">## Try the algorithm itelf.</span></span>
<span id="cb71-27"><a href="initial-parameters-for-em-algorithm.html#cb71-27" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb71-28"><a href="initial-parameters-for-em-algorithm.html#cb71-28" tabindex="-1"></a>obj <span class="ot">=</span> <a href="the-main-flowtrend-function.html#flowtrend_once">flowtrend_once</a>(<span class="at">ylist =</span> ylist, <span class="at">x =</span> x, <span class="at">lambda =</span> .<span class="dv">1</span>, <span class="at">lambda_prob =</span> .<span class="dv">1</span>,</span>
<span id="cb71-29"><a href="initial-parameters-for-em-algorithm.html#cb71-29" tabindex="-1"></a>                     <span class="at">l =</span> <span class="dv">2</span>, <span class="at">l_prob =</span> <span class="dv">2</span>, <span class="at">maxdev =</span> <span class="dv">5</span>, <span class="at">numclust =</span> <span class="dv">3</span>,</span>
<span id="cb71-30"><a href="initial-parameters-for-em-algorithm.html#cb71-30" tabindex="-1"></a>                     <span class="at">rho_init =</span> <span class="fl">0.01</span>, <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb71-31"><a href="initial-parameters-for-em-algorithm.html#cb71-31" tabindex="-1"></a><a href="package-setup.html#plot_1d">plot_1d</a>(<span class="at">ylist=</span>ylist, <span class="at">obj=</span>obj)</span>
<span id="cb71-32"><a href="initial-parameters-for-em-algorithm.html#cb71-32" tabindex="-1"></a><span class="fu">plot</span>(obj<span class="sc">$</span>objectives, <span class="at">type =</span><span class="st">'l'</span>)</span>
<span id="cb71-33"><a href="initial-parameters-for-em-algorithm.html#cb71-33" tabindex="-1"></a>mn1 <span class="ot">=</span> obj<span class="sc">$</span>mn</span>
<span id="cb71-34"><a href="initial-parameters-for-em-algorithm.html#cb71-34" tabindex="-1"></a>obj<span class="sc">$</span>mn[,<span class="dv">1</span>,] <span class="sc">%&gt;%</span> <span class="fu">diff</span>() <span class="sc">%&gt;%</span> <span class="fu">diff</span>() <span class="sc">%&gt;%</span> <span class="fu">diff</span>() <span class="sc">%&gt;%</span> <span class="fu">matplot</span>(<span class="at">type=</span><span class="st">'l'</span>)</span>
<span id="cb71-35"><a href="initial-parameters-for-em-algorithm.html#cb71-35" tabindex="-1"></a>mn[,<span class="dv">1</span>,] <span class="sc">%&gt;%</span> <span class="fu">diff</span>() <span class="sc">%&gt;%</span> <span class="fu">diff</span>() <span class="sc">%&gt;%</span> <span class="fu">diff</span>() <span class="sc">%&gt;%</span> <span class="fu">matplot</span>(<span class="at">type=</span><span class="st">'l'</span>)</span>
<span id="cb71-36"><a href="initial-parameters-for-em-algorithm.html#cb71-36" tabindex="-1"></a>mn[,<span class="dv">1</span>,] <span class="sc">%&gt;%</span> <span class="fu">matplot</span>(<span class="at">type=</span><span class="st">'l'</span>)</span>
<span id="cb71-37"><a href="initial-parameters-for-em-algorithm.html#cb71-37" tabindex="-1"></a><span class="do">## Okay, so cluster 3 has a very irregular mean.</span></span>
<span id="cb71-38"><a href="initial-parameters-for-em-algorithm.html#cb71-38" tabindex="-1"></a></span>
<span id="cb71-39"><a href="initial-parameters-for-em-algorithm.html#cb71-39" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x =</span> dt<span class="sc">$</span>time, <span class="at">y=</span>dt<span class="sc">$</span>Y, <span class="at">col =</span> <span class="fu">rgb</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="fl">0.04</span>),</span>
<span id="cb71-40"><a href="initial-parameters-for-em-algorithm.html#cb71-40" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">'admm (solid) vs cvxr (dashed)'</span>,</span>
<span id="cb71-41"><a href="initial-parameters-for-em-algorithm.html#cb71-41" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="st">""</span>, <span class="at">xlab =</span> <span class="st">"time"</span>)</span>
<span id="cb71-42"><a href="initial-parameters-for-em-algorithm.html#cb71-42" tabindex="-1"></a>mn_old[,<span class="dv">1</span>,] <span class="sc">%&gt;%</span> <span class="fu">matlines</span>(<span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">x=</span>x, <span class="at">lty =</span> <span class="dv">1</span>)</span>
<span id="cb71-43"><a href="initial-parameters-for-em-algorithm.html#cb71-43" tabindex="-1"></a>mn_less_old[,<span class="dv">1</span>,] <span class="sc">%&gt;%</span> <span class="fu">matlines</span>(<span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">x=</span>x, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb71-44"><a href="initial-parameters-for-em-algorithm.html#cb71-44" tabindex="-1"></a>mn[,<span class="dv">1</span>,] <span class="sc">%&gt;%</span> <span class="fu">matlines</span>(<span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">x=</span>x, <span class="at">lty =</span> <span class="dv">3</span>)</span>
<span id="cb71-45"><a href="initial-parameters-for-em-algorithm.html#cb71-45" tabindex="-1"></a> </span></code></pre></div>
<p>TODO: We just need to bundle this into <code>testthat</code> style tests, and make sure to test several lambda values.</p>
<p>TODO: maybe do this for unevenly spaced inputs. CVXR needs to take a different D matrix.</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="initial-parameters-for-em-algorithm.html#cb72-1" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">"Test the M step of \mu against CVXR"</span>, {})</span></code></pre></div>
</div>
</div>
</div>
            </section>
</div>
        </div>
      </div>
<a href="objective-data-log-likelihood.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="the-main-flowtrend-function.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script><script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script><script src="libs/gitbook-2.6.7/js/plugin-search.js"></script><script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script><script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script><script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script><script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script><script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script><script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>
</html>
